<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>جرد المخزون</title>

<style>
:root{
  --bg:#f4f5f7;
  --card:#fff;
  --primary:#1976d2;
  --ok:#1b5e20;
  --warn:#c62828;
  --muted:#777;
  --border:#e0e0e0;
}

body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:var(--bg);
}

.top-bar{
  max-width:430px;
  margin:10px auto;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.container{
  max-width:430px;
  margin:auto;
  padding:6px;
}

.search{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  margin-bottom:8px;
}

.item{
  background:var(--card);
  border-radius:14px;
  padding:12px;
  margin-bottom:8px;
  box-shadow:0 3px 8px rgba(0,0,0,.06);
}

.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.part{
  font-weight:700;
  color:var(--primary);
}

.location{
  font-size:12px;
  color:#555;
}

.name{
  margin:4px 0;
}

.qty{
  margin-top:6px;
  font-weight:600;
}

.status{
  font-size:12px;
  margin-top:4px;
}

.note-box{
  margin-top:8px;
}

.note-box textarea{
  width:100%;
  border-radius:8px;
  border:1px solid var(--border);
  padding:6px;
  font-size:13px;
  resize:none;
}

.note-hint{
  font-size:11px;
  color:var(--muted);
  margin-top:2px;
}
</style>
</head>

<body>

<div class="top-bar">
  <strong>جرد المخزون</strong>
  <button onclick="loadData()">تحديث</button>
</div>

<div class="container">
  <input id="search" class="search" placeholder="بحث برقم الصنف أو الاسم">
  <div id="results"></div>
</div>

<script>
const API = "ضع_رابط_الاب_سكريبت_هنا";
let ALL_DATA = [];

/* تحميل البيانات */
function loadData(){
  fetch(API)
    .then(r=>r.json())
    .then(d=>{
      ALL_DATA = d;
      render(d);
    });
}

/* البحث */
search.addEventListener("input",()=>{
  const q = search.value.trim().toLowerCase();
  const f = ALL_DATA.filter(r =>
    String(r.part).includes(q) ||
    String(r.name).toLowerCase().includes(q)
  );
  render(f);
});

/* الرسم */
function render(data){
  if(!data.length){
    results.innerHTML = "<div style='text-align:center;color:#777'>لا نتائج</div>";
    return;
  }

  results.innerHTML = data.map(r=>{
    const counted = r.lastCountedAt;
    const changed = counted && Number(r.qty) !== Number(r.lastCountQty);

    let status = "";
    let color = "";

    if(counted && !changed){
      status = "✓ تم الجرد";
      color = "var(--ok)";
    }

    if(counted && changed){
      status = `⚠ تم الجرد (كان ${r.lastCountQty} ← الآن ${r.qty})`;
      color = "var(--warn)";
    }

    return `
    <div class="item">
      <div class="row">
        <div class="part">${r.part}</div>
        <div class="location">${r.location || ""}</div>
      </div>

      <div class="name">${r.name}</div>

      <div class="qty">الكمية المتوفرة: ${r.qty}</div>

      ${status ? `<div class="status" style="color:${color}">${status}</div>` : ""}

      <div class="note-box">
        <textarea
          rows="2"
          placeholder="ملاحظة الجارد (اختياري)"
          onblur="saveNote('${r.part}', this.value)"
        >${r.note || ""}</textarea>
        <div class="note-hint">تُحفظ تلقائيًا وتظهر للجميع</div>
      </div>
    </div>
    `;
  }).join("");
}

/* حفظ الملاحظة */
function saveNote(part, note){
  fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body:new URLSearchParams({
      action:"saveNote",
      part:part,
      note:note
    })
  });
}

/* تشغيل أولي */
loadData();
</script>

</body>
</html>
