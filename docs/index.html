<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</title>

<style>
:root{
  --bg:#f4f5f7;
  --card:#ffffff;
  --primary:#1976d2;
  --green:#1b5e20;
  --text:#222;
  --muted:#777;
  --border:#e0e0e0;
}

body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background:var(--bg);
  margin:0;
  padding:8px;
}

.top-bar{
  max-width:430px;
  margin:0 auto 6px auto;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.top-title{
  font-size:15px;
  font-weight:600;
  color:var(--text);
}
.top-actions{
  display:flex;
  gap:6px;
}
.icon-btn{
  width:30px;
  height:30px;
  border:none;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  background:var(--card);
  box-shadow:0 1px 4px rgba(0,0,0,.12);
  color:var(--text);
  cursor:pointer;
}

.filter-wrap{
  max-width:430px;
  margin:0 auto 8px auto;
}
.filter-card{
  background:var(--card);
  border-radius:12px;
  padding:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
}
.filter-row{
  display:flex;
  gap:4px;
  margin-bottom:4px;
}
.filter-input{
  flex:1;
  padding:6px 7px;
  font-size:12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fafafa;
}

.loader-wrap{
  max-width:430px;
  margin:0 auto 6px auto;
}
.loader-bar{
  height:4px;
  width:100%;
  background:#e0e0e0;
  border-radius:4px;
  overflow:hidden;
}
.loader-fill{
  height:100%;
  width:0%;
  background:var(--primary);
  transition:width .2s linear;
}
.loader-text{
  font-size:11px;
  color:var(--muted);
  margin-top:2px;
  text-align:center;
}

#results{
  max-width:430px;
  margin:0 auto 8px auto;
  padding-bottom:8px;
}
.item{
  background:var(--card);
  border-radius:12px;
  padding:9px;
  margin-bottom:7px;
  box-shadow:0 3px 8px rgba(0,0,0,.05);
  cursor:pointer;
}
.part-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.part{
  font-weight:700;
  font-size:14px;
  color:var(--primary);
}
.part-counted{
  color:var(--green);
}
.edit-btn{
  width:26px;
  height:26px;
  border:none;
  border-radius:7px;
  background:#f1f3f4;
  font-size:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:var(--text);
  cursor:pointer;
}
.name{
  font-size:13px;
  margin-top:2px;
  color:var(--text);
}
.meta-line{
  display:flex;
  justify-content:space-between;
  margin-top:4px;
  font-size:12px;
  color:var(--muted);
}
.meta-right{ text-align:right; }
.meta-left{ text-align:left; }
.meta-second{
  margin-top:2px;
  font-size:12px;
  color:var(--muted);
}

.msg{
  text-align:center;
  padding:10px;
  color:var(--muted);
  font-size:13px;
}

.detail-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  z-index:999;
}
.detail-card{
  width:100%;
  max-width:430px;
  background:var(--card);
  border-radius:16px 16px 0 0;
  padding:12px;
  box-shadow:0 -3px 12px rgba(0,0,0,.3);
}
.detail-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
  font-weight:600;
}
.detail-close{
  border:none;
  background:none;
  font-size:18px;
  cursor:pointer;
}
.detail-body{
  max-height:60vh;
  overflow-y:auto;
}
.detail-label{
  font-size:12px;
  color:var(--muted);
  margin-top:6px;
}
.detail-value{
  font-size:14px;
  color:var(--text);
  margin-top:2px;
}
.detail-qty-box{
  display:flex;
  gap:8px;
  margin-top:4px;
}
.detail-qty-box button{
  width:40px;
  font-size:20px;
  border:none;
  border-radius:10px;
  background:#f1f3f4;
  cursor:pointer;
}
.detail-qty-box input{
  flex:1;
  text-align:center;
  font-size:16px;
  padding:7px;
  border-radius:9px;
  border:1px solid var(--border);
}
.detail-save{
  margin-top:10px;
  width:100%;
  padding:10px;
  border:none;
  border-radius:10px;
  background:var(--primary);
  color:#fff;
  font-size:15px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="top-bar">
  <div class="top-title">Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù…Ø±ÙƒØ²ÙŠ</div>
  <div class="top-actions">
    <button id="btnRefresh" class="icon-btn" title="ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ø´ÙŠØª" onclick="handleRefreshClick()">âŸ³</button>
    <button class="icon-btn" title="Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«" onclick="clearAll()">âœ•</button>
  </div>
</div>

<div class="loader-wrap" id="loaderWrap" style="display:none;">
  <div class="loader-bar">
    <div class="loader-fill" id="loaderFill"></div>
  </div>
  <div class="loader-text" id="loaderText">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
</div>

<div class="filter-wrap">
  <div class="filter-card">
    <div class="filter-row">
      <input class="filter-input" id="pContains" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰">
      <input class="filter-input" id="pEnds"     placeholder="ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€">
    </div>
    <div class="filter-row">
      <input class="filter-input" id="nStarts"   placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙŠØ¨Ø¯Ø£ Ø¨Ù€">
      <input class="filter-input" id="nContains" placeholder="ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰">
    </div>
    <div class="filter-row">
      <input class="filter-input" id="locFrom"   placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù†">
      <input class="filter-input" id="locTo"     placeholder="Ø¥Ù„Ù‰">
    </div>
  </div>
</div>

<div id="results"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";
const CACHE_KEY = "inventory_cache_v3";
const MAX_RESULTS = 100;
const IS_ADMIN = true;

let ALL_DATA = [];
let isRefreshing = false;

(function setupAdminUI(){
  const btn = document.getElementById("btnRefresh");
  if(!IS_ADMIN){
    btn.style.display = "none";
  }
})();

function loadData(){
  console.log("ðŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");
  const cached = localStorage.getItem(CACHE_KEY);
  if(cached){
    try{
      ALL_DATA = JSON.parse(cached);
      console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙƒØ§Ø´:", ALL_DATA.length, "ØµÙ†Ù");
      runSearch();
      return;
    }catch(e){
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒØ§Ø´:", e);
      ALL_DATA = [];
    }
  }
  console.log("ðŸ“¡ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ§Ø´ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...");
  refreshData(true);
}

function handleRefreshClick(){
  if(!IS_ADMIN){
    alert("Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.");
    return;
  }
  if(isRefreshing) return;
  refreshData(false);
}

function showLoader(){
  document.getElementById("loaderWrap").style.display = "block";
  document.getElementById("loaderFill").style.width = "0%";
  document.getElementById("loaderText").textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
}
function updateLoaderProgress(p){
  document.getElementById("loaderFill").style.width = p + "%";
  document.getElementById("loaderText").textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... " + p + "%";
}
function hideLoader(){
  document.getElementById("loaderWrap").style.display = "none";
}

async function refreshData(isFirstLoad = false){
  try{
    isRefreshing = true;
    showLoader();
    updateLoaderProgress(5);

    console.log("ðŸ“¡ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù„Ù‰:", API);
    const start = Date.now();
    const resp = await fetch(API);
    updateLoaderProgress(40);

    console.log("ðŸ“¥ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø¯ØŒ Ø§Ù„Ø­Ø§Ù„Ø©:", resp.status);
    const data = await resp.json();
    updateLoaderProgress(80);

    console.log("ðŸ“¦ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:", data);

    if(Array.isArray(data)){
      ALL_DATA = data;
      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      console.log("âœ… ØªÙ… Ø­ÙØ¸", data.length, "ØµÙ†Ù ÙÙŠ Ø§Ù„ÙƒØ§Ø´");
      runSearch();
    }else if(data && data.error){
      console.error("âŒ Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:", data.error);
      alert("Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: " + data.error);
    }else{
      console.warn("âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© Ù„ÙŠØ³Øª Array:", typeof data);
    }

    const elapsed = Date.now() - start;
    updateLoaderProgress(100);
    if(!isFirstLoad){
      alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø´ÙŠØª.\nØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: " + (elapsed/1000).toFixed(1) + " Ø«Ø§Ù†ÙŠØ©");
    }
  }catch(e){
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:", e);
    if(!isFirstLoad){
      alert("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø´ÙŠØª: " + e.message);
    }
  }finally{
    isRefreshing = false;
    setTimeout(hideLoader, 400);
  }
}

document.querySelectorAll(".filter-input").forEach(i=>{
  i.addEventListener("input", debounce);
});

let timer=null;
function debounce(){
  clearTimeout(timer);
  timer=setTimeout(runSearch,700);
}
