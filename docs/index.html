<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø´Ø±ÙƒØ© Ø§Ù„Ù‚Ø§Ø¶ÙŠ </title>

<link rel="manifest" href="manifest.json">

<style>
:root{
  --bg:#f3f4f6;
  --card:#ffffff;
  --primary:#1976d2;
  --ok:#2e7d32;
  --warn:#c62828;
  --text:#1f2933;
  --muted:#6b7280;
  --border:#d1d5db;
}

/* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ */
body{
  margin:0;
  font-family:system-ui,-apple-system;
  min-height:100vh;
  background:
    radial-gradient(circle at top left, #e3f2fd 0, transparent 55%),
    radial-gradient(circle at bottom right, #e0f7fa 0, #f3f4f6 55%);
  padding:12px;
  color:var(--text);
}
*{box-sizing:border-box}

/* ===== LOGIN (ÙØ®Ù… ÙØ§ØªØ­ ÙˆÙŠØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø©) ===== */
.login-screen{
  position:fixed;
  inset:0;
  z-index:1000;
  display:flex;
  justify-content:center;
  align-items:center;
}
.login-box{
  width:100%;
  max-width:360px;
  padding:20px 18px 16px;
  border-radius:24px;
  background:rgba(255,255,255,0.9);
  box-shadow:0 18px 45px rgba(148,163,184,0.4);
  border:1px solid rgba(209,213,219,0.9);
  color:var(--text);
  backdrop-filter:blur(14px);
  text-align:center;
}
.login-logo{
  width:72px;
  height:72px;
  border-radius:20px;
  margin:0 auto 10px;
  background:linear-gradient(145deg,#4caf50,#29b6f6);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:30px;
  color:#ffffff;
}
.login-box h3{margin:4px 0 4px;font-size:18px}
.login-box p{font-size:12px;color:var(--muted);margin:0 0 8px}
.login-box input{
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#ffffff;
  color:var(--text);
  font-size:13px;
}
.login-box input::placeholder{color:#9ca3af}
.login-box button{
  width:100%;
  margin-top:14px;
  padding:11px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#1976d2,#4caf50);
  color:#fff;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 10px 25px rgba(25,118,210,0.35);
}
#loginError{margin-top:8px;font-size:12px;color:#d32f2f}
#loginLoading{display:none;margin-top:6px;font-size:11px;color:#6b7280}
#buildInfo{margin-top:10px;font-size:11px;color:#9ca3af}

/* ===== MAIN MENU (ÙØ§ØªØ­Ø©) ===== */
#mainScreen{
  display:none;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.main-card{
  width:100%;
  max-width:380px;
  background:#ffffff;
  border-radius:22px;
  padding:18px 16px 16px;
  box-shadow:0 18px 40px rgba(148,163,184,0.35);
  border:1px solid #e5e7eb;
  color:var(--text);
}
.main-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}
.main-title{
  font-size:16px;
  font-weight:700;
}
.main-sub{
  font-size:11px;
  color:var(--muted);
}
.main-badge{
  font-size:11px;
  background:#e3f2fd;
  color:#1565c0;
  padding:4px 8px;
  border-radius:999px;
}
.main-list{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.main-btn{
  width:100%;
  padding:11px 10px;
  border:none;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
  background:#f5f7fb;
  color:var(--text);
  font-size:14px;
}
.main-btn span.left{
  display:flex;
  align-items:center;
  gap:8px;
}
.main-icon{
  width:30px;
  height:30px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  background:#e3f2fd;
  color:#1976d2;
}
.main-arrow{
  font-size:13px;
  color:var(--muted);
}
.main-btn.primary{
  background:linear-gradient(135deg,#1976d2,#4caf50);
  color:#ffffff;
}
.main-btn.primary .main-icon{
  background:rgba(255,255,255,0.15);
  color:#ffffff;
}

/* ===== APP ===== */
#appScreen{display:none}
.top-bar{
  max-width:430px;
  margin:0 auto 6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:var(--text);
}
.top-title{font-weight:700;font-size:15px}
.icon-btn{
  border:none;
  border-radius:8px;
  padding:6px 10px;
  background:#ffffff;
  color:var(--text);
  box-shadow:0 1px 4px rgba(148,163,184,.5);
  cursor:pointer;
}

/* FILTER + RESULTS */
.filter-wrap,#results{
  max-width:430px;
  margin:0 auto 8px;
}
.filter-wrap{
  position:sticky;
  top:0;
  z-index:10;
}
.filter-card{
  background:#ffffff;
  border-radius:12px;
  padding:6px;
  box-shadow:0 2px 6px rgba(148,163,184,.35);
  color:var(--text);
}
.filter-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
}
.clear-btn{
  font-size:12px;
  background:#e5e7eb;
  color:var(--text);
  border:none;
  border-radius:6px;
  padding:4px 8px;
  cursor:pointer;
}
.filter-row{display:flex;gap:6px;margin-bottom:6px}
.filter-input{
  flex:1;
  min-width:0;
  padding:7px 8px;
  font-size:12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#f9fafb;
  color:var(--text);
}
.filter-input::placeholder{color:#9ca3af}
@media(max-width:480px){
  .filter-row{flex-wrap:wrap}
  .filter-input{flex:1 1 48%}
}

/* ITEM */
.item{
  background:#ffffff;
  border-radius:12px;
  padding:9px;
  margin-bottom:7px;
  box-shadow:0 3px 8px rgba(148,163,184,.35);
  color:var(--text);
}
.part-row{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.part{font-weight:700;color:#1976d2}
.part.ok{color:var(--ok)}
.part.warn{color:var(--warn)}
.location{font-size:12px;color:var(--muted)}
.name{font-size:13px;margin-top:2px}
.meta{font-size:12px;color:var(--muted);margin-top:4px}
.status{font-size:12px;margin-top:4px}

/* DETAIL */
.detail-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  z-index:9999;
}
.detail-card{
  width:100%;
  max-width:430px;
  background:#ffffff;
  border-radius:16px 16px 0 0;
  padding:12px;
  color:var(--text);
  box-shadow:0 -6px 20px rgba(148,163,184,.45);
}
.detail-header{
  display:flex;
  justify-content:space-between;
  font-weight:600;
}
.detail-close{
  border:none;
  background:none;
  font-size:18px;
  cursor:pointer;
  color:var(--muted);
}
.detail-label{font-size:12px;color:var(--muted);margin-top:10px}
.detail-qty-box{display:flex;gap:8px;margin-top:6px}
.detail-qty-box button{
  width:40px;
  border:none;
  border-radius:10px;
  font-size:20px;
  cursor:pointer;
  background:#e5e7eb;
  color:var(--text);
}
.detail-qty-box input{
  flex:1;
  text-align:center;
  font-size:16px;
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px;
  background:#f9fafb;
  color:var(--text);
}
.detail-save{
  width:100%;
  margin-top:12px;
  padding:10px;
  border:none;
  border-radius:10px;
  background:linear-gradient(135deg,#1976d2,#4caf50);
  color:#fff;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <div class="login-logo">ğŸ“¦</div>
    <h3>Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
    <p>ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</p>

    <input id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <input id="loginPass" type="password" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ">

    <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginLoading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
    <div id="loginError"></div>
    <div id="buildInfo"></div>
  </div>
</div>

<!-- MAIN MENU -->
<div id="mainScreen">
  <div class="main-card">
    <div class="main-header">
      <div>
        <div class="main-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="main-sub">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</div>
      </div>
      <div class="main-badge">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯</div>
    </div>

    <div class="main-list">
      <button class="main-btn" onclick="openMenu(1)">
        <span class="left">
          <span class="main-icon">ğŸ“</span>
          <span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</span>
        </span>
        <span class="main-arrow">Ù‚Ø±ÙŠØ¨Ø§Ù‹</span>
      </button>

      <button class="main-btn" onclick="openMenu(2)">
        <span class="left">
          <span class="main-icon">ğŸš—</span>
          <span>Ø¨Ø¶Ø§Ø¹Ø© Ø´Ø±ÙƒØ© ØªÙˆÙŠÙˆØªØ§</span>
        </span>
        <span class="main-arrow">Ù‚Ø±ÙŠØ¨Ø§Ù‹</span>
      </button>

      <button class="main-btn primary" onclick="openMenu(3)">
        <span class="left">
          <span class="main-icon">ğŸ“‹</span>
          <span>Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ</span>
        </span>
        <span class="main-arrow">Ø¯Ø®ÙˆÙ„</span>
      </button>
    </div>
  </div>
</div>

<!-- APP (Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ) -->
<div id="appScreen">

  <div class="top-bar">
    <div class="top-title">Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
    <button class="icon-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
  </div>

  <div class="filter-wrap">
    <div class="filter-card">

      <div class="filter-header">
        <strong>Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</strong>
        <button class="clear-btn" onclick="clearFilters()">Ù…Ø³Ø­ âœ•</button>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:6px;margin:4px 0 6px;font-size:11px">
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="all" checked style="margin:0">
          <span>Ø§Ù„ÙƒÙ„</span>
        </label>
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="counted" style="margin:0">
          <span>Ø§Ù„Ù…Ø¬Ø±Ø¯</span>
        </label>
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="diff" style="margin:0">
          <span>ÙÙŠÙ‡ ÙØ±Ù‚</span>
        </label>
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="not" style="margin:0">
          <span>ØºÙŠØ± Ù…Ø¬Ø±Ø¯</span>
        </label>
      </div>

      <div class="filter-row">
        <input id="pContains" class="filter-input" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙŠØ­ØªÙˆÙŠ">
        <input id="pEnds" class="filter-input" placeholder="ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€">
      </div>

      <div class="filter-row">
        <input id="nStarts" class="filter-input" placeholder="Ø§Ø³Ù… ÙŠØ¨Ø¯Ø£">
        <input id="nContains" class="filter-input" placeholder="ÙŠØ­ØªÙˆÙŠ">
      </div>

      <div class="filter-row">
        <input id="locFrom" class="filter-input" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù†">
        <input id="locTo" class="filter-input" placeholder="Ø¥Ù„Ù‰">
      </div>
    </div>
  </div>

  <div id="results"></div>
</div>

<script>
/* ===== Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØµÙØ­Ø© (ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù„Ù) ===== */
document.getElementById("buildInfo").textContent =
  "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù…Ù„Ù: " +
  new Date(document.lastModified).toLocaleString("ar-SA");

/* ===== API ===== */
const API="https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";

let ALL_DATA = [];
let LAST_RENDER = [];

/* ===== LOGIN ===== */
function login(){
  loginError.textContent="";
  loginLoading.style.display="block";
  loginLoading.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";

  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({
      mode:"login",
      name: loginUser.value,
      pass: loginPass.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.ok){
      loginLoading.style.display="none";
      loginError.textContent = res.error || "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
      return;
    }

    loginLoading.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†...";
    loadDataAfterLogin();
  })
  .catch(()=>{
    loginLoading.style.display="none";
    loginError.textContent="ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±";
  });
}

function logout(){ location.reload(); }

/* ===== DATA ===== */
function loadDataAfterLogin(){
  fetch(API)
    .then(r => r.json())
    .then(d => {
      ALL_DATA = Array.isArray(d) ? d : [];
      const initial = ALL_DATA.slice(0, 50);
      LAST_RENDER = initial;

      loginScreen.style.display="none";
      loginLoading.style.display="none";
      mainScreen.style.display="flex";
    })
    .catch(() => {
      loginLoading.style.display="none";
      loginError.textContent = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†";
    });
}

/* ===== ÙØªØ­ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ===== */
function openMenu(id){
  if(id === 3){
    mainScreen.style.display = "none";
    appScreen.style.display  = "block";

    if(!LAST_RENDER || !LAST_RENDER.length){
      const initial = ALL_DATA.slice(0, 50);
      LAST_RENDER = initial;
      render(initial);
    }else{
      render(LAST_RENDER);
    }
  }else{
    alert("Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù… ØªÙÙØ¹Ù‘Ù„ Ø¨Ø¹Ø¯");
  }
}

/* ===== Ø§Ù„ÙÙ„Ø§ØªØ± ===== */
let searchTimer = null;

document.querySelectorAll(".filter-input").forEach(inp=>{
  inp.addEventListener("input", ()=>{
    clearTimeout(searchTimer);
    searchTimer = setTimeout(runSearch, 300);
  });
});

document.querySelectorAll('input[name="countState"]').forEach(r=>{
  r.addEventListener("change", runSearch);
});

function clearFilters(){
  document.querySelectorAll(".filter-input").forEach(i=>i.value="");
  const allRadio = document.querySelector('input[name="countState"][value="all"]');
  if(allRadio) allRadio.checked = true;
  runSearch();
}

function runSearch(){
  const pc = (pContains.value || "").trim().toLowerCase();
  const pe = (pEnds.value || "").trim().toLowerCase();
  const ns = (nStarts.value || "").trim().toLowerCase();
  const nc = (nContains.value || "").trim().toLowerCase();
  const lfRaw = (locFrom.value || "").trim().toLowerCase();
  const ltRaw = (locTo.value || "").trim().toLowerCase();
  const stateEl = document.querySelector('input[name="countState"]:checked');
  const state = stateEl ? stateEl.value : "all";

  const hasLocFilter = !!(lfRaw || ltRaw);

  if(!pc && !pe && !ns && !nc && !lfRaw && !ltRaw && state==="all"){
    const initial = ALL_DATA.slice(0, 50);
    LAST_RENDER = initial;
    render(initial);
    return;
  }

  const res = [];
  for(const r of ALL_DATA){
    const p = String(r.part ?? "").toLowerCase();
    const n = String(r.name ?? "").toLowerCase();
    const l = String(r.location ?? "").toLowerCase();

    const hasCount    = r.lastCountedAt && String(r.lastCountedAt).trim() !== "";
    const qtySysNum   = Number(r.qty ?? 0);
    const qtyCountNum = Number(r.lastCountQty ?? 0);
    const isEqual     = hasCount && qtySysNum === qtyCountNum;

    if(state === "counted" && !hasCount) continue;
    if(state === "diff"    && !(hasCount && !isEqual)) continue;
    if(state === "not"     && hasCount) continue;

    if(pc && !p.includes(pc)) continue;
    if(pe && !p.endsWith(pe)) continue;
    if(ns && !n.startsWith(ns)) continue;
    if(nc && !n.includes(nc)) continue;

    if(hasLocFilter){
      const lf = lfRaw || l;
      const lt = ltRaw || l;

      if(l < lf) continue;
      if(l > lt) continue;
    }

    res.push(r);
    if(res.length >= 100) break;
  }

  if(hasLocFilter){
    res.sort((a,b)=>{
      const la = String(a.location ?? "").toLowerCase();
      const lb = String(b.location ?? "").toLowerCase();
      if(la < lb) return -1;
      if(la > lb) return 1;
      return 0;
    });
  }

  LAST_RENDER = res;
  render(res);
}

/* ===== Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ===== */
function fmtDate(d){
  if(!d) return "";
  const dt = new Date(d);
  if (isNaN(dt)) return "";
  const day   = String(dt.getDate()).padStart(2,"0");
  const month = String(dt.getMonth()+1).padStart(2,"0");
  const year  = dt.getFullYear();
  const hour  = String(dt.getHours()).padStart(2,"0");
  const min   = String(dt.getMinutes()).padStart(2,"0");
  return `${day}/${month}/${year} ${hour}:${min}`;
}

/* ===== Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ===== */
function render(data){
  results.innerHTML = data.map(r=>{
    const qtySysNum   = Number(r.qty ?? 0);
    const qtyCountNum = Number(r.lastCountQty ?? 0);

    let cls="part", status="";
    const hasCount = (r.lastCountedAt && String(r.lastCountedAt).trim() !== "");
    if(hasCount){
      if(qtySysNum === qtyCountNum){
        cls += " ok";
        status = `âœ“ ØªÙ… Ø§Ù„Ø¬Ø±Ø¯ (${fmtDate(r.lastCountedAt)}) - ${r.countedBy||""}`;
      }else{
        cls += " warn";
        status = `âš  ÙØ±Ù‚ Ø¬Ø±Ø¯ | Ø¬Ø±Ø¯: ${qtyCountNum.toLocaleString("ar-SA")} | Ù†Ø¸Ø§Ù…: ${qtySysNum.toLocaleString("ar-SA")} | ${fmtDate(r.lastCountedAt)}`;
      }
    }else{
      status = "Ù„Ù… ÙŠÙØ¬Ø±ÙØ¯ Ø¨Ø¹Ø¯";
    }

    const qtySysTxt   = qtySysNum.toLocaleString("ar-SA");
    const qtyCountTxt = qtyCountNum ? qtyCountNum.toLocaleString("ar-SA") : "";

    return `
<div class="item">
  <div class="part-row">
    <div class="${cls}">${r.part ?? ""}</div>
    <div class="location"><b>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</b> ${r.location ?? ""}</div>
  </div>
  <div class="name">${r.name ?? ""}</div>
  <div class="meta" style="display:flex;justify-content:space-between;gap:8px">
    <span>Ø§Ù„ÙƒÙ…ÙŠØ© (Ø§Ù„Ù†Ø¸Ø§Ù…): <b>${qtySysTxt}</b></span>
    <span>Ø§Ù„ÙƒÙ…ÙŠØ© (Ø§Ù„Ø¬Ø±Ø¯): <b>${qtyCountTxt}</b></span>
  </div>
  ${status ? `<div class="status">${status}</div>` : ""}
  <div style="display:flex;justify-content:flex-end;margin-top:6px">
    <button
      onclick='openDetail(${JSON.stringify(r.part ?? "")})'
      style="border:none;background:#1976d2;color:#fff;font-size:12px;padding:6px 12px;border-radius:8px;cursor:pointer">
      âœï¸ ØªØ¹Ø¯ÙŠÙ„
    </button>
  </div>
</div>`;
  }).join("");
}

/* ===== Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ===== */
function openDetail(part){
  const r = ALL_DATA.find(x => String(x.part) === String(part));
  if(!r) return;

  const ov = document.createElement("div");
  ov.className = "detail-overlay";

  const currentCount = (r.lastCountQty ?? "");
  const systemQty = (r.qty ?? 0);

  ov.innerHTML = `
    <div class="detail-card">
      <div class="detail-header">
        <span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¯</span>
        <button class="detail-close" onclick="this.closest('.detail-overlay').remove()">âœ•</button>
      </div>

      <div class="detail-label">Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</div>
      <div><b>${r.part}</b></div>

      <div class="detail-label">Ø§Ù„ÙƒÙ…ÙŠØ© (Ø§Ù„Ù†Ø¸Ø§Ù…) â€“ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·</div>
      <div><b>${systemQty}</b></div>

      <div class="detail-label">ÙƒÙ…ÙŠØ© Ø§Ù„Ø¬Ø±Ø¯</div>
      <div class="detail-qty-box">
        <button onclick="chg(-1)">âˆ’</button>
        <input id="cq" type="number" value="${currentCount}">
        <button onclick="chg(1)">+</button>
      </div>

      <div class="detail-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
      <textarea id="note"
        style="width:100%;min-height:60px;border-radius:8px;border:1px solid var(--border);padding:6px;background:#f9fafb;color:var(--text)">${r.note ?? ""}</textarea>

      <button class="detail-save" onclick="saveCount('${String(r.part).replace(/'/g,"\\'")}', ${Number(systemQty)})">
        Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      </button>
    </div>
  `;
  document.body.appendChild(ov);
}

function chg(d){
  const i = document.getElementById("cq");
  i.value = Math.max(0, (+i.value || 0) + d);
}

/* ===== Ø­ÙØ¸ Ø§Ù„Ø¬Ø±Ø¯ ===== */
function saveCount(part, systemQty){
  const counted = document.getElementById("cq").value;
  const noteVal = document.getElementById("note").value || "";

  const r = ALL_DATA.find(x => String(x.part) === String(part));
  if(r){
    r.lastCountedAt = new Date().toISOString();
    r.lastCountQty = counted;
    r.note = noteVal;
  }

  const ov = document.querySelector(".detail-overlay");
  if(ov) ov.remove();

  runSearch();

  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({
      mode:"save",
      part: part,
      systemQty: String(systemQty),
      countedQty: String(counted),
      note: noteVal
    })
  })
  .then(r=>r.json())
  .then(res=>{})
  .catch(()=>{});
}
</script>

</body>
</html>
