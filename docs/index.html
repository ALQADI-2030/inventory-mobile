<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</title>

<style>
:root{
  --bg:#f6f7f9;
  --card:#ffffff;
  --primary:#1e88e5;
  --ok:#2e7d32;
  --warn:#d32f2f;
  --text:#1f2937;
  --muted:#6b7280;
  --border:#e5e7eb;
}

*{
  box-sizing:border-box;
}

body{
  margin:0;
  font-family: system-ui, -apple-system;
  background:var(--bg);
  color:var(--text);
}

/* ===== TOP ===== */
.top-bar{
  position:sticky;
  top:0;
  background:var(--bg);
  padding:10px 14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  z-index:10;
}

.top-title{
  font-weight:700;
  font-size:15px;
}

.top-btn{
  border:none;
  background:var(--card);
  border-radius:10px;
  padding:6px 10px;
  font-size:13px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

/* ===== CONTAINER ===== */
.container{
  max-width:480px;
  margin:auto;
  padding:8px 10px 20px;
}

/* ===== SEARCH ===== */
.search{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  font-size:14px;
  margin-bottom:10px;
}

/* ===== ITEM CARD ===== */
.item{
  background:var(--card);
  border-radius:18px;
  padding:12px;
  margin-bottom:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.06);
}

/* header */
.item-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.part{
  font-weight:700;
  color:var(--primary);
  font-size:14px;
}

.location{
  font-size:12px;
  color:var(--muted);
  display:flex;
  align-items:center;
  gap:4px;
}

/* body */
.name{
  margin-top:4px;
  font-size:13px;
  line-height:1.4;
}

.qty{
  margin-top:8px;
  font-size:14px;
  font-weight:600;
}

/* status */
.status{
  margin-top:4px;
  font-size:12px;
  display:flex;
  align-items:center;
  gap:4px;
}

/* note */
.note-box{
  margin-top:10px;
}

.note-box textarea{
  width:100%;
  min-height:48px;
  border-radius:12px;
  border:1px solid var(--border);
  padding:8px;
  font-size:13px;
  background:#fafafa;
}

.note-hint{
  font-size:11px;
  color:var(--muted);
  margin-top:3px;
}

/* empty */
.empty{
  text-align:center;
  color:var(--muted);
  margin-top:30px;
  font-size:14px;
}
</style>
</head>

<body>

<div class="top-bar">
  <div class="top-title">ğŸ“¦ Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
  <button class="top-btn" onclick="loadData()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
</div>

<div class="container">
  <input id="search" class="search" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…">
  <div id="results"></div>
</div>

<script>
const API = "Ø¶Ø¹_Ø±Ø§Ø¨Ø·_Ø§Ù„Ø§Ø¨_Ø³ÙƒØ±ÙŠØ¨Øª_Ù‡Ù†Ø§";
let ALL_DATA = [];

/* ØªØ­Ù…ÙŠÙ„ */
function loadData(){
  fetch(API)
    .then(r=>r.json())
    .then(d=>{
      ALL_DATA = d;
      render(d);
    });
}

/* Ø¨Ø­Ø« */
search.addEventListener("input",()=>{
  const q = search.value.trim().toLowerCase();
  const f = ALL_DATA.filter(r =>
    String(r.part).includes(q) ||
    String(r.name).toLowerCase().includes(q)
  );
  render(f);
});

/* Ø±Ø³Ù… */
function render(data){
  if(!data.length){
    results.innerHTML = "<div class='empty'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>";
    return;
  }

  results.innerHTML = data.map(r=>{
    const counted = r.lastCountedAt;
    const changed = counted && Number(r.qty) !== Number(r.lastCountQty);

    let statusHtml = "";
    if(counted && !changed){
      statusHtml = `<div class="status" style="color:var(--ok)">âœ… ØªÙ… Ø§Ù„Ø¬Ø±Ø¯</div>`;
    }
    if(counted && changed){
      statusHtml = `
        <div class="status" style="color:var(--warn)">
          ğŸ”´ ØªÙ… Ø§Ù„Ø¬Ø±Ø¯ ( ${r.lastCountQty} â† ${r.qty} )
        </div>`;
    }

    return `
    <div class="item">
      <div class="item-header">
        <div class="part">${r.part}</div>
        <div class="location">ğŸ“ ${r.location || "-"}</div>
      </div>

      <div class="name">${r.name}</div>

      <div class="qty">ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©: ${r.qty}</div>

      ${statusHtml}

      <div class="note-box">
        <textarea
          placeholder="ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¬Ø§Ø±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"
          onblur="saveNote('${r.part}', this.value)"
        >${r.note || ""}</textarea>
        <div class="note-hint">ØªÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆØªØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹</div>
      </div>
    </div>
    `;
  }).join("");
}

/* Ø­ÙØ¸ Ù…Ù„Ø§Ø­Ø¸Ø© */
function saveNote(part, note){
  fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body:new URLSearchParams({
      action:"saveNote",
      part:part,
      note:note
    })
  });
}

loadData();
</script>

</body>
</html>
