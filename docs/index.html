<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>جرد المخزون</title>

<style>
:root{
  --bg:#f4f5f7;
  --card:#ffffff;
  --primary:#1976d2;
  --ok:#1b5e20;
  --warn:#c62828;
  --text:#222;
  --muted:#777;
  --border:#e0e0e0;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:var(--bg);
  padding:8px;
}

/* ===== TOP ===== */
.top-bar{
  max-width:430px;
  margin:0 auto 6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.top-title{font-weight:700;font-size:15px}
.icon-btn{
  border:none;
  border-radius:8px;
  padding:6px 10px;
  background:var(--card);
  box-shadow:0 1px 4px rgba(0,0,0,.12);
  cursor:pointer;
}

/* ===== FILTER ===== */
.filter-wrap,#results{
  max-width:430px;
  margin:0 auto 8px;
}

.filter-card{
  background:var(--card);
  border-radius:12px;
  padding:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
}

.filter-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
}

.clear-btn{
  font-size:12px;
  background:#f1f3f4;
  border:none;
  border-radius:6px;
  padding:4px 8px;
  cursor:pointer;
}

.filter-row{
  display:flex;
  gap:6px;
  margin-bottom:6px;
}

.filter-input{
  flex:1;
  min-width:0;
  padding:7px 8px;
  font-size:12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fafafa;
}

@media (max-width:480px){
  .filter-row{flex-wrap:wrap}
  .filter-input{flex:1 1 48%}
}

/* ===== ITEM ===== */
.item{
  background:var(--card);
  border-radius:12px;
  padding:9px;
  margin-bottom:7px;
  box-shadow:0 3px 8px rgba(0,0,0,.05);
  cursor:pointer;
}

.part-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.part{
  font-weight:700;
  color:var(--primary);
}

.part.ok{color:var(--ok)}
.part.warn{color:var(--warn)}

.location{
  font-size:12px;
  color:var(--muted);
}

.name{
  font-size:13px;
  margin-top:2px;
}

.meta{
  font-size:12px;
  margin-top:4px;
  color:var(--muted);
}

.status{
  font-size:12px;
  margin-top:4px;
}

/* ===== DETAIL ===== */
.detail-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  z-index:999;
}

.detail-card{
  width:100%;
  max-width:430px;
  background:var(--card);
  border-radius:16px 16px 0 0;
  padding:12px;
}

.detail-header{
  display:flex;
  justify-content:space-between;
  font-weight:600;
}

.detail-close{
  border:none;
  background:none;
  font-size:18px;
}

.detail-label{
  font-size:12px;
  color:var(--muted);
  margin-top:6px;
}

.detail-value{
  font-size:14px;
}

.detail-qty-box{
  display:flex;
  gap:8px;
  margin-top:4px;
}

.detail-qty-box button{
  width:40px;
  border:none;
  border-radius:10px;
  font-size:20px;
}

.detail-qty-box input{
  flex:1;
  text-align:center;
  font-size:16px;
}

.detail-save{
  margin-top:10px;
  width:100%;
  padding:10px;
  border:none;
  border-radius:10px;
  background:var(--primary);
  color:#fff;
}
</style>
</head>

<body>

<div class="top-bar">
  <div class="top-title">جرد المخزون</div>
</div>

<!-- SEARCH -->
<div class="filter-wrap">
  <div class="filter-card">

    <div class="filter-header">
      <strong style="font-size:13px">البحث المتقدم</strong>
      <button class="clear-btn" onclick="clearFilters()">مسح ✕</button>
    </div>

    <div class="filter-row">
      <input id="pContains" class="filter-input" placeholder="رقم الصنف يحتوي">
      <input id="pEnds" class="filter-input" placeholder="ينتهي بـ">
    </div>

    <div class="filter-row">
      <input id="nStarts" class="filter-input" placeholder="اسم الصنف يبدأ">
      <input id="nContains" class="filter-input" placeholder="يحتوي">
    </div>

    <div class="filter-row">
      <input id="locFrom" class="filter-input" placeholder="الموقع من">
      <input id="locTo" class="filter-input" placeholder="إلى">
    </div>

  </div>
</div>

<!-- RESULTS -->
<div id="results"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";
let ALL_DATA = [];

/* تحميل */
function loadData(){
  fetch(API).then(r=>r.json()).then(d=>{
    ALL_DATA = d;
    runSearch();
  });
}

/* البحث */
document.querySelectorAll(".filter-input")
  .forEach(i=>i.addEventListener("input",runSearch));

function runSearch(){
  const res=[];
  const pC=pContains.value.toLowerCase();
  const pE=pEnds.value.toLowerCase();
  const nS=nStarts.value.toLowerCase();
  const nC=nContains.value.toLowerCase();
  const lF=locFrom.value.toLowerCase();
  const lT=locTo.value.toLowerCase();

  for(const r of ALL_DATA){
    const p=String(r.part||"").toLowerCase();
    const n=String(r.name||"").toLowerCase();
    const l=String(r.location||"").toLowerCase();

    if(pC&&!p.includes(pC))continue;
    if(pE&&!p.endsWith(pE))continue;
    if(nS&&!n.startsWith(nS))continue;
    if(nC&&!n.includes(nC))continue;
    if(lF&&l<lF)continue;
    if(lT&&l>lT)continue;

    res.push(r);
  }
  render(res);
}

/* مسح */
function clearFilters(){
  document.querySelectorAll(".filter-input").forEach(i=>i.value="");
  render(ALL_DATA);
}

/* عرض */
function render(data){
  if(!data.length){
    results.innerHTML="<div class='meta'>لا توجد نتائج</div>";
    return;
  }

  results.innerHTML=data.map(r=>{
    const counted=r.lastCountedAt;
    const changed=counted && Number(r.qty)!==Number(r.lastCountQty);

    let cls="part";
    let status="";

    if(counted&&!changed){
      cls+=" ok";
      status="✓ تم الجرد";
    }
    if(counted&&changed){
      cls+=" warn";
      status=`⚠ تم الجرد (كان ${r.lastCountQty} ← الآن ${r.qty})`;
    }

    return `
    <div class="item" onclick="openDetail('${r.part}')">
      <div class="part-row">
        <div class="${cls}">${r.part}</div>
        <div class="location">${r.location||""}</div>
      </div>
      <div class="name">${r.name||""}</div>
      <div class="meta">الكمية المتوفرة: <b>${r.qty}</b></div>
      ${status?`<div class="status">${status}</div>`:""}
    </div>`;
  }).join("");
}

/* تفاصيل + ملاحظات */
function openDetail(part){
  const r=ALL_DATA.find(x=>String(x.part)===String(part));
  if(!r)return;

  const ov=document.createElement("div");
  ov.className="detail-overlay";
  ov.innerHTML=`
  <div class="detail-card">
    <div class="detail-header">
      <span>تفاصيل الجرد</span>
      <button class="detail-close" onclick="this.closest('.detail-overlay').remove()">✕</button>
    </div>

    <div class="detail-label">رقم الصنف</div>
    <div class="detail-value">${r.part}</div>

    <div class="detail-label">كمية الجرد</div>
    <div class="detail-qty-box">
      <button onclick="chg(-1)">−</button>
      <input id="cq" type="number" value="${r.countedQty||0}">
      <button onclick="chg(1)">+</button>
    </div>

    <div class="detail-label">ملاحظات الجرد</div>
    <textarea id="note" style="width:100%;min-height:60px;border-radius:8px;border:1px solid var(--border);padding:6px">${r.note||""}</textarea>

    <button class="detail-save" onclick="save('${r.part}',${r.qty})">حفظ</button>
  </div>`;
  document.body.appendChild(ov);
}

function chg(d){
  cq.value=Math.max(0,(+cq.value||0)+d);
}

function save(p,sq){
  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({
      part:p,
      systemQty:sq,
      countedQty:cq.value,
      note:note.value
    })
  });
  document.querySelector(".detail-overlay").remove();
  loadData();
}

/* بدء */
loadData();
</script>

</body>
</html>
