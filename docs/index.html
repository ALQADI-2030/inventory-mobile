<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Ø´Ø±ÙƒØ© Ø§Ù„Ù‚Ø§Ø¶ÙŠ</title>

<link rel="manifest" href="manifest.json">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
:root{
  --bg:#f3f4fb;
  --card:rgba(255,255,255,0.94);
  --primary:#2563eb;
  --primary-soft:rgba(37,99,235,0.10);
  --accent:#7c3aed;
  --ok:#16a34a;
  --warn:#dc2626;
  --text:#0f172a;
  --muted:#6b7280;
  --border:rgba(148,163,184,0.35);
}

body{
  margin:0;
  font-family:system-ui,-apple-system;
  min-height:100vh;
  background:
    radial-gradient(circle at 0% 0%, rgba(59,130,246,0.12) 0, transparent 55%),
    radial-gradient(circle at 100% 100%, rgba(56,189,248,0.16) 0, #e5e7eb 55%);
  padding:12px;
  color:var(--text);
}
*{box-sizing:border-box}
input, textarea, button{ font-size:16px; }

/* LOGIN SCREEN STYLES [cite: 5-18] */
.login-screen{
  position:fixed; inset:0; z-index:1000; display:flex; justify-content:center; align-items:center;
  background:radial-gradient(circle at 0% 0%, rgba(59,130,246,0.18) 0, transparent 55%),
             radial-gradient(circle at 100% 100%, rgba(236,72,153,0.16) 0, rgba(248,250,252,0.96) 55%);
}
.login-box{
  width:100%; max-width:360px; padding:24px 20px 20px; border-radius:28px;
  background:var(--card); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px);
  box-shadow: 0 22px 60px rgba(15,23,42,0.25), 0 0 0 1px rgba(148,163,184,0.40);
  text-align:center; position:relative; overflow:hidden;
}
.login-box::before{
  content:""; position:absolute; inset:-40%; opacity:0.45; pointer-events:none; mix-blend-mode:soft-light;
  background: radial-gradient(circle at 0% 0%, rgba(59,130,246,0.18) 0, transparent 55%),
              radial-gradient(circle at 100% 0%, rgba(236,72,153,0.20) 0, transparent 55%);
}
.login-logo{ width:120px; height:64px; margin:4px auto 14px; display:flex; align-items:center; justify-content:center; }
.login-logo img{ max-width:100%; max-height:100%; object-fit:contain; display:block; }
.login-box h3{ margin:6px 0 4px; font-size:18px; font-weight:800; }
.login-box p{ font-size:12px; color:var(--muted); margin:0 0 12px; }
.login-box input{
  width:100%; padding:11px; margin-top:9px; border-radius:14px; border:1px solid var(--border);
  background:rgba(248,250,252,0.9); transition:all .15s ease;
}
.login-box input:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 1px rgba(37,99,235,0.45); background:#ffffff; }
.login-btn{
  width:100%; margin-top:16px; padding:11px; border:none; border-radius:999px;
  background:linear-gradient(135deg,#2563eb,#7c3aed); color:#ffffff; cursor:pointer; font-weight:700;
  box-shadow: 0 14px 32px rgba(37,99,235,0.55), 0 0 0 1px rgba(129,140,248,0.65);
  transition:transform .12s ease, box-shadow .12s ease;
}
.login-btn:active{ transform:translateY(1px) scale(0.99); }

/* MAIN MENU STYLES [cite: 19-26] */
#mainScreen{ display:none; min-height:100vh; display:flex; justify-content:center; align-items:center; }
.main-card{
  width:100%; max-width:380px; background:#0f172a; border-radius:28px; padding:18px 16px 16px;
  box-shadow: 0 24px 55px rgba(15,23,42,0.5); color:#e5e7eb; position:relative; overflow:hidden;
}
.main-header{ display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:12px; }
.main-title{ font-size:18px; font-weight:800; color:#ffffff; }
.main-badge{ font-size:11px; background:#1d4ed8; color:#e5e7eb; padding:4px 10px; border-radius:999px; box-shadow:0 0 0 1px rgba(37,99,235,0.7); }
.main-list{ margin-top:4px; display:flex; flex-direction:column; gap:10px; }
.main-btn{
  width:100%; border:none; border-radius:18px; padding:10px; display:flex; align-items:center; justify-content:space-between;
  cursor:pointer; background:#1d4ed8; color:#f9fafb; box-shadow:0 4px 12px rgba(15,23,42,0.4); transition:all .12s ease;
}
.main-btn.primary{ background:#1d4ed8; box-shadow:0 14px 30px rgba(15,23,42,0.6); }
.main-icon{ width:32px; height:32px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:18px; background:rgba(15,23,42,0.25); color:#f9fafb; }
.main-arrow{ font-size:13px; color:#e5e7eb; font-weight:600; }

/* APP SCREEN & FILTERS [cite: 27-35] */
#appScreen{ display:none; }
.top-bar{ max-width:430px; margin:0 auto 6px; display:flex; justify-content:space-between; align-items:center; }
.icon-btn{ border:none; border-radius:999px; padding:6px 12px; background:rgba(255,255,255,0.92); color:#0f172a; box-shadow:0 1px 4px rgba(148,163,184,.55); cursor:pointer; display:flex; align-items:center; gap:4px; transition:all .12s ease; }
.filter-wrap{ position:sticky; top:0; z-index:10; max-width:430px; margin:0 auto 8px; }
.filter-card{ background:var(--card); border-radius:16px; padding:8px; box-shadow:0 3px 10px rgba(148,163,184,.35); backdrop-filter:blur(14px); border:1px solid var(--border); }
.filter-row{ display:flex; gap:6px; margin-bottom:6px; }
.filter-input{ flex:1; padding:7px 8px; border-radius:10px; border:1px solid var(--border); background:#f9fafb; font-size:14px; transition:all .15s ease; }
.filter-input:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 1px rgba(37,99,235,0.45); background:#ffffff; }

/* ITEM STYLE [cite: 36-39] */
.item{ background:var(--card); border-radius:16px; padding:9px 9px 10px; margin-bottom:7px; box-shadow:0 4px 12px rgba(148,163,184,.35); border:1px solid rgba(226,232,240,0.9); }
.item[style*="border:2px solid"]{ background:#fff7ed; }
.part{ font-weight:700; color:var(--primary); }
.part.ok{ color:var(--ok); }
.part.warn{ color:var(--warn); }
.meta{ font-size:12px; color:var(--muted); margin-top:4px; }
.status{ font-size:12px; margin-top:4px; }

/* DETAIL POPUP [cite: 40-47] */
.detail-overlay{ position:fixed; inset:0; background:rgba(15,23,42,.35); display:flex; justify-content:center; align-items:flex-end; z-index:9999; }
.detail-card{ width:100%; max-width:430px; background:var(--card); border-radius:18px 18px 0 0; padding:12px; color:var(--text); box-shadow:0 -8px 25px rgba(15,23,42,0.45); border-top:1px solid var(--border); }
.detail-qty-box{ display:flex; gap:8px; margin-top:6px; }
.detail-qty-box button{ width:40px; border:none; border-radius:10px; font-size:20px; cursor:pointer; background:#e5e7eb; transition:all .12s ease; }
.detail-qty-box input{ flex:1; text-align:center; border:1px solid var(--border); border-radius:10px; padding:8px; background:#f9fafb; }
.detail-save{ width:100%; margin-top:12px; padding:10px; border:none; border-radius:999px; background:linear-gradient(135deg,#2563eb,#7c3aed); color:#fff; cursor:pointer; transition:all .12s ease; box-shadow:0 12px 26px rgba(37,99,235,0.45); }

#scannerContainer{ display:none; max-width:430px; margin:6px auto; background:#020617; border-radius:14px; overflow:hidden; }
</style>
</head>

<body>

<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <div class="login-logo"><img src="logo.png.gif" alt=""></div>
    <h3>Ø´Ø±ÙƒØ© Ø§Ù„Ù‚Ø§Ø¶ÙŠ Ù„Ø¨ÙŠØ¹ Ù‚Ø·Ø¹ ØºÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h3>
    <p>ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</p>
    <input id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <input id="loginPass" type="password" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ">
    <button class="login-btn" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginLoading" style="display:none; margin-top:10px; font-size:12px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
    <div id="loginError" style="margin-top:8px; font-size:12px; color:#dc2626;"></div>
    <div id="buildInfo" style="margin-top:10px; font-size:11px; color:#9ca3af;"></div>
  </div>
</div>

<div id="mainScreen">
  <div class="main-card">
    <div class="main-header">
      <div><div class="main-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div><div style="font-size:11px; color:#cbd5f5;">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</div></div>
      <div class="main-badge">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
    </div>
    <div class="main-list">
      <button class="main-btn" onclick="alert('Ù„Ù… ØªÙØ¹Ù„')"><span style="display:flex; align-items:center; gap:10px;"><span class="main-icon">ğŸš—</span><span>Ø¨Ø¶Ø§Ø¹Ø© ØªÙˆÙŠÙˆØªØ§</span></span><span class="main-arrow">â€º</span></button>
      <button class="main-btn primary" onclick="openMenu(3)"><span style="display:flex; align-items:center; gap:10px;"><span class="main-icon">ğŸ“‹</span><span>Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ</span></span><span class="main-arrow">â€º</span></button>
      <button class="main-btn" onclick="openSalesMenu()"><span style="display:flex; align-items:center; gap:10px;"><span class="main-icon">ğŸ’°</span><span>Ù…Ø¨ÙŠØ¹Ø§Øª</span></span><span class="main-arrow">â€º</span></button>
      <button class="main-btn" onclick="logoutUser()"><span style="display:flex; align-items:center; gap:10px;"><span class="main-icon">ğŸšª</span><span>Ø®Ø±ÙˆØ¬</span></span><span class="main-arrow">â€º</span></button>
    </div>
  </div>
</div>

<div id="appScreen">
  <div class="top-bar">
    <div class="top-title" id="topTitle" style="font-weight:700;">Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ</div>
    <button class="icon-btn" onclick="backToMain()">Ø¹ÙˆØ¯Ø©</button>
  </div>

  <div class="filter-wrap">
    <div class="filter-card">
      <div class="filter-row">
        <select id="branchFilter" class="filter-input" style="flex:1" onchange="runSearchInventory()">
          <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>
          <option value="*">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
          <option value="Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø§ÙˆÙ„</option>
          <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
          <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«</option>
          <option value="Ù…Ø³ØªÙˆØ¯Ø¹ ÙØ±Ø¹ 3">Ù…Ø³ØªÙˆØ¯Ø¹ ÙØ±Ø¹ 3</option>
        </select>
        <button class="clear-btn" onclick="clearFilters()" style="border:none; padding:5px 10px; border-radius:8px; cursor:pointer;">Ù…Ø³Ø­ âœ•</button>
      </div>
      <div id="countStateWrap" style="display:flex; flex-wrap:wrap; gap:10px; font-size:11px; margin-bottom:6px;">
        <label><input type="radio" name="countState" value="all" checked onchange="runSearchInventory()"> Ø§Ù„ÙƒÙ„</label>
        <label><input type="radio" name="countState" value="counted" onchange="runSearchInventory()"> Ø§Ù„Ù…Ø¬Ø±Ø¯</label>
        <label><input type="radio" name="countState" value="diff" onchange="runSearchInventory()"> ÙÙŠÙ‡ ÙØ±Ù‚</label>
        <label><input type="radio" name="countState" value="not" onchange="runSearchInventory()"> ØºÙŠØ± Ù…Ø¬Ø±Ø¯</label>
      </div>
      <div class="filter-row">
        <input id="pContains" class="filter-input" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù">
        <input id="nContains" class="filter-input" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
        <button id="scanBtn" style="border:none; background:#2563eb; color:#fff; padding:5px 10px; border-radius:8px; cursor:pointer;">ğŸ“·</button>
      </div>
    </div>
  </div>

  <div id="scannerContainer">
    <div id="reader" style="width:100%;"></div>
    <button onclick="stopScan()" style="width:100%; border:none; background:#eee; padding:10px; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
  </div>

  <div id="results"></div>
  <div id="salesLoading" style="display:none; text-align:center; padding:10px; color:#6b7280;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</div>
</div>

<audio id="beepAudio"><source src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUAAAAA="></audio>

<script>
// INITIALIZATION [cite: 60-69]
document.getElementById("buildInfo").textContent = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + new Date(document.lastModified).toLocaleString("ar-SA");

let ALL_DATA = [], SALES_DATA = [], CURRENT_VIEW = "inventory", CURRENT_USER = "", CURRENT_ROLE = "", AUTO_REFRESH = null;
let CURRENT_DETAIL_PART = null, CURRENT_DETAIL_BRANCH = null;

// MOBILE HANDLERS 
document.addEventListener("gesturestart", e => e.preventDefault());
let lastTouchEnd = 0;
document.addEventListener("touchend", e => {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) e.preventDefault();
  lastTouchEnd = now;
}, false);

// 1. SILENT REFRESH LOGIC (Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©)
function refreshDataSilently() {
  const isTyping = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA';
  if (isTyping) return;

  const mode = (CURRENT_VIEW === "sales") ? "sales" : "inventory";
  fetch(API + "?mode=" + mode)
    .then(r => r.json())
    .then(d => {
      if (!d || !Array.isArray(d)) return;
      if (mode === "sales") { SALES_DATA = d.slice(); runSearchSales(); } 
      else { ALL_DATA = d.slice(); runSearchInventory(); }
    }).catch(()=>{});
}

document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible" && CURRENT_USER) refreshDataSilently();
});

setInterval(() => { if(CURRENT_USER) refreshDataSilently(); }, 60000);

// 2. CORE FUNCTIONS [cite: 70-87]
function normalizeBarcode(text) {
  if (!text) return "";
  let val = String(text).trim();
  return /^\d/.test(val) ? val.substring(0, 10) : val;
}

function login(){
  const user = loginUser.value.trim(), pass = loginPass.value.trim();
  if(!user || !pass) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  loginLoading.style.display="block";
  fetch(API, { method:"POST", body:new URLSearchParams({ name: user, pass: pass }) })
    .then(r=>r.json()).then(res=>{
      if(!res.ok) throw new Error(res.error);
      CURRENT_USER = res.user.name; CURRENT_ROLE = res.user.role;
      localStorage.setItem("stockUser", CURRENT_USER);
      loadInventoryAfterLogin();
    }).catch(e=>{ loginLoading.style.display="none"; loginError.textContent = e.message; });
}

function loadInventoryAfterLogin(){
  let progress = 0;
  const interval = setInterval(()=>{
    if(progress < 95) { progress += 5; loginLoading.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ${progress}%...`; }
  }, 100);

  fetch(API + "?mode=inventory")
    .then(r=>r.json()).then(d=>{
      clearInterval(interval);
      ALL_DATA = d;
      loginScreen.style.display="none"; mainScreen.style.display="flex";
    }).catch(()=>alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"));
}

// 3. DETAIL SCREEN (Ù…Ø¹ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨) [cite: 124-128]
function openDetail(part) {
  if (CURRENT_VIEW !== "inventory") return;
  const branchVal = (branchFilter.value || "").trim().toLowerCase();
  const r = ALL_DATA.find(x => String(x.part) === String(part) && String(x.branch || "").trim().toLowerCase() === branchVal);
  if (!r) return;

  CURRENT_DETAIL_PART = r.part; CURRENT_DETAIL_BRANCH = r.branch || "";

  const ov = document.createElement("div");
  ov.className = "detail-overlay";
  ov.innerHTML = `
    <div class="detail-card">
      <div style="display:flex; justify-content:space-between; font-weight:700;"><span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ù</span><button onclick="this.closest('.detail-overlay').remove()" style="border:none; background:none; font-size:20px; cursor:pointer;">âœ•</button></div>
      <div style="font-size:12px; color:var(--muted); margin-top:8px;">Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù: <b>${r.part}</b></div>
      
      <div style="display:flex; justify-content:space-between; font-size:11px; color:#6b7280; background:#f8fafc; padding:6px; border-radius:6px; margin-top:10px; border:1px solid #e2e8f0;">
        <span>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${r.location || '??'}</span>
        <span>ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…: ${r.qty}</span>
      </div>

      <div style="font-size:12px; margin-top:12px;">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø±Ø¯ (Ø§Ù„Ø±Ù)</div>
      <input id="newLoc" value="${r.countLocation || r.location || ''}" style="width:100%; padding:8px; border-radius:8px; border:1px solid var(--border); margin-top:4px;">
      
      <div style="font-size:12px; margin-top:12px;">ÙƒÙ…ÙŠØ© Ø§Ù„Ø¬Ø±Ø¯</div>
      <div class="detail-qty-box">
        <button onclick="chg(-1)">&minus;</button>
        <input id="cq" type="number" value="${r.lastCountQty ?? ''}">
        <button onclick="chg(1)">+</button>
      </div>

      <div style="font-size:12px; margin-top:12px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
      <textarea id="note" style="width:100%; min-height:50px; border-radius:8px; border:1px solid var(--border); padding:6px; margin-top:4px;">${r.note || ''}</textarea>
      
      <button id="detailSaveBtn" class="detail-save" onclick="saveCount('${r.part}', ${r.qty})">Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
    </div>
  `;
  document.body.appendChild(ov);
}

function chg(v){ const i = document.getElementById("cq"); i.value = Math.max(0, (+i.value || 0) + v); }

function saveCount(part, systemQty) {
  const cqVal = document.getElementById("cq").value, noteVal = document.getElementById("note").value, locVal = document.getElementById("newLoc").value;
  const btn = document.getElementById("detailSaveBtn");
  btn.disabled = true; btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

  fetch(API, {
    method:"POST",
    body:new URLSearchParams({
      part: part, systemQty: systemQty, countedQty: cqVal, note: noteVal,
      user: CURRENT_USER, newLocation: locVal, branch: CURRENT_DETAIL_BRANCH
    })
  }).then(r=>r.json()).then(data => {
    if(data.ok){
      document.querySelector(".detail-overlay").remove();
      playBeep();
      refreshDataSilently(); // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
    } else alert("Ø­Ø¯Ø« Ø®Ø·Ø£");
  }).catch(()=>alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸"));
}

// 4. SEARCH & RENDER [cite: 107-123]
function runSearchInventory(){
  const pc = pContains.value.toLowerCase(), nc = nContains.value.toLowerCase(), brVal = branchFilter.value.toLowerCase();
  const state = document.querySelector('input[name="countState"]:checked').value;
  if(!brVal) return;

  const res = ALL_DATA.filter(r => {
    const br = String(r.branch||"").toLowerCase();
    const hasCount = !!r.lastCountedAt;
    if(brVal !== "*" && br !== brVal) return false;
    if(state === "counted" && !hasCount) return false;
    if(state === "diff" && (!hasCount || r.qty == r.lastCountQty)) return false;
    if(state === "not" && hasCount) return false;
    if(pc && !String(r.part).toLowerCase().includes(pc)) return false;
    if(nc && !String(r.name).toLowerCase().includes(nc)) return false;
    return true;
  }).slice(0, 100);
  
  renderInventory(res);
}

function renderInventory(data){
  results.innerHTML = data.map(r => {
    const isDiff = r.lastCountedAt && r.qty != r.lastCountQty;
    const style = isDiff && Math.abs(r.qty - r.lastCountQty) >= 5 ? "border:2px solid #f97316;" : "";
    return `
      <div class="item" style="${style}">
        <div style="display:flex; justify-content:space-between;">
          <span class="part ${r.lastCountedAt ? (isDiff ? 'warn' : 'ok') : ''}">${r.part}</span>
          <span class="location">ğŸ“ ${r.location || ''}</span>
        </div>
        <div style="font-size:13px; margin:4px 0;">${r.name}</div>
        <div class="meta">Ø§Ù„Ù†Ø¸Ø§Ù…: <b>${r.qty}</b> | Ø§Ù„Ø¬Ø±Ø¯: <b>${r.lastCountQty || 0}</b></div>
        <div class="status" style="font-size:11px; color:#6b7280;">${r.lastCountedAt ? 'âœ… ' + r.countedBy : 'â³ Ù„Ù… ÙŠØ¬Ø±Ø¯'}</div>
        <div style="display:flex; justify-content:flex-end; margin-top:6px;">
          <button onclick="openDetail('${r.part}')" style="border:none; background:var(--primary); color:#fff; padding:6px 12px; border-radius:8px; cursor:pointer;">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        </div>
      </div>
    `;
  }).join('');
}

// SALES VIEW
function openSalesMenu(){
  CURRENT_VIEW="sales"; topTitle.textContent="Ù…Ø¨ÙŠØ¹Ø§Øª"; countStateWrap.style.display="none"; 
  mainScreen.style.display="none"; appScreen.style.display="block";
  if(!SALES_DATA.length) SALES_DATA = ALL_DATA.slice();
  runSearchSales();
}

function runSearchSales(){
  const pc = pContains.value.toLowerCase(), nc = nContains.value.toLowerCase();
  const res = SALES_DATA.filter(r => {
    if(pc && !String(r.part).toLowerCase().includes(pc)) return false;
    if(nc && !String(r.name).toLowerCase().includes(nc)) return false;
    return true;
  }).slice(0, 100);
  results.innerHTML = res.map(r => `
    <div class="item">
      <div style="display:flex; justify-content:space-between;"><span class="part">${r.part}</span><span class="location">${r.branch}</span></div>
      <div style="font-size:13px; margin:4px 0;">${r.name}</div>
      <div class="meta">Qty: ${r.qty} | Ø§Ù„ØªÙƒÙ„ÙØ©: ${r.cost} | Ø§Ù„Ø³Ø¹Ø±: ${r.maxPrice}</div>
    </div>
  `).join('');
}

// HELPERS
function openMenu(id){ if(id===3){ mainScreen.style.display="none"; appScreen.style.display="block"; runSearchInventory(); } }
function backToMain(){ appScreen.style.display="none"; mainScreen.style.display="flex"; refreshDataSilently(); }
function playBeep(){ document.getElementById("beepAudio").play().catch(()=>{}); }
function logoutUser(){ localStorage.clear(); location.reload(); }
function clearFilters(){ pContains.value=""; nContains.value=""; runSearchInventory(); }

// SCANNER [cite: 141-146]
let html5QrCode = null;
document.getElementById("scanBtn").addEventListener("click", () => {
  document.getElementById("scannerContainer").style.display="block";
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
    pContains.value = normalizeBarcode(txt); stopScan(); runSearchInventory();
  });
});
function stopScan(){ if(html5QrCode){ html5QrCode.stop(); document.getElementById("scannerContainer").style.display="none"; } }

// AUTO-LOGIN
window.onload = () => {
  const u = localStorage.getItem("stockUser");
  if(u){ CURRENT_USER = u; loadInventoryAfterLogin(); }
};

// LISTENERS
[pContains, nContains].forEach(el => el.addEventListener('input', () => {
  if(CURRENT_VIEW === "inventory") runSearchInventory(); else runSearchSales();
}));
</script>

</body>
</html>
