<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ط´ط±ظƒط© ط§ظ„ظ‚ط§ط¶ظٹ</title>function updateProfitPanel

<link rel="manifest" href="manifest.json">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
:root{
  --bg:#f3f4fb;
  --card:rgba(255,255,255,0.94);
  --primary:#2563eb;
  --primary-soft:rgba(37,99,235,0.10);
  --accent:#7c3aed;
  --ok:#16a34a;
  --warn:#dc2626;
  --text:#0f172a;
  --muted:#6b7280;
  --border:rgba(148,163,184,0.35);
}

body{
  margin:0;
  font-family:system-ui,-apple-system;
  min-height:100vh;
  background:
    radial-gradient(circle at 0% 0%, rgba(59,130,246,0.12) 0, transparent 55%),
    radial-gradient(circle at 100% 100%, rgba(56,189,248,0.16) 0, #e5e7eb 55%);
  padding:12px;
  color:var(--text);
}
*{box-sizing:border-box}
input, textarea, button{
  font-size:16px;
}

/* LOGIN */
.login-screen{
  position:fixed;
  inset:0;
  z-index:1000;
  display:flex;
  justify-content:center;
  align-items:center;
  background:radial-gradient(circle at 0% 0%, rgba(59,130,246,0.18) 0, transparent 55%),
             radial-gradient(circle at 100% 100%, rgba(236,72,153,0.16) 0, rgba(248,250,252,0.96) 55%);
}
.login-box{
  width:100%;
  max-width:360px;
  padding:24px 20px 20px;
  border-radius:28px;
  background:var(--card);
  backdrop-filter:blur(16px);
  -webkit-backdrop-filter:blur(16px);
  box-shadow:
    0 22px 60px rgba(15,23,42,0.25),
    0 0 0 1px rgba(148,163,184,0.40);
  color:var(--text);
  text-align:center;
  position:relative;
  overflow:hidden;
}
.login-box::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:
    radial-gradient(circle at 0% 0%, rgba(59,130,246,0.18) 0, transparent 55%),
    radial-gradient(circle at 100% 0%, rgba(236,72,153,0.20) 0, transparent 55%);
  opacity:0.45;
  pointer-events:none;
  mix-blend-mode:soft-light;
}
.login-box > *{
  position:relative;
  z-index:1;
}
.login-logo{
  width:120px;
  height:64px;
  margin:4px auto 14px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.login-logo img{
  max-width:100%;
  max-height:100%;
  object-fit:contain;
  display:block;
}
.login-box h3{
  margin:6px 0 4px;
  font-size:18px;
  font-weight:800;
}
.login-box p{
  font-size:12px;
  color:var(--muted);
  margin:0 0 12px;
}
.login-box input{
  width:100%;
  padding:11px;
  margin-top:9px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(248,250,252,0.9);
  color:var(--text);
  transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
}
.login-box input::placeholder{color:#9ca3af}
.login-box input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
  background:#ffffff;
}
.login-btn{
  width:100%;
  margin-top:16px;
  padding:11px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#2563eb,#7c3aed);
  color:#ffffff;
  cursor:pointer;
  font-weight:700;
  letter-spacing:0.3px;
  box-shadow:
    0 14px 32px rgba(37,99,235,0.55),
    0 0 0 1px rgba(129,140,248,0.65);
  transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
}
.login-btn:hover{
  transform:translateY(-1px);
  box-shadow:
    0 18px 40px rgba(37,99,235,0.6),
    0 0 0 1px rgba(129,140,248,0.8);
}
.login-btn:active{
  transform:translateY(1px) scale(0.99);
  box-shadow:0 6px 18px rgba(37,99,235,0.45);
}
#loginError{
  margin-top:8px;
  font-size:12px;
  color:#dc2626;
}
#loginLoading{
  display:none;
  margin-top:6px;
  font-size:11px;
  color:#6b7280;
}
#buildInfo{
  margin-top:10px;
  font-size:11px;
  color:#9ca3af;
}

/* MAIN MENU */
#mainScreen{
  display:none;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.main-card{
  width:100%;
  max-width:380px;
  background:#0f172a;
  border-radius:28px;
  padding:18px 16px 16px;
  box-shadow:
    0 24px 55px rgba(15,23,42,0.5),
    0 0 0 1px rgba(15,23,42,0.8);
  color:#e5e7eb;
  position:relative;
  overflow:hidden;
}

.main-card::before{
  content:"";
  position:absolute;
  inset:0;
  background:none;
  opacity:1;
  pointer-events:none;
}

.main-card > *{
  position:relative;
  z-index:1;
}

.main-logout-btn{
  position:absolute;
  top:12px;
  left:12px;
  background:rgba(255,255,255,0.15);
  color:#ffffff;
  border:none;
  border-radius:8px;
  padding:6px 10px;
  font-size:11px;
  cursor:pointer;
  transition:background .12s ease;
  z-index:2;
}

.main-logout-btn:hover{
  background:rgba(255,255,255,0.25);
}

.main-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  margin-bottom:12px;
}

.main-title{
  font-size:18px;
  font-weight:800;
  color:#ffffff;
}

.main-sub{
  font-size:11px;
  color:#cbd5f5;
}

.main-greeting{
  font-size:12px;
  color:#a5b4fc;
  margin-top:4px;
}

.main-badge{
  font-size:11px;
  background:#1d4ed8;
  color:#e5e7eb;
  padding:4px 10px;
  border-radius:999px;
  box-shadow:0 0 0 1px rgba(37,99,235,0.7);
}

.main-list{
  margin-top:4px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.main-btn{
  width:100%;
  border:none;
  border-radius:18px;
  padding:10px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
  background:#1d4ed8;
  color:#f9fafb;
  box-shadow:0 4px 12px rgba(15,23,42,0.4);
  transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
}

.main-btn span.left{
  display:flex;
  align-items:center;
  gap:10px;
}

.main-icon{
  width:32px;
  height:32px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  background:rgba(15,23,42,0.25);
  color:#f9fafb;
  box-shadow:none;
}

.main-arrow{
  font-size:13px;
  color:#e5e7eb;
  font-weight:600;
}

.main-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 22px rgba(15,23,42,0.6);
  background:#2563eb;
}

.main-btn.primary{
  background:#1d4ed8;
  color:#ffffff;
  box-shadow:0 14px 30px rgba(15,23,42,0.6);
}

.main-btn.primary .main-icon{
  background:rgba(15,23,42,0.25);
  color:#ffffff;
}

.main-btn.primary .main-arrow{
  color:#e5e7eb;
}

/* APP TOP */
#appScreen{
  display:none;
}

.top-bar{
  max-width:430px;
  margin:0 auto 6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:var(--text);
}

.top-title{
  font-weight:700;
  font-size:15px;
}

.top-actions{
  display:flex;
  gap:6px;
  align-items:center;
}

.icon-btn{
  border:none;
  border-radius:999px;
  padding:6px 12px;
  background:rgba(255,255,255,0.92);
  color:#0f172a;
  box-shadow:0 1px 4px rgba(148,163,184,.55);
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:4px;
  transition:background .12s ease, transform .12s ease, box-shadow .12s ease;
  font-size:13px;
}

.icon-btn:hover{
  background:#eff6ff;
  transform:translateY(-1px);
  box-shadow:0 4px 10px rgba(148,163,184,.55);
}

.icon-btn.small{
  padding:5px 8px;
  font-size:12px;
}

/* FILTER + RESULTS */
.filter-wrap,#results{
  max-width:430px;
  margin:0 auto 8px;
}

.filter-wrap{
  position:sticky;
  top:0;
  z-index:10;
}

.filter-card{
  background:var(--card);
  border-radius:16px;
  padding:8px;
  box-shadow:0 3px 10px rgba(148,163,184,.35);
  color:var(--text);
  backdrop-filter:blur(14px);
  -webkit-backdrop-filter:blur(14px);
  border:1px solid var(--border);
}

.filter-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
}

.filter-header strong{
  font-size:13px;
}

.clear-btn{
  font-size:12px;
  background:#e5e7eb;
  color:var(--text);
  border:none;
  border-radius:999px;
  padding:4px 10px;
  cursor:pointer;
  transition:background .12s ease, transform .12s ease;
}

.clear-btn:hover{
  background:#e0e7ff;
  transform:translateY(-1px);
}

.filter-row{
  display:flex;
  gap:6px;
  margin-bottom:6px;
}

.filter-input{
  flex:1;
  min-width:0;
  padding:7px 8px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#f9fafb;
  color:var(--text);
  font-size:14px;
  transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
}

.filter-input.small{
  flex:1 1 30%;
  padding:5px 6px;
  font-size:14px;
}

.filter-input::placeholder{color:#9ca3af}

.filter-input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
  background:#ffffff;
}

@media(max-width:480px){
  .filter-row{flex-wrap:wrap}
  .filter-input{flex:1 1 48%}
  .filter-input.small{flex:1 1 30%}
}

/* ITEM */
.item{
  background:var(--card);
  border-radius:16px;
  padding:9px 9px 10px;
  margin-bottom:7px;
  box-shadow:0 4px 12px rgba(148,163,184,.35);
  color:var(--text);
  border:1px solid rgba(226,232,240,0.9);
}

.part-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:8px;
}

.part{
  font-weight:700;
  color:var(--primary);
}

.part.ok{
  color:var(--ok);
}

.part.warn{
  color:var(--warn);
}

.location{
  font-size:12px;
  color:var(--muted);
}

.name{
  font-size:13px;
  margin-top:2px;
}

.meta{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
}

.status{
  font-size:12px;
  margin-top:4px;
}

/* ظ…ط¨ظٹط¹ط§طھ */
.sales-item .part.ok{
  color:var(--primary);
}

/* ط¥ط¨ط±ط§ط² ظپط±ظ‚ ظƒط¨ظٹط± */
.item[style*="border:2px solid"]{
  background:#fff7ed;
}

/* DETAIL */
.detail-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  z-index:9999;
}

.detail-card{
  width:100%;
  max-width:430px;
  background:var(--card);
  border-radius:18px 18px 0 0;
  padding:12px;
  color:var(--text);
  box-shadow:0 -8px 25px rgba(15,23,42,0.45);
  border-top:1px solid var(--border);
  max-height:90vh;
  overflow-y:auto;
}

.detail-header{
  display:flex;
  justify-content:space-between;
  font-weight:600;
  margin-bottom:10px;
}

.detail-close{
  border:none;
  background:none;
  font-size:18px;
  cursor:pointer;
  color:var(--muted);
}

.detail-label{
  font-size:12px;
  color:var(--muted);
  margin-top:10px;
  font-weight:600;
}

.detail-value{
  font-size:13px;
  color:var(--text);
  margin-top:4px;
  padding:8px;
  background:#f9fafb;
  border-radius:8px;
  border:1px solid var(--border);
}

.detail-qty-box{
  display:flex;
  gap:8px;
  margin-top:6px;
}

.detail-qty-box button{
  width:40px;
  border:none;
  border-radius:10px;
  font-size:20px;
  cursor:pointer;
  background:#e5e7eb;
  color:#0f172a;
  transition:background .12s ease, transform .12s ease;
}

.detail-qty-box button:hover{
  background:#dbeafe;
  transform:translateY(-1px);
}

.detail-qty-box input{
  flex:1;
  text-align:center;
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px;
  background:#f9fafb;
  color:var(--text);
}

.detail-qty-box input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
}

.detail-save{
  width:100%;
  margin-top:12px;
  padding:10px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#2563eb,#7c3aed);
  color:#fff;
  cursor:pointer;
  transition:opacity .12s ease, transform .12s ease, box-shadow .12s ease;
  box-shadow:
    0 12px 26px rgba(37,99,235,0.45),
    0 0 0 1px rgba(129,140,248,0.75);
}

.detail-save:hover:enabled{
  transform:translateY(-1px);
  box-shadow:
    0 16px 34px rgba(37,99,235,0.55),
    0 0 0 1px rgba(129,140,248,0.9);
}

#newLoc,#note{
  background:#f9fafb;
  border:1px solid var(--border);
  color:var(--text);
}

#newLoc:focus,#note:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
}

/* SCANNER */
#scannerContainer{
  display:none;
  max-width:430px;
  margin:6px auto;
  background:#020617;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 10px 28px rgba(15,23,42,0.65);
}

/* Success notification */
.success-notify{
  position:fixed;
  bottom:20px;
  left:20px;
  right:20px;
  max-width:400px;
  background:#16a34a;
  color:#fff;
  padding:12px 16px;
  border-radius:10px;
  box-shadow:0 8px 20px rgba(15,23,42,0.4);
  animation:slideUp .3s ease;
  z-index:9998;
}

/* Update indicator */
.update-badge{
  position:fixed;
  top:12px;
  right:12px;
  background:#2563eb;
  color:#fff;
  padding:6px 12px;
  border-radius:999px;
  font-size:11px;
  font-weight:600;
  box-shadow:0 4px 12px rgba(37,99,235,0.5);
  animation:pulse .6s ease infinite;
  z-index:100;
}

@keyframes pulse{
  0%,100%{opacity:1;transform:scale(1)}
  50%{opacity:0.8;transform:scale(1.05)}
}

.conflict-notify{
  position:fixed;
  bottom:20px;
  left:20px;
  right:20px;
  max-width:400px;
  background:#dc2626;
  color:#fff;
  padding:12px 16px;
  border-radius:10px;
  box-shadow:0 8px 20px rgba(15,23,42,0.4);
  animation:slideUp .3s ease;
  z-index:9998;
}

@keyframes slideUp{
  from{
    opacity:0;
    transform:translateY(20px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

/* SALES DETAIL MODAL */
.sales-detail-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  z-index:9999;
}

.sales-detail-card{
  width:100%;
  max-width:430px;
  background:var(--card);
  border-radius:18px 18px 0 0;
  padding:12px;
  color:var(--text);
  box-shadow:0 -8px 25px rgba(15,23,42,0.45);
  border-top:1px solid var(--border);
  max-height:90vh;
  overflow-y:auto;
}

.sales-detail-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:600;
  margin-bottom:12px;
  padding-bottom:10px;
  border-bottom:1px solid var(--border);
}

.sales-detail-close{
  border:none;
  background:none;
  font-size:18px;
  cursor:pointer;
  color:var(--muted);
}

.info-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
  padding:8px;
  background:#f9fafb;
  border-radius:8px;
  font-size:13px;
}

.info-label{
  font-weight:600;
  color:var(--muted);
}

.info-value{
  color:var(--text);
  font-weight:700;
}

.price-section{
  margin-top:16px;
  padding:12px;
  background:#eff6ff;
  border-radius:12px;
  border:1px solid rgba(37,99,235,0.3);
}

.price-input-group{
  margin-top:12px;
}

.price-input-group label{
  display:block;
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
  font-weight:600;
}

.price-input-group input{
  width:100%;
  padding:10px;
  border:1px solid var(--border);
  border-radius:10px;
  background:#fff;
  color:var(--text);
  font-size:14px;
}

.price-input-group input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
}

.calc-results{
  margin-top:12px;
  padding:10px;
  background:#ffffff;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:12px;
}

.calc-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
  padding:6px 0;
}

.calc-row:last-child{
  margin-bottom:0;
  padding-top:8px;
  border-top:2px solid var(--border);
  font-weight:700;
  font-size:13px;
}

.calc-label{
  color:var(--muted);
}

.calc-value{
  color:var(--text);
  font-weight:700;
  text-align:left;
}

.no-calc{
  color:var(--muted);
  text-align:center;
  padding:10px;
  font-size:12px;
}

/* CART MODAL */
.cart-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  z-index:9999;
}

.cart-card{
  width:100%;
  max-width:430px;
  background:var(--card);
  border-radius:18px 18px 0 0;
  padding:12px;
  color:var(--text);
  box-shadow:0 -8px 25px rgba(15,23,42,0.45);
  border-top:1px solid var(--border);
  max-height:90vh;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
}

.cart-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:600;
  margin-bottom:12px;
  padding-bottom:10px;
  border-bottom:1px solid var(--border);
}

.cart-close{
  border:none;
  background:none;
  font-size:18px;
  cursor:pointer;
  color:var(--muted);
}

.cart-table-wrapper{
  flex:1;
  overflow-y:auto;
  margin-bottom:12px;
  max-height:45vh;
}

.cart-table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}

.cart-table thead th{
  background:#eff6ff;
  color:var(--primary);
  padding:8px 4px;
  text-align:right;
  font-weight:700;
  border-bottom:2px solid rgba(37,99,235,0.3);
  position:sticky;
  top:0;
}

.cart-table-header-num,
.cart-table-header-part,
.cart-table-header-desc,
.cart-table-header-qty,
.cart-table-header-price,
.cart-table-header-remove{
  padding:8px 4px;
  text-align:right;
}

.cart-table-header-num{width:30px}
.cart-table-header-part{width:50px}
.cart-table-header-desc{flex:1;min-width:80px}
.cart-table-header-qty{width:50px}
.cart-table-header-price{width:60px}
.cart-table-header-remove{width:30px}

.cart-table tbody tr{
  border-bottom:1px solid var(--border);
}

.cart-table td{
  padding:6px 4px;
  vertical-align:top;
}

.cart-table-num{
  text-align:center;
  color:var(--muted);
  font-weight:600;
}

.cart-table-part{
  font-weight:700;
  color:var(--primary);
}

.cart-table-desc{
  color:var(--muted);
  font-size:11px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.cart-table-qty-cell,
.cart-table-price-cell{
  text-align:center;
}

.cart-table-qty-input{
  width:45px;
  padding:4px 2px;
  text-align:center;
  border:1px solid var(--border);
  border-radius:4px;
  font-size:11px;
  -moz-appearance:textfield;
}

.cart-table-qty-input::-webkit-inner-spin-button,
.cart-table-qty-input::-webkit-outer-spin-button{
  -webkit-appearance:none;
  margin:0;
}

.cart-table-price-input{
  width:55px;
  padding:4px 2px;
  text-align:center;
  border:1px solid var(--border);
  border-radius:4px;
  font-size:11px;
  -moz-appearance:textfield;
}

.cart-table-price-input::-webkit-inner-spin-button,
.cart-table-price-input::-webkit-outer-spin-button{
  -webkit-appearance:none;
  margin:0;
}

.cart-empty{
  text-align:center;
  color:var(--muted);
  padding:30px 10px;
  font-size:13px;
}

.cart-totals{
  margin-top:auto;
  padding:12px;
  background:#eff6ff;
  border-radius:12px;
  border:1px solid rgba(37,99,235,0.3);
  font-size:12px;
}

.total-row{
  display:flex;
  justify-content:space-between;
  padding:8px 0;
  border-bottom:1px solid rgba(37,99,235,0.2);
}

.total-row:last-child{
  border-bottom:none;
  padding-top:10px;
  border-top:2px solid rgba(37,99,235,0.3);
  font-weight:700;
  color:var(--primary);
  font-size:13px;
}

.cart-actions{
  display:flex;
  gap:8px;
  margin-top:12px;
}

.cart-clear-btn{
  flex:1;
  padding:10px;
  border:1px solid var(--border);
  border-radius:999px;
  background:#fff;
  color:var(--text);
  cursor:pointer;
  font-weight:600;
  transition:background .12s ease;
}

.cart-clear-btn:hover{
  background:#f9fafb;
}

.cart-checkout-btn{
  flex:1;
  padding:10px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#16a34a,#15803d);
  color:#fff;
  cursor:pointer;
  font-weight:600;
  transition:transform .12s ease, box-shadow .12s ease;
  box-shadow:0 4px 12px rgba(22,163,74,0.3);
}

.cart-checkout-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 8px 18px rgba(22,163,74,0.4);
}

.cart-badge{
  position:absolute;
  top:-8px;
  right:-8px;
  background:#dc2626;
  color:#fff;
  border-radius:999px;
  width:24px;
  height:24px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  font-weight:700;
}

/* Active Item Profit Panel */
.active-item-panel{
  padding:10px;
  background:#eff6ff;
  border-radius:10px;
  border:2px solid #2563eb;
  margin-bottom:10px;
  display:none;
}

.active-item-panel-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}

.active-item-panel-header strong{
  color:#2563eb;
}

.active-item-panel-badge{
  font-size:11px;
  background:#2563eb;
  color:white;
  padding:2px 8px;
  border-radius:10px;
}

.active-item-panel-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  font-size:12px;
}

.active-item-panel-cell{
  background:white;
  padding:6px;
  border-radius:6px;
}

.active-item-panel-footer{
  margin-top:8px;
  padding-top:8px;
  border-top:1px dashed #94a3b8;
}
</style>
</head>

<body>

<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <img src="logo.png.gif" alt="">
    </div>

    <h3>ط´ط±ظƒط© ط§ظ„ظ‚ط§ط¶ظٹ ظ„ط¨ظٹط¹ ظ‚ط·ط¹ ط؛ظٹط§ط± ط§ظ„ط³ظٹط§ط±ط§طھ</h3>
    <p>ظپط¶ظ„ط§ظ‹ ط£ط¯ط®ظ„ ط§ط³ظ… ط§ظ„ظ…ط³طھط®ط¯ظ… ظˆط§ظ„ط±ظ‚ظ… ط§ظ„ط³ط±ظٹ</p>

    <input id="loginUser" placeholder="ط§ط³ظ… ط§ظ„ظ…ط³طھط®ط¯ظ…">
    <input id="loginPass" type="password" placeholder="ط§ظ„ط±ظ‚ظ… ط§ظ„ط³ط±ظٹ">

    <button class="login-btn" onclick="login()">ط¯ط®ظˆظ„</button>
    <div id="loginLoading">ط¬ط§ط±ظٹ ط§ظ„طھط­ظ‚ظ‚...</div>
    <div id="loginError"></div>
    <div id="buildInfo"></div>
  </div>
</div>

<div id="mainScreen">
  <div class="main-card">
    <button class="main-logout-btn" onclick="logoutUser()">طھط³ط¬ظٹظ„ ط®ط±ظˆط¬</button>
    
    <div class="main-header">
      <div>
        <div class="main-title">ط§ظ„ظ‚ط§ط¦ظ…ط© ط§ظ„ط±ط¦ظٹط³ظٹط©</div>
        <div class="main-sub">ط§ط®طھط± ط§ظ„ط¹ظ…ظ„ظٹط© ط§ظ„ظ…ط·ظ„ظˆط¨ط©</div>
        <div class="main-greeting" id="userGreeting"></div>
      </div>
      <div class="main-badge">ظ†ط¸ط§ظ… ط§ظ„ط¬ط±ط¯ ظˆط§ظ„ظ…ط¨ظٹط¹ط§طھ</div>
    </div>

    <div class="main-list">
      <button class="main-btn" onclick="openMenu(2)">
        <span class="left">
          <span class="main-icon">ًںڑ—</span>
          <span>ط¨ط¶ط§ط¹ط© ط´ط±ظƒط© طھظˆظٹظˆطھط§</span>
        </span>
        <span class="main-arrow">â€؛</span>
      </button>

      <button class="main-btn primary" onclick="openMenu(3)">
        <span class="left">
          <span class="main-icon">ًں“‹</span>
          <span>ط§ظ„ط¬ط±ط¯ ط§ظ„ظ…ط®ط²ظ†ظٹ </span>
        </span>
        <span class="main-arrow">â€؛</span>
      </button>

      <button class="main-btn" onclick="openSalesMenu()">
        <span class="left">
          <span class="main-icon">ًں’°</span>
          <span>ظ…ط¨ظٹط¹ط§طھ</span>
        </span>
        <span class="main-arrow">â€؛</span>
      </button>
    </div>

  </div>
</div>

<div id="appScreen">

  <div class="top-bar">
    <div class="top-title" id="topTitle">ط§ظ„ط¬ط±ط¯ ط§ظ„ظ…ط®ط²ظ†ظٹ </div>
    <div class="top-actions">
      <button class="icon-btn small" id="cartBtn" onclick="openCart()" title="ط¹ط±ط¨ط© ط§ظ„ظ…ط¨ظٹط¹ط§طھ" style="display:none;position:relative">
        ًں›’
        <span class="cart-badge" id="cartCount" style="display:none">0</span>
      </button>
      <button class="icon-btn small" id="refreshBtn" onclick="refreshCurrentView()" title="طھط­ط¯ظٹط« ظٹط¯ظˆظٹ">ًں”„</button>
      <button class="icon-btn" onclick="backToMain()">ط¹ظˆط¯ط©</button>
    </div>
  </div>

  <div class="filter-wrap">
    <div class="filter-card">

      <div class="filter-header">
        <strong>ط§ظ„ط¨ط­ط« ط§ظ„ظ…طھظ‚ط¯ظ…</strong>
        <button class="clear-btn" onclick="clearFilters()">ظ…ط³ط­ âœ•</button>
      </div>

      <div class="filter-row" style="margin-bottom:6px">
        <select id="branchFilter" class="filter-input small" required>
          <option value="" disabled selected>ط§ط®طھط± ط§ظ„ظپط±ط¹</option>
          <option value="*">ظƒظ„ ط§ظ„ظپط±ظˆط¹</option>
          <option value="ظ…ط³طھظˆط¯ط¹ ط§ظ„ط±ط¦ظٹط³ظٹ">ط§ظ„ظپط±ط¹ ط§ظ„ط§ظˆظ„</option>
          <option value="ط§ظ„ظپط±ط¹ ط§ظ„ط«ط§ظ†ظٹ">ط§ظ„ظپط±ط¹ ط§ظ„ط«ط§ظ†ظٹ</option>
          <option value="ط§ظ„ظپط±ط¹ ط§ظ„ط«ط§ظ„ط«">ط§ظ„ظپط±ط¹ ط§ظ„ط«ط§ظ„ط«</option>
          <option value="ظ…ط³طھظˆط¯ط¹ ظپط±ط¹ 3">ظ…ط³طھظˆط¯ط¹ ظپط±ط¹ 3</option>
        </select>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:6px;margin:4px 0 6px;font-size:11px" id="countStateWrap">
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="all" checked style="margin:0">
          <span>ط§ظ„ظƒظ„</span>
        </label>
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="counted" style="margin:0">
          <span>ط§ظ„ظ…ط¬ط±ط¯</span>
        </label>
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="diff" style="margin:0">
          <span>ظپظٹظ‡ ظپط±ظ‚</span>
        </label>
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="not" style="margin:0">
          <span>ط؛ظٹط± ظ…ط¬ط±ط¯</span>
        </label>
      </div>

      <div class="filter-row">
        <input id="pContains" class="filter-input" placeholder="ط±ظ‚ظ… ط§ظ„طµظ†ظپ ظٹط­طھظˆظٹ">
        <input id="pEnds" class="filter-input" placeholder="ظٹظ†طھظ‡ظٹ ط¨ظ€">
      </div>

      <div class="filter-row">
        <input id="nStarts" class="filter-input" placeholder="ط§ط³ظ… ظٹط¨ط¯ط£">
        <input id="nContains" class="filter-input" placeholder="ظٹط­طھظˆظٹ">
      </div>

      <div class="filter-row">
        <input id="locFrom" class="filter-input small" placeholder="ط§ظ„ظ…ظˆظ‚ط¹ ظ…ظ†">
        <input id="locTo"   class="filter-input small" placeholder="ط¥ظ„ظ‰">
        <div style="display:flex;gap:4px;flex:1 1 30%;align-items:center">
          <input id="barcode" class="filter-input small" placeholder="ط¨ط§ط±ظƒظˆط¯">
          <button type="button"
                  id="scanBtn"
                  style="border:none;background:#2563eb;color:#fff; padding:5px 8px;border-radius:8px;cursor:pointer;">
            ًں“·
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="scannerContainer">
    <div id="reader" style="width:100%;"></div>
    <button type="button"
            onclick="stopScan()"
            style="width:100%;border:none;background:#eee;padding:6px; font-size:14px;cursor:pointer">
      ط¥ط؛ظ„ط§ظ‚ ط§ظ„ظƒط§ظ…ظٹط±ط§
    </button>
  </div>

  <div id="results"></div>
  <div id="salesLoading"
       style="display:none;text-align:center;font-size:13px;color:#6b7280;margin:8px 0;">
    ط¬ط§ط±ظٹ طھط­ظ…ظٹظ„ ط¨ظٹط§ظ†ط§طھ ط§ظ„ظ…ط¨ظٹط¹ط§طھ...
  </div>

</div>

<audio id="beepAudio">
  <source src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUAAAAA=" type="audio/wav">
</audio>

<script>
document.getElementById("buildInfo").textContent =
  "ط¢ط®ط± طھط­ط¯ظٹط« ظ„ظ„ظ…ظ„ظپ: " +
  new Date(document.lastModified).toLocaleString("ar-SA");

let CURRENT_VIEW = "inventory";
const API="https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";

let ALL_DATA = [];
let SALES_DATA = [];
let LAST_RENDER = [];
let CURRENT_USER = "";
let CURRENT_ROLE = "";
let loadingInterval = null;
let AUTO_REFRESH = null;
let CURRENT_DETAIL_PART   = null;
let CURRENT_DETAIL_BRANCH = null;
let LAST_SYNC_TIME = 0;
let SYNC_INTERVAL = 30000; // 30 ط«ط§ظ†ظٹط©
let JUST_UPDATED = false;
let SALES_CART = [];
let ACTIVE_CART_ITEM = null;

// ط§ط³طھط±ط¬ط§ط¹ ط§ظ„ط¬ظ„ط³ط©
window.addEventListener("load", () => {
  try {
    const savedUser = localStorage.getItem("stockUser");
    const savedRole = localStorage.getItem("stockRole");
    if (savedUser && savedRole) {
      CURRENT_USER = savedUser;
      CURRENT_ROLE = savedRole;
      loginScreen.style.display = "none";
      mainScreen.style.display = "flex";
      updateGreeting();
      if (!ALL_DATA || ALL_DATA.length === 0) {
        loadInventoryAfterLogin();
      }
    }
  } catch (e) {}
});

/* ظ…ظ†ط¹ ط§ظ„ط²ظˆظˆظ… */
document.addEventListener("gesturestart", function (e) { e.preventDefault(); }, { passive: false });
let lastTouchEnd = 0;
document.addEventListener("touchend", function (e) {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) { e.preventDefault(); }
  lastTouchEnd = now;
}, { passive: false });

/* ظ…ظ†ط¹ ط§ظ„ط³ط­ط¨ ظ„ظ„ط£ط³ظپظ„ */
let lastTouchY = 0;
let preventPullToRefresh = false;
function enablePullBlock(){ preventPullToRefresh = true; }
window.addEventListener("touchstart", function(e){
  if(!preventPullToRefresh) return;
  if(e.touches.length !== 1) return;
  lastTouchY = e.touches[0].clientY;
}, {passive:false});
window.addEventListener("touchmove", function(e){
  if(!preventPullToRefresh) return;
  if(window.scrollY > 0) return;
  const touchY = e.touches[0].clientY;
  const deltaY = touchY - lastTouchY;
  lastTouchY = touchY;
  if(deltaY > 0) e.preventDefault();
}, {passive:false});

/* طµظˆطھ */
function playBeep(){
  const a = document.getElementById("beepAudio");
  if(!a) return;
  a.currentTime = 0;
  a.play().catch(()=>{});
}

/* طھط±ط­ظٹط¨ ط§ظ„ظ…ط³طھط®ط¯ظ… */
function updateGreeting(){
  const greeting = document.getElementById("userGreeting");
  if(greeting){
    const hour = new Date().getHours();
    let greeting_text = "طµط¨ط§ط­ ط§ظ„ط®ظٹط±";
    if(hour >= 12 && hour < 18) greeting_text = "ظ…ط³ط§ط، ط§ظ„ط®ظٹط±";
    if(hour >= 18) greeting_text = "ظ…ط³ط§ط، ط§ظ„ط®ظٹط±";
    greeting.textContent = greeting_text + " " + CURRENT_USER;
  }
}

// ظ…ط¹ط§ط¯ظ„ط© طھظ†ط¸ظٹظپ ط§ظ„ط¨ط§ط±ظƒظˆط¯ ط§ظ„ظ…ط­ط³ظ†ط© (طھطھط¬ط§ظ‡ظ„ ط§ظ„ط¨ط§ط¯ط¦ط§طھ ظˆطھظ‚طµ ط¹ظ„ظ‰ 10 ط£ط±ظ‚ط§ظ…)
function cleanBarcode(text) {
  if (!text) return "";
  
  let val = String(text).trim();
  if (!val) return "";
  
  // ط§ظ„ط®ط·ظˆط© 1: ط¥ط²ط§ظ„ط© ط§ظ„ط´ط±ط·ط§طھ ط§ظ„ظ…ط§ط¦ظ„ط© ظ…ظ† ط§ظ„ط¨ط¯ط§ظٹط©
  while (val.startsWith('/')) {
    val = val.substring(1).trim();
  }
  
  // ط§ظ„ط®ط·ظˆط© 2: ط¥ط°ط§ ظƒط§ظ† ظپظٹظ‡ ط› (CSV)طŒ ط§ط³طھط®ط±ط¬ ط£ظˆظ„ ط¬ط²ط، ظپظٹظ‡ ط£ط±ظ‚ط§ظ…
  if (val.includes(';')) {
    const parts = val.split(';');
    for (const part of parts) {
      const p = part.trim();
      if (p && /\d/.test(p)) {
        val = p;
        break;
      }
    }
  }
  
  // ط§ظ„ط®ط·ظˆط© 3: ط§ط³طھط®ط±ط¬ ط­طھظ‰ ط£ظˆظ„ ظپط±ط§ط؛
  let core = "";
  for (const char of val) {
    if (char === ' ' || char === '\t') break;
    core += char;
  }
  
  // ط§ظ„ط®ط·ظˆط© 4: ط¥ط²ط§ظ„ط© ظƒظ„ ط§ظ„ط´ط±ط·ط§طھ ظ…ظ† ط§ظ„ط¨ط¯ط§ظٹط©
  while (core.startsWith('-')) {
    core = core.substring(1);
  }
  
  // ط§ظ„ط®ط·ظˆط© 5: طھط¬ط§ظ‡ظ„ ط§ظ„ط¨ط§ط¯ط¦ط§طھ ط§ظ„ظ…ط¹ط±ظˆظپط© (ط­ط±ظپظٹظ† + ط´ط±ط·ط©)
  const knownPrefixes = ['MZ-', 'TO-', 'HO-', 'DA-', 'NS-', 'MS-', 'SU-', 'MI-', 'FU-', 'HY-'];
  for (const prefix of knownPrefixes) {
    if (core.toUpperCase().startsWith(prefix)) {
      core = core.substring(prefix.length);
      break;
    }
  }
  
  // ط£ظˆ ط¥ط°ط§ ظƒط§ظ†طھ ط§ظ„ط¨ط§ط¯ط¦ط© ط­ط±ظپظٹظ† ظپظ‚ط· + ط´ط±ط·ط© (ط¨ط¯ظˆظ† ظ‚ط§ط¦ظ…ط©)
  if (core.length > 3 && core[2] === '-' && /^[A-Z]{2}/.test(core)) {
    core = core.substring(3);
  }
  
  // ط§ظ„ط®ط·ظˆط© 6: ط¥ط²ط§ظ„ط© ط§ظ„ط´ط±ط·ط§طھ ظ…ظ† ط§ظ„ظ†ظ‡ط§ظٹط©
  while (core.endsWith('-')) {
    core = core.substring(0, core.length - 1);
  }
  
  // â­گ ط§ظ„ط®ط·ظˆط© 7 ط§ظ„ط¬ط¯ظٹط¯ط©: ط§ط³طھط®ط±ط§ط¬ ط£ظˆظ„ 10 ط£ط±ظ‚ط§ظ… ظپظ‚ط·
  let digits = "";
  for (const char of core.trim()) {
    if (/\d/.test(char)) {
      digits += char;
      if (digits.length === 10) break; // طھظˆظ‚ظپ ط¨ط¹ط¯ 10 ط£ط±ظ‚ط§ظ…
    }
  }
  
  // ظ„ظˆ ط£ط·ظˆظ„ ظ…ظ† 10 ط£ط±ظ‚ط§ظ… â†’ طھط±ط¬ط¹ ظپط§ط±ط؛ (ظ„ط§ طھط·ط§ط¨ظ‚ ط§ظ„ط¨ط­ط«)
  if (digits.length > 10) {
    return "";
  }
  
  return digits;
}

/* LOGIN */
function login(){
  loginError.textContent="";
  loginLoading.style.display="block";
  loginLoading.textContent = "ط¬ط§ط±ظٹ ط§ظ„طھط­ظ‚ظ‚ ظ…ظ† ط§ظ„ط¨ظٹط§ظ†ط§طھ...";
  const user = loginUser.value.trim();
  const pass = loginPass.value.trim();

  if(!user || !pass){
    loginLoading.style.display="none";
    loginError.textContent="ظپط¶ظ„ط§ظ‹ ط£ط¯ط®ظ„ ط§ط³ظ… ط§ظ„ظ…ط³طھط®ط¯ظ… ظˆط§ظ„ط±ظ‚ظ… ط§ظ„ط³ط±ظٹ";
    return;
  }

  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({ name: user, pass: pass })
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.ok){
      loginLoading.style.display="none";
      loginError.textContent = res.error || "ظپط´ظ„ طھط³ط¬ظٹظ„ ط§ظ„ط¯ط®ظˆظ„";
      return;
    }
    CURRENT_USER = res.user && res.user.name ? res.user.name : user;
    CURRENT_ROLE = res.user && res.user.role ? res.user.role : "User";
    try {
      localStorage.setItem("stockUser", CURRENT_USER);
      localStorage.setItem("stockRole", CURRENT_ROLE);
    } catch (e) {}
    enablePullBlock();
    loginLoading.textContent = "ط¬ط§ط±ظٹ طھط­ظ…ظٹظ„ ط¨ظٹط§ظ†ط§طھ ط§ظ„ظ…ط®ط²ظˆظ† 0%...";
    loadInventoryAfterLogin();
  })
  .catch(()=>{
    loginLoading.style.display="none";
    loginError.textContent="طھط¹ط°ط± ط§ظ„ط§طھطµط§ظ„ ط¨ط§ظ„ط³ظٹط±ظپط±";
  });
}

function backToMain(){
  appScreen.style.display = "none";
  mainScreen.style.display = "flex";
  updateGreeting();
}

function loadInventoryAfterLogin(){
  let progress = 0;
  loginLoading.style.display = "block";
  loginLoading.textContent = "ط¬ط§ط±ظٹ طھط­ظ…ظٹظ„ ط¨ظٹط§ظ†ط§طھ ط§ظ„ظ…ط®ط²ظˆظ† 0%...";
  loadingInterval = setInterval(()=>{
    if(progress < 95){
      progress += 3;
      loginLoading.textContent = "ط¬ط§ط±ظٹ طھط­ظ…ظٹظ„ ط¨ظٹط§ظ†ط§طھ ط§ظ„ظ…ط®ط²ظˆظ† " + progress + "%...";
    }
  }, 150);
  fetch(API + "?mode=inventory")
    .then(r => r.json())
    .then(d => {
      ALL_DATA = Array.isArray(d) ? d : [];
      SALES_DATA = Array.isArray(ALL_DATA) ? ALL_DATA.slice() : [];
      LAST_SYNC_TIME = Date.now();
      if(loadingInterval) clearInterval(loadingInterval);
      loginLoading.textContent = "ط¬ط§ط±ظٹ طھط­ظ…ظٹظ„ ط¨ظٹط§ظ†ط§طھ ط§ظ„ظ…ط®ط²ظˆظ† 100%...";
      setTimeout(()=>{
        loginScreen.style.display="none";
        loginLoading.style.display="none";
        mainScreen.style.display="flex";
        updateGreeting();
        startAutoSync();
      }, 400);
    })
    .catch(() => {
      if(loadingInterval) clearInterval(loadingInterval);
      loginLoading.style.display="none";
      loginError.textContent = "ظپط´ظ„ طھط­ظ…ظٹظ„ ط¨ظٹط§ظ†ط§طھ ط§ظ„ظ…ط®ط²ظˆظ†";
    });
}

/* طھط²ط§ظ…ظ† طھظ„ظ‚ط§ط¦ظٹ */
function startAutoSync(){
  if(AUTO_REFRESH) clearInterval(AUTO_REFRESH);
  AUTO_REFRESH = setInterval(()=>{
    if(CURRENT_VIEW === "inventory"){
      autoRefreshData("inventory");
    } else if(CURRENT_VIEW === "sales"){
      autoRefreshData("sales");
    }
  }, SYNC_INTERVAL);
}

function autoRefreshData(mode){
  const now = Date.now();
  if(now - LAST_SYNC_TIME < SYNC_INTERVAL) return;
  
  fetch(API + "?mode=" + mode)
    .then(r => r.json())
    .then(d => {
      if(!d || !Array.isArray(d)) return;
      
      let hasChanges = false;
      
      if(mode === "inventory"){
        // ظ…ظ‚ط§ط±ظ†ط© ط§ظ„ط¨ظٹط§ظ†ط§طھ
        if(d.length !== ALL_DATA.length){
          hasChanges = true;
        } else {
          for(let i = 0; i < d.length; i++){
            if(JSON.stringify(d[i]) !== JSON.stringify(ALL_DATA[i])){
              hasChanges = true;
              break;
            }
          }
        }
        
        if(hasChanges){
          ALL_DATA = d.slice();
          LAST_SYNC_TIME = now;
          runSearchInventory();
          showUpdateIndicator();
        }
      } else if(mode === "sales"){
        if(d.length !== SALES_DATA.length){
          hasChanges = true;
        } else {
          for(let i = 0; i < d.length; i++){
            if(JSON.stringify(d[i]) !== JSON.stringify(SALES_DATA[i])){
              hasChanges = true;
              break;
            }
          }
        }
        
        if(hasChanges){
          SALES_DATA = d.slice();
          LAST_SYNC_TIME = now;
          runSearchSales();
          showUpdateIndicator();
        }
      }
    })
    .catch(() => {});
}

function showUpdateIndicator(){
  if(JUST_UPDATED) return;
  JUST_UPDATED = true;
  
  const badge = document.createElement("div");
  badge.className = "update-badge";
  badge.textContent = "âœ“ طھظ… طھط­ط¯ظٹط« ط§ظ„ط¨ظٹط§ظ†ط§طھ";
  document.body.appendChild(badge);
  
  setTimeout(()=>{
    badge.remove();
    JUST_UPDATED = false;
  }, 3500);
}

/* طھط­ط¯ظٹط« ظٹط¯ظˆظٹ */
function refreshCurrentView(){
  const refreshBtn = document.getElementById("refreshBtn");
  refreshBtn.style.transform = "rotate(360deg)";
  refreshBtn.style.transition = "transform .6s ease";
  
  const mode = (CURRENT_VIEW === "sales") ? "sales" : "inventory";
  fetch(API + "?mode=" + mode)
    .then(r => r.json())
    .then(d => {
      if (!d || !Array.isArray(d)) return;
      if (mode === "sales") {
        SALES_DATA = d.slice();
        runSearchSales();
      } else {
        ALL_DATA = d.slice();
        runSearchInventory();
      }
      showNotification("طھظ… طھط­ط¯ظٹط« ط§ظ„ط¨ظٹط§ظ†ط§طھ ط¨ظ†ط¬ط§ط­");
      setTimeout(() => {
        refreshBtn.style.transform = "rotate(0deg)";
      }, 600);
    })
    .catch(() => {
      setTimeout(() => {
        refreshBtn.style.transform = "rotate(0deg)";
      }, 600);
    });
}

function openMenu(id){
  if(id === 3){
    CURRENT_VIEW = "inventory";
    document.getElementById("topTitle").textContent = "ط§ظ„ط¬ط±ط¯ ط§ظ„ظ…ط®ط²ظ†ظٹ";
    countStateWrap.style.display = "flex";
    document.getElementById("scanBtn").disabled = false;
    mainScreen.style.display = "none";
    appScreen.style.display  = "block";
    runSearchInventory();
  }else{
    alert("ظ‡ط°ظ‡ ط§ظ„ظ‚ط§ط¦ظ…ط© ظ„ظ… طھظپط¹ظ„");
  }
}

function openSalesMenu(){
  CURRENT_VIEW = "sales";
  document.getElementById("topTitle").textContent = "ظ…ط¨ظٹط¹ط§طھ";
  countStateWrap.style.display = "none";
  document.getElementById("scanBtn").disabled = true;
  mainScreen.style.display = "none";
  appScreen.style.display  = "block";
  
  // طھط­ظ…ظٹظ„ ط³ط±ظٹط¹ ظ…ظ† ط§ظ„ط°ط§ظƒط±ط© ط£ظˆظ„ط§ظ‹
  if(SALES_DATA && SALES_DATA.length > 0){
    runSearchSales();
  } else {
    const loadingEl = document.getElementById("salesLoading");
    if(loadingEl) loadingEl.style.display = "block";
    
    fetch(API + "?mode=sales")
      .then(r => r.json())
      .then(d => {
        if(d && Array.isArray(d)){
          SALES_DATA = d.slice();
          runSearchSales();
        }
        if(loadingEl) loadingEl.style.display = "none";
      })
      .catch(() => {
        if(loadingEl) loadingEl.style.display = "none";
        runSearchSales();
      });
  }
}

/* FILTERS */
let searchTimer = null;
document.querySelectorAll(".filter-input").forEach(inp=>{
  inp.addEventListener("input", ()=>{
    clearTimeout(searchTimer);
    searchTimer = setTimeout(()=>{
      if(CURRENT_VIEW === "inventory") runSearchInventory();
      else runSearchSales();
    }, 150);
  });
});

document.querySelectorAll('input[name="countState"]').forEach(r=>{
  r.addEventListener("change", ()=>{ if(CURRENT_VIEW === "inventory") runSearchInventory(); });
});

function clearFilters(){
  document.querySelectorAll(".filter-input").forEach(i=>{ if(i.id !== "branchFilter"){ i.value = ""; } });
  const allRadio = document.querySelector('input[name="countState"][value="all"]');
  if(allRadio) allRadio.checked = true;
  if(CURRENT_VIEW === "inventory"){ runSearchInventory(); }else{ runSearchSales(); }
}

/* ======= ط¨ط­ط« ط§ظ„ظ…ط®ط²ظˆظ† ======= */
function runSearchInventory(){
  const pc = (pContains.value || "").trim().toLowerCase();
  const pe = (pEnds.value || "").trim().toLowerCase();
  const ns = (nStarts.value || "").trim().toLowerCase();
  const nc = (nContains.value || "").trim().toLowerCase();
  const lfRaw = (locFrom.value || "").trim().toLowerCase();
  const ltRaw = (locTo.value || "").trim().toLowerCase();

  const bcInput = (barcode.value || "").trim();
  const bcNorm  = cleanBarcode(bcInput);

  const branchVal = (branchFilter.value || "").trim().toLowerCase();
  const stateEl = document.querySelector('input[name="countState"]:checked');
  const state = stateEl ? stateEl.value : "all";
  const hasLocFilter = !!(lfRaw || ltRaw);

  if(!branchVal){ results.innerHTML = ""; return; }

  const res = [];
  for(const r of ALL_DATA){
    const p  = String(r.part ?? "").toLowerCase();
    const n  = String(r.name ?? "").toLowerCase();
    const l  = String(r.location ?? "").toLowerCase();
    const br = String(r.branch ?? "").trim().toLowerCase();

    const bRaw = String(r.barcode ?? "");
    const bNormItem = cleanBarcode(bRaw);

    const hasCount = r.lastCountedAt && String(r.lastCountedAt).trim() !== "";
    const qtySysNum   = Number(r.qty ?? 0);
    const qtyCountNum = Number(r.lastCountQty ?? 0);
    const isEqual     = hasCount && qtySysNum === qtyCountNum;

    if(branchVal && branchVal !== "*" && br !== branchVal) continue;
    if(state === "counted" && !hasCount) continue;
    if(state === "diff"    && !(hasCount && !isEqual)) continue;
    if(state === "not"     && hasCount) continue;

    if(pc && !p.includes(pc)) continue;
    if(pe && !p.endsWith(pe)) continue;
    if(ns && !n.startsWith(ns)) continue;
    if(nc && !n.includes(nc)) continue;

    if(bcNorm && !bNormItem.includes(bcNorm)) continue;

    if(hasLocFilter){
      const lf = lfRaw || l; const lt = ltRaw || l;
      if(l < lf) continue; if(l > lt) continue;
    }
    res.push(r);
    if(res.length >= 100) break;
  }
  if(hasLocFilter){
    res.sort((a,b)=>{
      const la = String(a.location ?? "").toLowerCase();
      const lb = String(b.location ?? "").toLowerCase();
      if(la < lb) return -1; if(la > lb) return 1; return 0;
    });
  }
  LAST_RENDER = res;
  renderInventory(res);
}

/* ط¨ط­ط« ط§ظ„ظ…ط¨ظٹط¹ط§طھ */
function runSearchSales(){
  const q          = (pContains.value || "").trim().toLowerCase();
  const nameStarts = (nStarts.value   || "").trim().toLowerCase();
  const nameContains = (nContains.value || "").trim().toLowerCase();
  const branchVal  = (branchFilter.value || "").trim().toLowerCase();

  if(!branchVal){ results.innerHTML = ""; return; }

  const res = [];
  for(const r of SALES_DATA){
    const p  = String(r.part  ?? "").toLowerCase();
    const n  = String(r.name  ?? "").toLowerCase();
    const br = String(r.branch?? "").trim().toLowerCase();

    if(q && !p.includes(q)) continue;
    if(nameStarts && !n.startsWith(nameStarts)) continue;
    if(nameContains && !n.includes(nameContains)) continue;
    if(branchVal && branchVal !== "*" && br !== branchVal) continue;

    res.push(r);
    if(res.length >= 100) break;
  }
  renderSales(res);
}

function fmtDate(d){
  if(!d) return "";
  const dt = new Date(d);
  if (isNaN(dt)) return "";
  const day = String(dt.getDate()).padStart(2,"0");
  const month = String(dt.getMonth()+1).padStart(2,"0");
  const hour = String(dt.getHours()).padStart(2,"0");
  const min = String(dt.getMinutes()).padStart(2,"0");
  return `${day}/${month}/${dt.getFullYear()} ${hour}:${min}`;
}

function renderInventory(data){
  results.innerHTML = data.map(r=>{
    const qtySysNum = Number(r.qty ?? 0);
    const qtyCountNum = Number(r.lastCountQty ?? 0);
    let cls="part", status="";
    const hasCount = (r.lastCountedAt && String(r.lastCountedAt).trim() !== "");
    if(hasCount){
      const diffAbs = Math.abs(qtySysNum - qtyCountNum);
      if(qtySysNum === qtyCountNum){
        cls += " ok";
        status = `âœ“ طھظ… ط§ظ„ط¬ط±ط¯ (${fmtDate(r.lastCountedAt)}) - ${r.countedBy || ""}`;
      }else{
        cls += " warn";
        status = `${diffAbs >= 5 ? "ًںڑ¨":"âڑ "} ظپط±ظ‚ ${diffAbs} | ط¬ط±ط¯: ${qtyCountNum} | ظ†ظ‡ط§ط¦ظٹ: ${qtySysNum} | ${fmtDate(r.lastCountedAt)}`;
      }
    }else{
      status = "ظ„ظ… ظٹط¬ط±ط¯";
    }
    const itemStyle = hasCount && Math.abs(qtySysNum - qtyCountNum) >= 5 ? "border:2px solid #f97316;background:#fff7ed;" : "";
    return `<div class="item" style="${itemStyle}">
      <div class="part-row"><div class="${cls}">${r.part ?? ""}</div><div class="location"><b>ط§ظ„ظ…ظˆظ‚ط¹:</b> ${r.location ?? ""}</div></div>
      <div class="name">${r.name ?? ""}</div>
      <div class="meta"><span>ط§ظ„ظ†ظ‡ط§ط¦ظٹط©: <b>${qtySysNum}</b></span> | <span>ط§ظ„ط¬ط±ط¯: <b>${qtyCountNum || 0}</b></span></div>
      <div class="status">${status}</div>
      <div style="display:flex;justify-content:flex-end;margin-top:6px">
        <button onclick='openDetail(${JSON.stringify(r.part ?? "")})' style="border:none;background:#2563eb;color:#fff;padding:6px 12px;border-radius:8px;cursor:pointer">âœڈï¸ڈ طھط¹ط¯ظٹظ„</button>
      </div>
    </div>`;
  }).join("");
}

function renderSales(data){
  results.innerHTML = data.map(r=>{
    const availCls = r.qty > 0 ? "ok" : "warn";
    const inCart = SALES_CART.find(c => c.part === r.part);
    const btnText = inCart ? "âœ“ ظپظٹ ط§ظ„ط¹ط±ط¨ط©" : "â‍• ط£ط¶ظپ";
    const btnDisabled = inCart ? "disabled" : "";
    const btnBg = inCart ? "#16a34a" : "#2563eb";
    return `<div class="item sales-item">
      <div class="part-row"><div class="part ${availCls}">${r.part}</div><div class="location"><b>ط§ظ„ظپط±ط¹:</b> ${r.branch || ""}</div></div>
      <div class="name">${r.name}</div>
      <div class="meta"><span>ط§ظ„ظƒظ…ظٹط©: ${r.qty}</span> | <span>ط§ظ„طھظƒظ„ظپط©: ${r.cost}</span> | <span>ط§ظ„ط³ط¹ط±: ${r.maxPrice}</span></div>
      <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:6px">
        <button onclick='addToCart(${JSON.stringify(r)})' ${btnDisabled} style="border:none;background:${btnBg};color:#fff;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:13px;opacity:${inCart ? 0.6 : 1}">${btnText}</button>
        <button onclick='openSalesDetail(${JSON.stringify(r)})' style="border:none;background:#7c3aed;color:#fff;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:13px">ًں“‹ طھظپطµظٹظ„</button>
      </div>
    </div>`;
  }).join("");
}

function openDetail(part){
  if (CURRENT_VIEW !== "inventory") return;
  const currentBranch = (branchFilter.value || "").trim().toLowerCase();
  const r = ALL_DATA.find(x =>
    String(x.part) === String(part) &&
    String(x.branch || "").trim().toLowerCase() === currentBranch
  );
  if (!r) return;
  CURRENT_DETAIL_PART = r.part;
  CURRENT_DETAIL_BRANCH = r.branch || "";
  
  const ov = document.createElement("div");
  ov.className = "detail-overlay";
  ov.innerHTML = `<div class="detail-card">
      <div class="detail-header"><span>طھط¹ط¯ظٹظ„ ط§ظ„طµظ†ظپ</span><button class="detail-close" onclick="this.closest('.detail-overlay').remove()">âœ•</button></div>
      <div class="detail-label">ط±ظ‚ظ… ط§ظ„طµظ†ظپ: <b>${r.part}</b></div>
      <div class="detail-label">ط§ط³ظ… ط§ظ„طµظ†ظپ: <b>${r.name}</b></div>
      <div class="detail-label">ط§ظ„ظ…ظˆظ‚ط¹ ط§ظ„ط¬ط¯ظٹط¯</div>
      <input id="newLoc" value="${r.countLocation || ''}" data-original="${(r.countLocation || '')}" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);margin-top:4px">
      <div class="detail-label">ظƒظ…ظٹط© ط§ظ„ط¬ط±ط¯</div>
      <div class="detail-qty-box">
        <button onclick="chg(-1);updateDetailSaveState()">&minus;</button>
        <input id="cq" type="number" value="${r.lastCountQty ?? ''}" data-original="${r.lastCountQty ?? ''}" placeholder="ط£ط¯ط®ظ„ ط§ظ„ظƒظ…ظٹط©">
        <button onclick="chg(1);updateDetailSaveState()">+</button>
      </div>
      <div class="detail-label">ط§ظ„ظƒظ…ظٹط© ظ…طھظˆظپط±ط©: <b>${r.qty}</b></div>
      <div class="detail-label">ظ…ظ„ط§ط­ط¸ط§طھ</div>
      <textarea id="note" data-original="${(r.note || '')}" style="width:100%;min-height:60px;border-radius:8px;border:1px solid var(--border);padding:6px;">${r.note || ''}</textarea>
      <button id="detailSaveBtn" class="detail-save" disabled style="opacity:0.5;cursor:not-allowed" onclick="saveCount('${String(r.part)}', ${r.qty})">ط­ظپط¸ ط§ظ„طھط¹ط¯ظٹظ„</button>
    </div>`;
  document.body.appendChild(ov);
  ["newLoc","cq","note"].forEach(id=>document.getElementById(id).addEventListener("input", updateDetailSaveState));
}

function openSalesDetail(item){
  if (CURRENT_VIEW !== "sales") return;
  
  const ov = document.createElement("div");
  ov.className = "sales-detail-overlay";
  
  const cost = Number(item.cost) || 0;
  const maxPrice = Number(item.maxPrice) || 0;
  
  ov.innerHTML = `<div class="sales-detail-card">
    <div class="sales-detail-header">
      <span>ًں“‹ طھظپط§طµظٹظ„ ط§ظ„طµظ†ظپ</span>
      <button class="sales-detail-close" onclick="this.closest('.sales-detail-overlay').remove()">âœ•</button>
    </div>
    
    <div class="info-row">
      <span class="info-label">ط±ظ‚ظ… ط§ظ„طµظ†ظپ:</span>
      <span class="info-value">${item.part}</span>
    </div>
    
    <div class="info-row">
      <span class="info-label">ط§ط³ظ… ط§ظ„طµظ†ظپ:</span>
      <span class="info-value">${item.name}</span>
    </div>
    
    <div class="info-row">
      <span class="info-label">ط§ظ„ظپط±ط¹:</span>
      <span class="info-value">${item.branch || "---"}</span>
    </div>
    
    <div class="info-row">
      <span class="info-label">ط§ظ„ظƒظ…ظٹط© ط§ظ„ظ…طھظˆظپط±ط©:</span>
      <span class="info-value">${item.qty}</span>
    </div>
    
    <div class="info-row">
      <span class="info-label">ط§ظ„طھظƒظ„ظپط©:</span>
      <span class="info-value">${cost.toFixed(2)}</span>
    </div>
    
    <div class="info-row">
      <span class="info-label">ط§ظ„ط³ط¹ط± ط§ظ„ط­ط§ظ„ظٹ:</span>
      <span class="info-value">${maxPrice.toFixed(2)}</span>
    </div>
    
    <div class="price-section">
      <div style="font-weight:700;color:var(--primary);margin-bottom:10px">ًں’° ط­ط³ط§ط¨ ط§ظ„ط³ط¹ط± ط§ظ„ط¬ط¯ظٹط¯</div>
      
      <div class="price-input-group">
        <label>ط§ظ„ط³ط¹ط± ط§ظ„ط¬ط¯ظٹط¯</label>
        <input type="number" id="newPrice" placeholder="ط£ط¯ط®ظ„ ط§ظ„ط³ط¹ط± ط§ظ„ط¬ط¯ظٹط¯" step="0.01" oninput="calculatePriceMetrics(${cost})">
      </div>
      
      <div id="priceCalcResults" style="display:none" class="calc-results">
        <div class="calc-row">
          <span class="calc-label">ط§ظ„ط±ط¨ط­ (ط§ظ„ط³ط¹ط± - ط§ظ„طھظƒظ„ظپط©):</span>
          <span class="calc-value" id="profitValue">0.00</span>
        </div>
        <div class="calc-row">
          <span class="calc-label">ظ†ط³ط¨ط© ط§ظ„ط±ط¨ط­ %:</span>
          <span class="calc-value" id="profitPercentValue">0.00 %</span>
        </div>
        <div class="calc-row">
          <span class="calc-label">ط§ظ„ط¥ط¬ظ…ط§ظ„ظٹ ط´ط§ظ…ظ„ 15% ط¶ط±ظٹط¨ط©:</span>
          <span class="calc-value" id="totalWithTaxValue">0.00</span>
        </div>
      </div>
      
      <div id="noPriceCalc" class="no-calc">ط£ط¯ط®ظ„ ط§ظ„ط³ط¹ط± ط§ظ„ط¬ط¯ظٹط¯ ظ„ط­ط³ط§ط¨ ط§ظ„ط£ط±ط¨ط§ط­ ظˆط§ظ„ط¶ط±ط§ط¦ط¨</div>
    </div>
  </div>`;
  
  document.body.appendChild(ov);
}

function calculatePriceMetrics(cost){
  const newPriceInput = document.getElementById("newPrice");
  const newPrice = Number(newPriceInput.value) || 0;
  
  if(newPrice <= 0){
    document.getElementById("priceCalcResults").style.display = "none";
    document.getElementById("noPriceCalc").style.display = "block";
    return;
  }
  
  document.getElementById("noPriceCalc").style.display = "none";
  document.getElementById("priceCalcResults").style.display = "block";
  
  // ط­ط³ط§ط¨ ط§ظ„ط±ط¨ط­
  const profit = newPrice - cost;
  
  // ط­ط³ط§ط¨ ظ†ط³ط¨ط© ط§ظ„ط±ط¨ط­
  const profitPercent = cost > 0 ? (profit / cost) * 100 : 0;
  
  // ط§ظ„ط¥ط¬ظ…ط§ظ„ظٹ ط´ط§ظ…ظ„ ط§ظ„ط¶ط±ظٹط¨ط©
  const totalWithTax = newPrice * 1.15;
  
  document.getElementById("profitValue").textContent = profit.toFixed(2);
  document.getElementById("profitPercentValue").textContent = profitPercent.toFixed(2) + " %";
  document.getElementById("totalWithTaxValue").textContent = totalWithTax.toFixed(2);
}

function chg(d){
  const i = document.getElementById("cq");
  i.value = Math.max(0, (+i.value || 0) + d);
}

function updateDetailSaveState(){
  const btn = document.getElementById("detailSaveBtn");
  if(!btn) return;
  const cq = document.getElementById("cq"),
        note = document.getElementById("note"),
        loc = document.getElementById("newLoc");
  const changed =
    (cq.value  != cq.dataset.original) ||
    (note.value!= note.dataset.original) ||
    (loc.value != loc.dataset.original);
  btn.disabled = !changed;
  btn.style.opacity = changed ? "1" : "0.5";
  btn.style.cursor  = changed ? "pointer" : "not-allowed";
}

function showNotification(msg){
  const notif = document.createElement("div");
  notif.className = "success-notify";
  notif.textContent = msg;
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 3000);
}

function saveCount(part, systemQty){
  const cqVal   = document.getElementById("cq").value;
  const noteVal = document.getElementById("note").value;
  const locVal  = document.getElementById("newLoc").value;

  const r = ALL_DATA.find(x =>
    String(x.part)   === String(CURRENT_DETAIL_PART) &&
    String(x.branch || "") === String(CURRENT_DETAIL_BRANCH)
  );

  if(!r){
    alert("ط­ط¯ط« ط®ط·ط£: ظ„ظ… ظٹطھظ… ط§ظ„ط¹ط«ظˆط± ط¹ظ„ظ‰ ط§ظ„طµظ†ظپ ظپظٹ ط§ظ„ط°ط§ظƒط±ط©");
    return;
  }

  const currentVersion = r.version || 0;

  const ov = document.querySelector(".detail-overlay");
  if(ov) ov.remove();

  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({
      part:         part,
      systemQty:    systemQty,
      countedQty:   cqVal,
      note:         noteVal,
      user:         CURRENT_USER,
      newLocation:  locVal,
      branch:       CURRENT_DETAIL_BRANCH,
      itemName:     r.name || "",
      barcode:      r.barcode || "",
      version:      currentVersion
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.ok){
      // طھط­ط¯ظٹط« ظپظˆط±ظٹ ظپظٹ ط§ظ„ط°ط§ظƒط±ط©
      r.lastCountedAt = new Date().toISOString();
      r.lastCountQty  = Number(cqVal);
      r.note          = noteVal;
      r.countedBy     = CURRENT_USER;
      r.countLocation = locVal;
      r.version       = data.version || currentVersion + 1;

      // طھط­ط¯ظٹط« ط§ظ„ط¹ط±ط¶ ظپظˆط±ط§ظ‹ ظ…ط¹ طھط²ط§ظ…ظ† ط¬ط¯ظٹط¯
      LAST_SYNC_TIME = Date.now();
      runSearchInventory();
      playBeep();
      showNotification("âœ“ طھظ… ط­ظپط¸ ط§ظ„طھط¹ط¯ظٹظ„ ط¨ظ†ط¬ط§ط­");
      showUpdateIndicator();
    } else {
      if (data.conflict){
        // طھط¶ط§ط±ط¨: ظ…ط³طھط®ط¯ظ… ط¢ط®ط± ط¹ط¯ظ„ ظ†ظپط³ ط§ظ„طµظ†ظپ
        showConflictNotification(data.error || "طھظ… طھط¹ط¯ظٹظ„ ط§ظ„طµظ†ظپ ظ…ظ† ظ…ط³طھط®ط¯ظ… ط¢ط®ط± (ظ…ظ† " + (data.conflictUser || "طں") + ")");
        setTimeout(()=>{
          runSearchInventory();
        }, 1500);
      } else {
        alert(data.error || "ظپط´ظ„ ط§ظ„ط­ظپط¸");
      }
    }
  })
  .catch(err => {
    console.error(err);
    alert("ط®ط·ط£ ظپظٹ ط§ظ„ط§طھطµط§ظ„ ط£ط«ظ†ط§ط، ط§ظ„ط­ظپط¸طŒ ط³ظٹطھظ… طھط­ط¯ظٹط« ط§ظ„ط¨ظٹط§ظ†ط§طھ");
    runSearchInventory();
  });
}

function showConflictNotification(msg){
  const notif = document.createElement("div");
  notif.className = "conflict-notify";
  notif.innerHTML = `âڑ ï¸ڈ ${msg}`;
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 4000);
}

/* CAMERA */
let html5QrCode = null;
let isScanning = false;
document.getElementById("scanBtn").addEventListener("click", startScan);

function startScan(){
  if(isScanning || CURRENT_VIEW === "sales") return;
  const container = document.getElementById("scannerContainer");
  container.style.display = "block";
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 150 } },
    decodedText => {
      barcode.value = normalizeBarcode(decodedText);
      stopScan();
      runSearchInventory();
    }
  ).catch(() => {
    alert("طھط¹ط°ط± ظپطھط­ ط§ظ„ظƒط§ظ…ظٹط±ط§");
    container.style.display = "none";
  });
  isScanning = true;
}

function stopScan(){
  const container = document.getElementById("scannerContainer");
  container.style.display = "none";
  if(html5QrCode && isScanning){
    html5QrCode.stop().then(() => {
      html5QrCode.clear();
      isScanning = false;
    }).catch(() => {
      isScanning = false;
    });
  }
}

/* CART FUNCTIONS */
function addToCart(item){
  const existing = SALES_CART.find(c => c.part === item.part);
  if(!existing){
    const newItem = {
      ...item,
      cartQty: 1,
      cartNewPrice: Number(item.maxPrice) || 0
    };
    SALES_CART.push(newItem);
    showNotification("âœ“ طھظ… ط¥ط¶ط§ظپط© ط§ظ„طµظ†ظپ ظ„ظ„ط¹ط±ط¨ط©");
    updateCartDisplay();
    runSearchSales();
  }
}

function removeFromCart(part){
  if(ACTIVE_CART_ITEM === part){
    ACTIVE_CART_ITEM = null;
  }
  SALES_CART = SALES_CART.filter(c => c.part !== part);
  updateCartDisplay();
  runSearchSales();
}

function updateCartQty(part, qty){
  const item = SALES_CART.find(c => c.part === part);
  if(item){
    item.cartQty = Math.max(1, parseInt(qty) || 1);
    updateCartDisplay();
    selectCartItem(part);
    updateTotals();
  }
}

function updateCartNewPrice(part, newPrice){
  const item = SALES_CART.find(c => c.part === part);
  if(item){
    item.cartNewPrice = Math.max(0, parseFloat(newPrice) || Number(item.maxPrice) || 0);
    selectCartItem(part);
    updateTotals();
  }
}

function updateCartDisplay(){
  const cartBtn = document.getElementById("cartBtn");
  const cartCount = document.getElementById("cartCount");
  
  if(SALES_CART.length > 0){
    cartBtn.style.display = "flex";
    cartCount.textContent = SALES_CART.length;
    cartCount.style.display = "flex";
  } else {
    cartBtn.style.display = "none";
    cartCount.style.display = "none";
  }
}

function selectCartItem(part){
  ACTIVE_CART_ITEM = part;
  updateProfitPanel();
}

function calculateItemProfit(item){
  if(!item) return { cost: 0, newPrice: 0, profit: 0, profitPercent: 0, totalWithTax: 0 };
  
  const cost = Number(item.cost) || 0;
  const newPrice = Number(item.cartNewPrice) || Number(item.maxPrice) || 0;
  const qty = Number(item.cartQty) || 1;
  
  const totalCost = cost * qty;
  const totalPrice = newPrice * qty;
  const profit = totalPrice - totalCost;
  const profitPercent = totalCost > 0 ? (profit / totalCost) * 100 : 0;
  const priceWithTax = newPrice * 1.15;
  const totalWithTax = priceWithTax * qty;
  
  return {
    cost: cost,
    newPrice: newPrice,
    qty: qty,
    totalCost: totalCost,
    totalPrice: totalPrice,
    profit: profit,
    profitPercent: profitPercent,
    priceWithTax: priceWithTax,
    totalWithTax: totalWithTax
  };
}

function updateProfitPanel(){
  if(!ACTIVE_CART_ITEM){
    const profitPanel = document.getElementById('activeItemProfitPanel');
    if(profitPanel) profitPanel.style.display = 'none';
    return;
  }

  const activeItem = SALES_CART.find(c => c.part === ACTIVE_CART_ITEM);
  if(!activeItem) return;

  const profitData = calculateItemProfit(activeItem);
  const profit = profitData.newPrice - profitData.cost;

  const profitPanel = document.getElementById('activeItemProfitPanel');
  profitPanel.style.display = 'block';

  profitPanel.innerHTML = `
    <div style="padding:4px 8px;background:#e0f2fe;border-radius:6px;margin-bottom:6px;font-size:11px;display:flex;justify-content:space-between;align-items:center;gap:8px">
      <span style="color:#0369a1;font-weight:600">${activeItem.part}</span>
      <span style="white-space:nowrap">ط§ظ„طھظƒظ„ظپط©: <strong>${profitData.cost.toFixed(2)}</strong></span>
      <span style="white-space:nowrap">ط§ظ„ط±ط¨ط­: <strong style="color:${profit >= 0 ? '#16a34a' : '#dc2626'}">${profit.toFixed(2)}</strong></span>
    </div>
  `;
}



function updateTotals(){
  let totalCost = 0;
  let totalNewPrice = 0;
  let totalProfit = 0;
  
  SALES_CART.forEach(item => {
    const cost = (Number(item.cost) || 0) * item.cartQty;
    const newPrice = (Number(item.cartNewPrice) || Number(item.maxPrice) || 0) * item.cartQty;
    totalCost += cost;
    totalNewPrice += newPrice;
    totalProfit += (newPrice - cost);
  });
  
  const profitPercent = totalCost > 0 ? (totalProfit / totalCost) * 100 : 0;
  const totalWithTax = totalNewPrice * 1.15;
  
  const totalsElement = document.querySelector('.cart-totals');
  if(totalsElement){
    totalsElement.innerHTML = `
      <div class="total-row">
        <span>ط¥ط¬ظ…ط§ظ„ظٹ ط§ظ„طھظƒظ„ظپط©:</span>
        <span>${totalCost.toFixed(2)}</span>
      </div>
      <div class="total-row">
        <span>ط¥ط¬ظ…ط§ظ„ظٹ ط§ظ„ط³ط¹ط± ط§ظ„ط¬ط¯ظٹط¯:</span>
        <span style="color:var(--primary);font-weight:700;direction:ltr">${totalNewPrice.toFixed(2)}</span>
      </div>
      <div class="total-row">
        <span>ط¥ط¬ظ…ط§ظ„ظٹ ط§ظ„ط±ط¨ط­:</span>
        <span style="color:${totalProfit >= 0 ? '#16a34a' : '#dc2626'};font-weight:700;direction:ltr">
          ${totalProfit.toFixed(2)} (${profitPercent.toFixed(1)}%)
        </span>
      </div>
      <div class="total-row">
        <span>ظ…ط¹ ط§ظ„ط¶ط±ظٹط¨ط© 15%:</span>
        <span style="color:var(--primary);font-weight:700;direction:ltr">${totalWithTax.toFixed(2)}</span>
      </div>
    `;
  }
}

function openCart(){
  if(SALES_CART.length === 0){
    showNotification("ط§ظ„ط¹ط±ط¨ط© ظپط§ط±ط؛ط©!");
    return;
  }
  
  // ط¥ط¹ط§ط¯ط© طھط¹ظٹظٹظ† ط§ظ„ط¹ظ†طµط± ط§ظ„ظ†ط´ط·
  ACTIVE_CART_ITEM = null;
  
  const ov = document.createElement("div");
  ov.className = "cart-overlay";
  
  ov.innerHTML = `<div class="cart-card">
    <div class="cart-header">
      <span>ًں›’ ط¹ط±ط¨ط© ط§ظ„ظ…ط¨ظٹط¹ط§طھ</span>
      <button class="cart-close" onclick="this.closest('.cart-overlay').remove()">âœ•</button>
    </div>
    
    <div id="activeItemProfitPanel" style="display:none;"></div>
    
    <div class="cart-table-wrapper">
      <table class="cart-table">
        <thead>
          <tr>
            <th class="cart-table-header-num">#</th>
            <th class="cart-table-header-part">ط§ظ„طµظ†ظپ</th>
            <th class="cart-table-header-desc">ط§ظ„ظˆطµظپ</th>
            <th class="cart-table-header-qty">ط§ظ„ظƒظ…ظٹط©</th>
            <th class="cart-table-header-price">ط§ظ„ط³ط¹ط±</th>
            <th class="cart-table-header-remove"></th>
          </tr>
        </thead>
        <tbody id="cartTableBody">
          ${SALES_CART.map((item, idx) => {
            return `
            <tr class="cart-row" data-part="${item.part}">
              <td class="cart-table-num">${idx + 1}</td>
              <td class="cart-table-part">${item.part}</td>
              <td class="cart-table-desc">${item.name}</td>
              <td class="cart-table-qty-cell">
                <input type="number" class="cart-table-qty-input" value="${item.cartQty}" 
                       oninput="updateCartQty('${item.part}', this.value)"
                       onfocus="selectCartItem('${item.part}'); this.select()"
                       min="1" max="999">
              </td>
              <td class="cart-table-price-cell">
                <input type="number" class="cart-table-price-input" value="${(item.cartNewPrice || item.maxPrice || 0).toFixed(2)}" 
                       oninput="updateCartNewPrice('${item.part}', this.value)"
                       onfocus="selectCartItem('${item.part}'); this.select()"
                       step="0.01" min="0">
              </td>
              <td style="text-align:center">
                <button class="cart-item-remove" onclick="removeFromCart('${item.part}')">âœ•</button>
              </td>
            </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
    
    <div class="cart-totals">
      <!-- ط³ظٹطھظ… ظ…ظ„ط¤ظ‡ ط¨ظˆط§ط³ط·ط© updateTotals -->
    </div>
    
    <div class="cart-actions">
      <button class="cart-clear-btn" onclick="clearCart()">ظ…ط³ط­ ط§ظ„ط¹ط±ط¨ط©</button>
      <button class="cart-checkout-btn" onclick="sendQuoteToWhatsApp()">ًں“¤ ط¥ط±ط³ط§ظ„</button>
    </div>
  </div>`;
  
  document.body.appendChild(ov);
  
  // ط­ط³ط§ط¨ ط§ظ„ط¥ط¬ظ…ط§ظ„ظٹط§طھ ط§ظ„ط£ظˆظ„ظٹط©
  updateTotals();
  
  // طھط¹ظٹظٹظ† ط£ظˆظ„ ط¹ظ†طµط± ظƒظ†ط´ط· ط§ظپطھط±ط§ط¶ظٹظ‹ط§
  if(SALES_CART.length > 0 && !ACTIVE_CART_ITEM){
    setTimeout(() => {
      selectCartItem(SALES_CART[0].part);
    }, 100);
  }
}

function clearCart(){
  SALES_CART = [];
  ACTIVE_CART_ITEM = null;
  updateCartDisplay();
  
  const overlay = document.querySelector(".cart-overlay");
  if(overlay) overlay.remove();
  
  runSearchSales();
  showNotification("طھظ… ظ…ط³ط­ ط§ظ„ط¹ط±ط¨ط©");
}

function sendQuoteToWhatsApp(){
  if(SALES_CART.length === 0){
    showNotification("ط§ظ„ط¹ط±ط¨ط© ظپط§ط±ط؛ط©!");
    return;
  }

  let totalWithoutTax = 0;
  SALES_CART.forEach(item => {
    const price = (Number(item.cartNewPrice) || Number(item.maxPrice) || 0);
    const qty = Number(item.cartQty) || 1;
    totalWithoutTax += (price * qty);
  });
  const totalWithTax = totalWithoutTax * 1.15;

  let message = "ًںڈ¢ *ط´ط±ظƒط© ط§ظ„ظ‚ط§ط¶ظٹ ظ„ظ‚ط·ط¹ ط؛ظٹط§ط± ط§ظ„ط³ظٹط§ط±ط§طھ*\n";
  message += "â”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پ\n\n";
  message += "*ًں“‹ ط¹ط±ط¶ ط³ط¹ط±:*\n\n";

  SALES_CART.forEach((item, idx) => {
    const nameParts = (item.name || "").trim().split(/\s+/);
    const shortName = nameParts.slice(0, 2).join(" ");

    const price = (Number(item.cartNewPrice) || Number(item.maxPrice) || 0);
    const qty = Number(item.cartQty) || 1;
    const itemTotal = price * qty;

    message += (idx + 1) + ". *" + item.part + "*\n";
    message += "   " + shortName + "\n";
    message += "   ط§ظ„ظƒظ…ظٹط©: " + qty + " | ط§ظ„ط³ط¹ط±: " + price.toFixed(2) + "\n";
    message += "   ط§ظ„ط¥ط¬ظ…ط§ظ„ظٹ: " + itemTotal.toFixed(2) + " ط±.ط³\n\n";
  });

  message += "â”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پ\n";
  message += "*ط§ظ„ط¥ط¬ظ…ط§ظ„ظٹ ظ‚ط¨ظ„ ط§ظ„ط¶ط±ظٹط¨ط©:* " + totalWithoutTax.toFixed(2) + " ط±.ط³\n";
  message += "*ط§ظ„ط¥ط¬ظ…ط§ظ„ظٹ ظ…ط¹ ط§ظ„ط¶ط±ظٹط¨ط© (15%):* " + totalWithTax.toFixed(2) + " ط±.ط³\n";
  message += "â”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پâ”پ\n\n";
  message += "ط´ظƒط±ط§ظ‹ ظ„طھط¹ط§ظ…ظ„ظƒظ… ظ…ط¹ظ†ط§ ًں™ڈ";

  const encodedMessage = encodeURIComponent(message);

  // ظ…ط­ط§ظˆظ„ط© ظپطھط­ WhatsApp
  const whatsappURL = "https://wa.me/?text=" + encodedMessage;
  const whatsappWindow = window.open(whatsappURL, "_blank");

  // ط¥ط؛ظ„ط§ظ‚ ط§ظ„ط³ظ„ط©
  const overlay = document.querySelector(".cart-overlay");
  if(overlay) overlay.remove();

  // ط±ط³ط§ظ„ط© ظ„ظ„ظ…ط³طھط®ط¯ظ…
  showNotification("âœ“ طھظ… ظپطھط­ WhatsApp - ط¥ط°ط§ ظ„ظ… ظٹظپطھط­طŒ ط§ط³طھط®ط¯ظ… ظ†ط³ط® ط§ظ„ط±ط³ط§ظ„ط©");

  // ط¥ط¶ط§ظپط© ط²ط± ظ†ط³ط® ظ„ظ„ط­ط§ظپط¸ط© ظƒظ€ backup
  setTimeout(() => {
    if(confirm("ظ‡ظ„ طھط±ظٹط¯ ظ†ط³ط® ط§ظ„ط±ط³ط§ظ„ط© ظ„ظ„ط­ط§ظپط¸ط©طں (ظپظٹ ط­ط§ظ„ ظ„ظ… ظٹظپطھط­ WhatsApp)")){
      const textArea = document.createElement("textarea");
      textArea.value = message.replace(/\n/g, "\n");
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand("copy");
      document.body.removeChild(textArea);
      showNotification("âœ“ طھظ… ظ†ط³ط® ط§ظ„ط±ط³ط§ظ„ط© - ظٹظ…ظƒظ†ظƒ ظ„طµظ‚ظ‡ط§ ظپظٹ ط£ظٹ طھط·ط¨ظٹظ‚");
    }
  }, 1000);
}


function logoutUser(){
  localStorage.clear();
  if (AUTO_REFRESH) clearInterval(AUTO_REFRESH);
  if(loadingInterval) clearInterval(loadingInterval);
  location.reload();
}

// ط¯ط§ظ„ط© ظ…ط³ط§ط¹ط¯ط© ظ„طھط·ط¨ظٹط¹ ط§ظ„ط¨ط§ط±ظƒظˆط¯ (ط¥ظ† ظˆط¬ط¯طھ)
function normalizeBarcode(text) {
  return cleanBarcode(text);
}
</script>

</body>
</html>
