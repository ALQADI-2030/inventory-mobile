<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</title>

<style>
body{
  font-family: system-ui;
  background:#f2f4f7;
  margin:0;
  padding:12px
}
h1{text-align:center;margin-bottom:12px}

.card{
  background:#fff;
  border-radius:16px;
  padding:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
  margin-bottom:12px
}

.row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-bottom:10px
}

input{
  padding:14px;
  font-size:16px;
  border-radius:10px;
  border:1px solid #ddd
}

button{
  padding:14px;
  border:none;
  border-radius:12px;
  font-size:16px;
  width:100%
}

.refresh{background:#1e88e5;color:#fff;margin-bottom:10px}
.clear{background:#e53935;color:#fff}

.item{
  background:#fff;
  border-radius:14px;
  padding:14px;
  margin-bottom:10px;
  box-shadow:0 4px 10px rgba(0,0,0,.06)
}

.part{font-weight:700;font-size:17px}
.meta{color:#555;margin-top:4px}

.qty-box{
  display:flex;
  gap:8px;
  margin-top:10px
}
.qty-box button{
  width:48px;
  font-size:20px;
  background:#eee
}
.qty-box input{
  flex:1;
  text-align:center;
  font-size:18px
}
</style>
</head>

<body>

<h1>Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h1>

<div class="card">
  <button class="refresh" onclick="refreshData()">ðŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>

  <div class="row">
    <input id="pContains" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰">
    <input id="pEnds" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€">
  </div>

  <div class="row">
    <input id="nStarts" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙŠØ¨Ø¯Ø£ Ø¨Ù€">
    <input id="nContains" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰">
  </div>

  <div class="row">
    <input id="locFrom" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù†">
    <input id="locTo" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¥Ù„Ù‰">
  </div>

  <button class="clear" onclick="clearAll()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
</div>

<div id="results"></div>

<script>
/* ========= Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ========= */
const API = "https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";
const CACHE_KEY = "inventory_cache_v1";
const COUNT_KEY = "count_log_v1";

/* ========= Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ========= */
let ALL_DATA = [];

/* ========= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ========= */
function loadData(){
  const cached = localStorage.getItem(CACHE_KEY);
  if(cached){
    ALL_DATA = JSON.parse(cached);
  }
  refreshData();
}

function refreshData(){
  fetch(API)
    .then(r=>r.json())
    .then(data=>{
      ALL_DATA = data;
      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      runSearch();
    })
    .catch(()=>{ /* Ø£ÙˆÙ Ù„Ø§ÙŠÙ† */ });
}

/* ========= Ø§Ù„Ø¬Ø±Ø¯ Ø£ÙˆÙ Ù„Ø§ÙŠÙ† ========= */
function saveCount(part, qty){
  const log = JSON.parse(localStorage.getItem(COUNT_KEY) || "[]");
  log.push({
    part,
    qty:Number(qty),
    time:new Date().toISOString()
  });
  localStorage.setItem(COUNT_KEY, JSON.stringify(log));
}

function getLastCount(part){
  const log = JSON.parse(localStorage.getItem(COUNT_KEY) || "[]");
  const last = log.filter(l=>l.part===part).slice(-1)[0];
  return last ? last.qty : null;
}

/* ========= Ø§Ù„Ø¨Ø­Ø« ========= */
document.querySelectorAll("input").forEach(i=>{
  i.addEventListener("input", debounce);
});

let timer=null;
function debounce(){
  clearTimeout(timer);
  timer=setTimeout(runSearch,300);
}

function runSearch(){
  if(!ALL_DATA.length) return;

  const pC = pContains.value.toLowerCase();
  const pE = pEnds.value.toLowerCase();
  const nS = nStarts.value.toLowerCase();
  const nC = nContains.value.toLowerCase();
  const lF = locFrom.value.toLowerCase();
  const lT = locTo.value.toLowerCase();

  const res = ALL_DATA.filter(r=>{
    const part = (r.part||"").toLowerCase();
    const name = (r.name||"").toLowerCase();
    const loc  = (r.location||"").toLowerCase();

    if(pC && !part.includes(pC)) return false;
    if(pE && !part.endsWith(pE)) return false;
    if(nS && !name.startsWith(nS)) return false;
    if(nC && !name.includes(nC)) return false;
    if(lF && loc < lF) return false;
    if(lT && loc > lT) return false;
    return true;
  });

  render(res);
}

/* ========= Ø§Ù„Ø¹Ø±Ø¶ ========= */
function render(data){
  const el = document.getElementById("results");
  el.innerHTML="";

  if(!data.length){
    el.innerHTML="<div class='item'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>";
    return;
  }

  data.forEach(r=>{
    const counted = getLastCount(r.part);
    const showQty = counted!==null ? counted : r.qty;

    el.innerHTML += `
      <div class="item">
        <div class="part">${r.part}</div>
        <div>${r.name}</div>
        <div class="meta">
          Ø§Ù„ÙƒÙ…ÙŠØ©: <b>${showQty}</b> | Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${r.location}
        </div>

        <div class="qty-box">
          <button onclick="adjust('${r.part}', ${showQty-1})">âˆ’</button>
          <input value="${showQty}" 
            onblur="adjust('${r.part}', this.value)">
          <button onclick="adjust('${r.part}', ${showQty+1})">+</button>
        </div>
      </div>
    `;
  });
}

/* ========= ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ© ========= */
function adjust(part, qty){
  qty = Number(qty);
  if(isNaN(qty) || qty<0) qty=0;
  saveCount(part, qty);
  runSearch();
}

/* ========= Ø£Ø¯ÙˆØ§Øª ========= */
function clearAll(){
  document.querySelectorAll("input").forEach(i=>i.value="");
  document.getElementById("results").innerHTML="";
}

loadData();
</script>

</body>
</html>
