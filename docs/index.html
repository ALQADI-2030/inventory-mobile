<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>جرد المخزون</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1976d2">

  <style>
    :root{
      --bg:#f4f5f7;
      --card:#ffffff;
      --primary:#1976d2;
      --danger:#c62828;
      --text:#222;
      --muted:#777;
      --border:#e0e0e0;
    }

    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont;
      background:var(--bg);
      margin:0;
      padding:0;
    }

    /* ===== LOGIN ===== */
    .login-screen{
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .login-box{
      width:100%;
      max-width:360px;
      background:var(--card);
      border-radius:14px;
      padding:20px;
      box-shadow:0 6px 20px rgba(0,0,0,.15);
      text-align:center;
    }

    .login-title{
      font-size:18px;
      font-weight:700;
      margin-bottom:6px;
    }

    .login-sub{
      font-size:13px;
      color:var(--muted);
      margin-bottom:16px;
    }

    .login-input{
      width:100%;
      padding:10px;
      margin-bottom:10px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:14px;
    }

    .login-btn{
      width:100%;
      padding:12px;
      border:none;
      border-radius:10px;
      background:var(--primary);
      color:#fff;
      font-size:15px;
      cursor:pointer;
    }

    .login-error{
      margin-top:10px;
      font-size:13px;
      color:var(--danger);
      display:none;
    }

    /* ===== APP ===== */
    #appScreen{
      display:none;
      padding:8px;
    }

    .top-bar{
      max-width:430px;
      margin:0 auto 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .top-title{
      font-size:15px;
      font-weight:600;
    }

    .icon-btn{
      border:none;
      border-radius:8px;
      padding:6px 10px;
      background:var(--card);
      box-shadow:0 1px 4px rgba(0,0,0,.12);
      cursor:pointer;
    }

    .filter-wrap,
    #results{
      max-width:430px;
      margin:0 auto 8px;
    }

    .filter-card{
      background:var(--card);
      border-radius:12px;
      padding:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.05);
    }

    .filter-input{
      width:100%;
      padding:8px;
      border-radius:8px;
      border:1px solid var(--border);
    }

    .item{
      background:var(--card);
      border-radius:12px;
      padding:10px;
      margin-bottom:6px;
      box-shadow:0 3px 8px rgba(0,0,0,.05);
    }

    .part{
      font-weight:700;
      color:var(--primary);
    }

    .msg{
      text-align:center;
      color:var(--muted);
      padding:12px;
    }
  </style>
</head>

<body>

<!-- ================== LOGIN ================== -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <div class="login-title">تسجيل الدخول</div>
    <div class="login-sub">أدخل اسم المستخدم والرقم السري</div>

    <input id="loginUser" class="login-input" placeholder="اسم المستخدم">
    <input id="loginPass" class="login-input" type="password" placeholder="الرقم السري">

    <button class="login-btn" onclick="login()">دخول</button>

    <div id="loginError" class="login-error"></div>
  </div>
</div>

<!-- ================== APP ================== -->
<div id="appScreen">

  <div class="top-bar">
    <div class="top-title">جرد المخزون</div>
    <button class="icon-btn" onclick="logout()">خروج</button>
  </div>

  <div class="filter-wrap">
    <div class="filter-card">
      <input id="search" class="filter-input" placeholder="بحث برقم الصنف أو الاسم">
    </div>
  </div>

  <div id="results"></div>

</div>

<script>
/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";

let ALL_DATA = [];

/* ================= LOGIN ================= */
function login(){
  const u = loginUser.value.trim();
  const p = loginPass.value.trim();

  if(!u || !p){
    showError("أدخل اسم المستخدم والرقم السري");
    return;
  }

  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({ name:u, pass:p }).toString()
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.ok){
      showError(res.error || "بيانات الدخول غير صحيحة");
      return;
    }

    localStorage.setItem("user", JSON.stringify(res.user));
    loginScreen.style.display="none";
    appScreen.style.display="block";
    loadData();
  })
  .catch(()=>showError("فشل الاتصال بالسيرفر"));
}

function showError(msg){
  loginError.textContent = msg;
  loginError.style.display = "block";
}

/* ================= SESSION ================= */
(function(){
  const u = localStorage.getItem("user");
  if(u){
    loginScreen.style.display="none";
    appScreen.style.display="block";
    loadData();
  }
})();

function logout(){
  localStorage.removeItem("user");
  location.reload();
}

/* ================= DATA ================= */
function loadData(){
  fetch(API)
    .then(r=>r.json())
    .then(d=>{
      if(!Array.isArray(d)){
        results.innerHTML = "<div class='msg'>فشل تحميل البيانات</div>";
        return;
      }
      ALL_DATA = d;
      render(d);
    });
}

search.addEventListener("input", ()=>{
  const q = search.value.trim().toLowerCase();
  const f = ALL_DATA.filter(r =>
    String(r.part).toLowerCase().includes(q) ||
    String(r.name).toLowerCase().includes(q)
  );
  render(f);
});

/* ================= RENDER ================= */
function render(data){
  if(!data.length){
    results.innerHTML = "<div class='msg'>لا توجد نتائج</div>";
    return;
  }

  let h="";
  data.forEach(r=>{
    h+=`
      <div class="item">
        <div class="part">${r.part}</div>
        <div>${r.name}</div>
        <div>الكمية المتوفرة: ${r.qty}</div>
      </div>
    `;
  });
  results.innerHTML = h;
}
</script>

</body>
</html>
