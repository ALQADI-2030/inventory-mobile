<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ÿ¥ÿ±ŸÉÿ© ÿßŸÑŸÇÿßÿ∂Ÿä</title>

<link rel="manifest" href="manifest.json">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
:root{
  --bg:#f3f4fb;
  --card:rgba(255,255,255,0.94);
  --primary:#2563eb;
  --primary-soft:rgba(37,99,235,0.10);
  --accent:#7c3aed;
  --ok:#16a34a;
  --warn:#dc2626;
  --text:#0f172a;
  --muted:#6b7280;
  --border:rgba(148,163,184,0.35);
}

body{
  margin:0;
  font-family:system-ui,-apple-system;
  min-height:100vh;
  background:
    radial-gradient(circle at 0% 0%, rgba(59,130,246,0.12) 0, transparent 55%),
    radial-gradient(circle at 100% 100%, rgba(56,189,248,0.16) 0, #e5e7eb 55%);
  padding:12px;
  color:var(--text);
}
*{box-sizing:border-box}
input, textarea, button{
  font-size:16px;
}

/* LOGIN */
.login-screen{
  position:fixed;
  inset:0;
  z-index:1000;
  display:flex;
  justify-content:center;
  align-items:center;
  background:radial-gradient(circle at 0% 0%, rgba(59,130,246,0.18) 0, transparent 55%),
             radial-gradient(circle at 100% 100%, rgba(236,72,153,0.16) 0, rgba(248,250,252,0.96) 55%);
}
.login-box{
  width:100%;
  max-width:360px;
  padding:24px 20px 20px;
  border-radius:28px;
  background:var(--card);
  backdrop-filter:blur(16px);
  -webkit-backdrop-filter:blur(16px);
  box-shadow:
    0 22px 60px rgba(15,23,42,0.25),
    0 0 0 1px rgba(148,163,184,0.40);
  color:var(--text);
  text-align:center;
  position:relative;
  overflow:hidden;
}
.login-box::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:
    radial-gradient(circle at 0% 0%, rgba(59,130,246,0.18) 0, transparent 55%),
    radial-gradient(circle at 100% 0%, rgba(236,72,153,0.20) 0, transparent 55%);
  opacity:0.45;
  pointer-events:none;
  mix-blend-mode:soft-light;
}
.login-box > *{
  position:relative;
  z-index:1;
}
.login-logo{
  width:120px;
  height:64px;
  margin:4px auto 14px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.login-logo img{
  max-width:100%;
  max-height:100%;
  object-fit:contain;
  display:block;
}
.login-box h3{
  margin:6px 0 4px;
  font-size:18px;
  font-weight:800;
}
.login-box p{
  font-size:12px;
  color:var(--muted);
  margin:0 0 12px;
}
.login-box input{
  width:100%;
  padding:11px;
  margin-top:9px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(248,250,252,0.9);
  color:var(--text);
  transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
}
.login-box input::placeholder{color:#9ca3af}
.login-box input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
  background:#ffffff;
}
.login-btn{
  width:100%;
  margin-top:16px;
  padding:11px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#2563eb,#7c3aed);
  color:#ffffff;
  cursor:pointer;
  font-weight:700;
  letter-spacing:0.3px;
  box-shadow:
    0 14px 32px rgba(37,99,235,0.55),
    0 0 0 1px rgba(129,140,248,0.65);
  transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
}
.login-btn:hover{
  transform:translateY(-1px);
  box-shadow:
    0 18px 40px rgba(37,99,235,0.6),
    0 0 0 1px rgba(129,140,248,0.8);
}
.login-btn:active{
  transform:translateY(1px) scale(0.99);
  box-shadow:0 6px 18px rgba(37,99,235,0.45);
}
#loginError{
  margin-top:8px;
  font-size:12px;
  color:#dc2626;
}
#loginLoading{
  display:none;
  margin-top:6px;
  font-size:11px;
  color:#6b7280;
}
#buildInfo{
  margin-top:10px;
  font-size:11px;
  color:#9ca3af;
}

/* MAIN MENU */
#mainScreen{
  display:none;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.main-card{
  width:100%;
  max-width:380px;
  background:#0f172a;
  border-radius:28px;
  padding:18px 16px 16px;
  box-shadow:
    0 24px 55px rgba(15,23,42,0.5),
    0 0 0 1px rgba(15,23,42,0.8);
  color:#e5e7eb;
  position:relative;
  overflow:hidden;
}

.main-card::before{
  content:"";
  position:absolute;
  inset:0;
  background:none;
  opacity:1;
  pointer-events:none;
}

.main-card > *{
  position:relative;
  z-index:1;
}

.main-logout-btn{
  position:absolute;
  top:12px;
  left:12px;
  background:rgba(255,255,255,0.15);
  color:#ffffff;
  border:none;
  border-radius:8px;
  padding:6px 10px;
  font-size:11px;
  cursor:pointer;
  transition:background .12s ease;
  z-index:2;
}

.main-logout-btn:hover{
  background:rgba(255,255,255,0.25);
}

.main-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  margin-bottom:12px;
}

.main-title{
  font-size:18px;
  font-weight:800;
  color:#ffffff;
}

.main-sub{
  font-size:11px;
  color:#cbd5f5;
}

.main-greeting{
  font-size:12px;
  color:#a5b4fc;
  margin-top:4px;
}

.main-badge{
  font-size:11px;
  background:#1d4ed8;
  color:#e5e7eb;
  padding:4px 10px;
  border-radius:999px;
  box-shadow:0 0 0 1px rgba(37,99,235,0.7);
}

.main-list{
  margin-top:4px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.main-btn{
  width:100%;
  border:none;
  border-radius:18px;
  padding:10px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
  background:#1d4ed8;
  color:#f9fafb;
  box-shadow:0 4px 12px rgba(15,23,42,0.4);
  transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
}

.main-btn span.left{
  display:flex;
  align-items:center;
  gap:10px;
}

.main-icon{
  width:32px;
  height:32px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  background:rgba(15,23,42,0.25);
  color:#f9fafb;
  box-shadow:none;
}

.main-arrow{
  font-size:13px;
  color:#e5e7eb;
  font-weight:600;
}

.main-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 22px rgba(15,23,42,0.6);
  background:#2563eb;
}

.main-btn.primary{
  background:#1d4ed8;
  color:#ffffff;
  box-shadow:0 14px 30px rgba(15,23,42,0.6);
}

.main-btn.primary .main-icon{
  background:rgba(15,23,42,0.25);
  color:#ffffff;
}

.main-btn.primary .main-arrow{
  color:#e5e7eb;
}

/* APP TOP */
#appScreen{
  display:none;
}

.top-bar{
  max-width:430px;
  margin:0 auto 6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:var(--text);
}

.top-title{
  font-weight:700;
  font-size:15px;
}

.top-actions{
  display:flex;
  gap:6px;
  align-items:center;
}

.icon-btn{
  border:none;
  border-radius:999px;
  padding:6px 12px;
  background:rgba(255,255,255,0.92);
  color:#0f172a;
  box-shadow:0 1px 4px rgba(148,163,184,.55);
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:4px;
  transition:background .12s ease, transform .12s ease, box-shadow .12s ease;
  font-size:13px;
}

.icon-btn:hover{
  background:#eff6ff;
  transform:translateY(-1px);
  box-shadow:0 4px 10px rgba(148,163,184,.55);
}

.icon-btn.small{
  padding:5px 8px;
  font-size:12px;
}

/* FILTER + RESULTS */
.filter-wrap,#results{
  max-width:430px;
  margin:0 auto 8px;
}

.filter-wrap{
  position:sticky;
  top:0;
  z-index:10;
}

.filter-card{
  background:var(--card);
  border-radius:16px;
  padding:8px;
  box-shadow:0 3px 10px rgba(148,163,184,.35);
  color:var(--text);
  backdrop-filter:blur(14px);
  -webkit-backdrop-filter:blur(14px);
  border:1px solid var(--border);
}

.filter-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
}

.filter-header strong{
  font-size:13px;
}

.clear-btn{
  font-size:12px;
  background:#e5e7eb;
  color:var(--text);
  border:none;
  border-radius:999px;
  padding:4px 10px;
  cursor:pointer;
  transition:background .12s ease, transform .12s ease;
}

.clear-btn:hover{
  background:#e0e7ff;
  transform:translateY(-1px);
}

.filter-row{
  display:flex;
  gap:6px;
  margin-bottom:6px;
}

.filter-input{
  flex:1;
  min-width:0;
  padding:7px 8px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#f9fafb;
  color:var(--text);
  font-size:14px;
  transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
}

.filter-input.small{
  flex:1 1 30%;
  padding:5px 6px;
  font-size:14px;
}

.filter-input::placeholder{color:#9ca3af}

.filter-input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
  background:#ffffff;
}

@media(max-width:480px){
  .filter-row{flex-wrap:wrap}
  .filter-input{flex:1 1 48%}
  .filter-input.small{flex:1 1 30%}
}

/* ITEM */
.item{
  background:var(--card);
  border-radius:16px;
  padding:9px 9px 10px;
  margin-bottom:7px;
  box-shadow:0 4px 12px rgba(148,163,184,.35);
  color:var(--text);
  border:1px solid rgba(226,232,240,0.9);
}

.part-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:8px;
}

.part{
  font-weight:700;
  color:var(--primary);
}

.part.ok{
  color:var(--ok);
}

.part.warn{
  color:var(--warn);
}

.location{
  font-size:12px;
  color:var(--muted);
}

.name{
  font-size:13px;
  margin-top:2px;
}

.meta{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
}

.status{
  font-size:12px;
  margin-top:4px;
}

/* ŸÖÿ®Ÿäÿπÿßÿ™ */
.sales-item .part.ok{
  color:var(--primary);
}

/* ÿ•ÿ®ÿ±ÿßÿ≤ ŸÅÿ±ŸÇ ŸÉÿ®Ÿäÿ± */
.item[style*="border:2px solid"]{
  background:#fff7ed;
}

/* DETAIL */
.detail-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  z-index:9999;
}

.detail-card{
  width:100%;
  max-width:430px;
  background:var(--card);
  border-radius:18px 18px 0 0;
  padding:12px;
  color:var(--text);
  box-shadow:0 -8px 25px rgba(15,23,42,0.45);
  border-top:1px solid var(--border);
  max-height:90vh;
  overflow-y:auto;
}

.detail-header{
  display:flex;
  justify-content:space-between;
  font-weight:600;
  margin-bottom:10px;
}

.detail-close{
  border:none;
  background:none;
  font-size:18px;
  cursor:pointer;
  color:var(--muted);
}

.detail-label{
  font-size:12px;
  color:var(--muted);
  margin-top:10px;
  font-weight:600;
}

.detail-value{
  font-size:13px;
  color:var(--text);
  margin-top:4px;
  padding:8px;
  background:#f9fafb;
  border-radius:8px;
  border:1px solid var(--border);
}

.detail-qty-box{
  display:flex;
  gap:8px;
  margin-top:6px;
}

.detail-qty-box button{
  width:40px;
  border:none;
  border-radius:10px;
  font-size:20px;
  cursor:pointer;
  background:#e5e7eb;
  color:#0f172a;
  transition:background .12s ease, transform .12s ease;
}

.detail-qty-box button:hover{
  background:#dbeafe;
  transform:translateY(-1px);
}

.detail-qty-box input{
  flex:1;
  text-align:center;
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px;
  background:#f9fafb;
  color:var(--text);
}

.detail-qty-box input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
}

.detail-save{
  width:100%;
  margin-top:12px;
  padding:10px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#2563eb,#7c3aed);
  color:#fff;
  cursor:pointer;
  transition:opacity .12s ease, transform .12s ease, box-shadow .12s ease;
  box-shadow:
    0 12px 26px rgba(37,99,235,0.45),
    0 0 0 1px rgba(129,140,248,0.75);
}

.detail-save:hover:enabled{
  transform:translateY(-1px);
  box-shadow:
    0 16px 34px rgba(37,99,235,0.55),
    0 0 0 1px rgba(129,140,248,0.9);
}

#newLoc,#note{
  background:#f9fafb;
  border:1px solid var(--border);
  color:var(--text);
}

#newLoc:focus,#note:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
}

/* SCANNER */
#scannerContainer{
  display:none;
  max-width:430px;
  margin:6px auto;
  background:#020617;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 10px 28px rgba(15,23,42,0.65);
}

/* Success notification */
.success-notify{
  position:fixed;
  bottom:20px;
  left:20px;
  right:20px;
  max-width:400px;
  background:#16a34a;
  color:#fff;
  padding:12px 16px;
  border-radius:10px;
  box-shadow:0 8px 20px rgba(15,23,42,0.4);
  animation:slideUp .3s ease;
  z-index:9998;
}

/* Update indicator */
.update-badge{
  position:fixed;
  top:12px;
  right:12px;
  background:#2563eb;
  color:#fff;
  padding:6px 12px;
  border-radius:999px;
  font-size:11px;
  font-weight:600;
  box-shadow:0 4px 12px rgba(37,99,235,0.5);
  animation:pulse .6s ease infinite;
  z-index:100;
}

@keyframes pulse{
  0%,100%{opacity:1;transform:scale(1)}
  50%{opacity:0.8;transform:scale(1.05)}
}

.conflict-notify{
  position:fixed;
  bottom:20px;
  left:20px;
  right:20px;
  max-width:400px;
  background:#dc2626;
  color:#fff;
  padding:12px 16px;
  border-radius:10px;
  box-shadow:0 8px 20px rgba(15,23,42,0.4);
  animation:slideUp .3s ease;
  z-index:9998;
}

@keyframes slideUp{
  from{
    opacity:0;
    transform:translateY(20px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

/* SALES DETAIL MODAL */
.sales-detail-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  z-index:9999;
}

.sales-detail-card{
  width:100%;
  max-width:430px;
  background:var(--card);
  border-radius:18px 18px 0 0;
  padding:12px;
  color:var(--text);
  box-shadow:0 -8px 25px rgba(15,23,42,0.45);
  border-top:1px solid var(--border);
  max-height:90vh;
  overflow-y:auto;
}

.sales-detail-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:600;
  margin-bottom:12px;
  padding-bottom:10px;
  border-bottom:1px solid var(--border);
}

.sales-detail-close{
  border:none;
  background:none;
  font-size:18px;
  cursor:pointer;
  color:var(--muted);
}

.info-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
  padding:8px;
  background:#f9fafb;
  border-radius:8px;
  font-size:13px;
}

.info-label{
  font-weight:600;
  color:var(--muted);
}

.info-value{
  color:var(--text);
  font-weight:700;
}

.price-section{
  margin-top:16px;
  padding:12px;
  background:#eff6ff;
  border-radius:12px;
  border:1px solid rgba(37,99,235,0.3);
}

.price-input-group{
  margin-top:12px;
}

.price-input-group label{
  display:block;
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
  font-weight:600;
}

.price-input-group input{
  width:100%;
  padding:10px;
  border:1px solid var(--border);
  border-radius:10px;
  background:#fff;
  color:var(--text);
  font-size:14px;
}

.price-input-group input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
}

.calc-results{
  margin-top:12px;
  padding:10px;
  background:#ffffff;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:12px;
}

.calc-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
  padding:6px 0;
}

.calc-row:last-child{
  margin-bottom:0;
  padding-top:8px;
  border-top:2px solid var(--border);
  font-weight:700;
  font-size:13px;
}

.calc-label{
  color:var(--muted);
}

.calc-value{
  color:var(--text);
  font-weight:700;
  text-align:left;
}

.no-calc{
  color:var(--muted);
  text-align:center;
  padding:10px;
  font-size:12px;
}

<style>
/* CART MODAL */
.cart-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  z-index:9999;
}

.cart-card{
  width:100%;
  max-width:430px;
  background:var(--card);
  border-radius:18px 18px 0 0;
  padding:12px;
  color:var(--text);
  box-shadow:0 -8px 25px rgba(15,23,42,0.45);
  border-top:1px solid var(--border);
  max-height:90vh;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
}

.cart-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:600;
  margin-bottom:12px;
  padding-bottom:10px;
  border-bottom:1px solid var(--border);
}

.cart-close{
  border:none;
  background:none;
  font-size:18px;
  cursor:pointer;
  color:var(--muted);
}

.cart-table-wrapper{
  flex:1;
  overflow-y:auto;
  margin-bottom:12px;
  max-height:45vh;
}

.cart-table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}

.cart-table thead th{
  background:#eff6ff;
  color:var(--primary);
  padding:8px 4px;
  text-align:right;
  font-weight:700;
  border-bottom:2px solid rgba(37,99,235,0.3);
  position:sticky;
  top:0;
}

.cart-table-header-num,
.cart-table-header-part,
.cart-table-header-desc,
.cart-table-header-qty,
.cart-table-header-price,
.cart-table-header-remove{
  padding:8px 4px;
  text-align:right;
}

.cart-table-header-num{width:30px}
.cart-table-header-part{width:60px}
.cart-table-header-desc{width:auto}
.cart-table-header-qty{width:55px}
.cart-table-header-price{width:70px}
.cart-table-header-remove{width:30px}

.cart-table tbody tr{
  border-bottom:1px solid var(--border);
  position:relative;
  cursor:pointer;
  transition:background-color 0.2s ease;
}

.cart-table tbody tr:hover{
  background-color:#f1f5f9;
}

.cart-row.selected{
  outline:2px solid #2563eb;
  outline-offset:-2px;
  background:#e5f0ff;
}

.cart-table td{
  padding:6px 4px;
  vertical-align:middle;
}

.cart-table-num{
  text-align:center;
  color:var(--muted);
  font-weight:600;
}

.cart-table-part{
  font-weight:700;
  color:var(--primary);
}

.cart-table-desc{
  color:var(--muted);
  font-size:11px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.cart-table-qty-cell,
.cart-table-price-cell{
  text-align:center;
}

.cart-table-qty-input{
  width:45px;
  padding:4px 2px;
  text-align:center;
  border:1px solid var(--border);
  border-radius:4px;
  font-size:11px;
  -moz-appearance:textfield;
}

.cart-table-qty-input::-webkit-inner-spin-button,
.cart-table-qty-input::-webkit-outer-spin-button{
  -webkit-appearance:none;
  margin:0;
}

.cart-table-price-input{
  width:60px;
  padding:4px 2px;
  text-align:center;
  border:1px solid var(--border);
  border-radius:4px;
  font-size:11px;
  -moz-appearance:textfield;
}

.cart-table-price-input::-webkit-inner-spin-button,
.cart-table-price-input::-webkit-outer-spin-button{
  -webkit-appearance:none;
  margin:0;
}

.cart-remove-btn{
  width:26px;
  height:26px;
  border-radius:8px;
  border:1px solid rgba(239,68,68,0.4);
  background:#fef2f2;
  color:#b91c1c;
  font-size:12px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
}

.cart-empty{
  text-align:center;
  color:var(--muted);
  padding:30px 10px;
  font-size:13px;
}

/* ÿ¥ÿ±Ÿäÿ∑ ÿ™ŸÅÿµŸäŸÑ ÿßŸÑÿ±ÿ®ÿ≠ ŸÑŸÑÿµŸÜŸÅ ÿßŸÑŸÖÿ≠ÿØÿØ */
.active-item-panel{
  padding:8px;
  background:#eff6ff;
  border-radius:8px;
  border:2px solid #2563eb;
  margin-bottom:8px;
  display:none;
}

.active-item-panel-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}

.active-item-panel-header strong{
  color:#2563eb;
  font-size:13px;
}

.active-item-panel-badge{
  font-size:11px;
  background:#2563eb;
  color:white;
  padding:2px 6px;
  border-radius:8px;
}

.active-item-panel-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:white;
  padding:6px 8px;
  border-radius:6px;
  font-size:12px;
  margin-bottom:4px;
}

.active-item-panel-row:last-child{
  margin-bottom:0;
}

.active-item-panel-label{
  color:#6b7280;
  font-weight:600;
}

.active-item-panel-value{
  font-weight:700;
  direction:ltr;
}

.active-item-panel-profit{
  color:#16a34a;
  font-weight:700;
  direction:ltr;
}

.active-item-panel-loss{
  color:#dc2626;
  font-weight:700;
  direction:ltr;
}

/* ÿ•ÿ¨ŸÖÿßŸÑŸäÿßÿ™ ÿßŸÑÿ≥ŸÑÿ© */
.cart-totals{
  margin-top:auto;
  padding:12px;
  background:#eff6ff;
  border-radius:12px;
  border:1px solid rgba(37,99,235,0.3);
  font-size:12px;
}

.total-row{
  display:flex;
  justify-content:space-between;
  padding:8px 0;
  border-bottom:1px solid rgba(37,99,235,0.2);
}

.total-row:last-child{
  border-bottom:none;
  padding-top:10px;
  border-top:2px solid rgba(37,99,235,0.3);
  font-weight:700;
  color:var(--primary);
  font-size:13px;
}

.cart-actions{
  display:flex;
  gap:8px;
  margin-top:12px;
}

.cart-clear-btn{
  flex:1;
  padding:10px;
  border:1px solid var(--border);
  border-radius:999px;
  background:#fff;
  color:var(--text);
  cursor:pointer;
  font-weight:600;
}

.cart-checkout-btn{
  flex:1;
  padding:10px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#16a34a,#15803d);
  color:#fff;
  cursor:pointer;
  font-weight:600;
  box-shadow:0 4px 12px rgba(22,163,74,0.3);
}
</style>

<script>
/* CART FUNCTIONS */
let SALES_CART = [];
let ACTIVE_CART_ITEM = null;

function addToCart(item){
  const existing = SALES_CART.find(c => c.part === item.part);
  if(!existing){
    SALES_CART.push({
      ...item,
      cartQty: 1,
      sellPrice: Number(item.sellPrice || 0)
    });
  }else{
    existing.cartQty = Number(existing.cartQty || 0) + 1;
  }
  updateCartDisplay();
  runSearchSales();
}

function removeFromCart(part){
  SALES_CART = SALES_CART.filter(c => c.part !== part);
  if(ACTIVE_CART_ITEM && ACTIVE_CART_ITEM.part === part){
    ACTIVE_CART_ITEM = null;
  }
  updateCartDisplay();
  runSearchSales();
}

function updateCartDisplay(){
  const btn = document.getElementById("cartBtn");
  const badge = document.getElementById("cartCount");
  const count = SALES_CART.reduce((sum,it)=> sum + Number(it.cartQty || 0),0);
  if(count > 0){
    btn.style.display = "inline-flex";
    badge.style.display = "flex";
    badge.textContent = count;
  }else{
    btn.style.display = "none";
    badge.style.display = "none";
  }
}

/* ŸÅÿ™ÿ≠ ÿßŸÑÿ≥ŸÑÿ© */
function openCart(){
  const overlay = document.createElement("div");
  overlay.className = "cart-overlay";

  const card = document.createElement("div");
  card.className = "cart-card";

  const header = document.createElement("div");
  header.className = "cart-header";
  header.innerHTML = `
    <span>ÿπÿ±ÿ®ÿ© ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ üõí</span>
    <button class="cart-close" onclick="closeCart()">‚úï</button>
  `;
  card.appendChild(header);

  const tableWrap = document.createElement("div");
  tableWrap.className = "cart-table-wrapper";

  const table = document.createElement("table");
  table.className = "cart-table";
  table.innerHTML = `
    <thead>
      <tr>
        <th class="cart-table-header-num">#</th>
        <th class="cart-table-header-part">ÿßŸÑÿµŸÜŸÅ</th>
        <th class="cart-table-header-desc">ÿßŸÑŸàÿµŸÅ</th>
        <th class="cart-table-header-qty">ÿßŸÑŸÉŸÖŸäÿ©</th>
        <th class="cart-table-header-price">ÿßŸÑÿ≥ÿπÿ±</th>
        <th class="cart-table-header-remove"></th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector("tbody");

  if(SALES_CART.length === 0){
    const emptyTr = document.createElement("tr");
    const emptyTd = document.createElement("td");
    emptyTd.colSpan = 6;
    emptyTd.className = "cart-empty";
    emptyTd.textContent = "ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©ÿå ÿ£ÿ∂ŸÅ ÿ£ÿµŸÜÿßŸÅ ŸÖŸÜ ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™";
    emptyTr.appendChild(emptyTd);
    tbody.appendChild(emptyTr);
  }else{
    SALES_CART.forEach((it,idx)=>{
      const tr = document.createElement("tr");
      tr.dataset.part = it.part;

      if(ACTIVE_CART_ITEM && ACTIVE_CART_ITEM.part === it.part){
        tr.classList.add("selected");
      }

      const tdNum = document.createElement("td");
      tdNum.className = "cart-table-num";
      tdNum.textContent = idx + 1;

      const tdPart = document.createElement("td");
      tdPart.className = "cart-table-part";
      tdPart.textContent = it.part || "";

      const tdDesc = document.createElement("td");
      tdDesc.className = "cart-table-desc";
      tdDesc.textContent = it.name || "";

      const tdQty = document.createElement("td");
      tdQty.className = "cart-table-qty-cell";
      const qtyInput = document.createElement("input");
      qtyInput.type = "number";
      qtyInput.min = "1";
      qtyInput.className = "cart-table-qty-input";
      qtyInput.value = it.cartQty || 1;
      qtyInput.oninput = (e)=>{
        const v = Number(e.target.value || 0);
        if(v <= 0) return;
        it.cartQty = v;
        if(ACTIVE_CART_ITEM && ACTIVE_CART_ITEM.part === it.part){
          ACTIVE_CART_ITEM.cartQty = v;
          updateProfitPanel();
        }
        updateCartTotals();
        updateCartDisplay();
      };
      tdQty.appendChild(qtyInput);

      const tdPrice = document.createElement("td");
      tdPrice.className = "cart-table-price-cell";
      const priceInput = document.createElement("input");
      priceInput.type = "number";
      priceInput.min = "0";
      priceInput.step = "0.01";
      priceInput.className = "cart-table-price-input";
      priceInput.value = it.sellPrice || 0;
      priceInput.oninput = (e)=>{
        const v = Number(e.target.value || 0);
        it.sellPrice = v;
        if(ACTIVE_CART_ITEM && ACTIVE_CART_ITEM.part === it.part){
          ACTIVE_CART_ITEM.sellPrice = v;
          updateProfitPanel();
        }
        updateCartTotals();
      };
      tdPrice.appendChild(priceInput);

      const tdRem = document.createElement("td");
      const remBtn = document.createElement("button");
      remBtn.className = "cart-remove-btn";
      remBtn.textContent = "‚úï";
      remBtn.onclick = (ev)=>{
        ev.stopPropagation();
        removeFromCart(it.part);
        overlay.remove();
        openCart();
      };
      tdRem.appendChild(remBtn);

      tr.appendChild(tdNum);
      tr.appendChild(tdPart);
      tr.appendChild(tdDesc);
      tr.appendChild(tdQty);
      tr.appendChild(tdPrice);
      tr.appendChild(tdRem);

      tr.onclick = (ev)=>{
        if(ev.target === qtyInput || ev.target === priceInput || ev.target === remBtn) return;
        selectCartItem(it.part);
      };

      tbody.appendChild(tr);
    });
  }

  tableWrap.appendChild(table);
  card.appendChild(tableWrap);

  /* ÿ¥ÿ±Ÿäÿ∑ ÿ™ŸÅÿµŸäŸÑ ÿ±ÿ®ÿ≠ ÿßŸÑÿµŸÜŸÅ ÿßŸÑŸÖÿ≠ÿØÿØ */
  const profitPanel = document.createElement("div");
  profitPanel.id = "activeItemProfitPanel";
  profitPanel.className = "active-item-panel";
  profitPanel.innerHTML = `
    <div class="active-item-panel-header">
      <strong>üßÆ ÿ≠ÿ≥ÿßÿ® ÿ£ÿ±ÿ®ÿßÿ≠ ÿßŸÑÿµŸÜŸÅ</strong>
      <span class="active-item-panel-badge" id="activeItemCodeBadge">‚Äî</span>
    </div>
    <div class="active-item-panel-row">
      <span class="active-item-panel-label">ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©</span>
      <span class="active-item-panel-value" id="activeItemCostValue">0.00</span>
    </div>
    <div class="active-item-panel-row">
      <span class="active-item-panel-label">ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</span>
      <span class="active-item-panel-value" id="activeItemSellValue">0.00</span>
    </div>
    <div class="active-item-panel-row">
      <span class="active-item-panel-label">ÿßŸÑÿ±ÿ®ÿ≠</span>
      <span class="active-item-panel-value" id="activeItemProfitValue">0.00 (0%)</span>
    </div>
  `;
  card.appendChild(profitPanel);

  /* ÿ•ÿ¨ŸÖÿßŸÑŸäÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© */
  const totals = document.createElement("div");
  totals.className = "cart-totals";
  totals.innerHTML = `
    <div class="total-row">
      <span>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÉŸÑŸÅÿ©:</span>
      <span id="cartTotalCost">0.00</span>
    </div>
    <div class="total-row">
      <span>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≥ÿπÿ± ÿßŸÑÿ¨ÿØŸäÿØ:</span>
      <span id="cartTotalSell">0.00</span>
    </div>
    <div class="total-row">
      <span>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ±ÿ®ÿ≠:</span>
      <span id="cartTotalProfit">0.00 (0%)</span>
    </div>
    <div class="total-row">
      <span>ŸÖÿπ ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ© %15:</span>
      <span id="cartTotalWithTax">0.00</span>
    </div>
  `;
  card.appendChild(totals);

  const actions = document.createElement("div");
  actions.className = "cart-actions";
  actions.innerHTML = `
    <button class="cart-clear-btn" onclick="clearCart()">ŸÖÿ≥ÿ≠ ÿßŸÑÿπÿ±ÿ®ÿ©</button>
    <button class="cart-checkout-btn" onclick="checkoutCart()">ÿ•ŸÜŸáÿßÿ° ‚úî</button>
  `;
  card.appendChild(actions);

  overlay.appendChild(card);
  document.body.appendChild(overlay);

  updateCartTotals();
  if(ACTIVE_CART_ITEM){
    updateProfitPanel();
  }
}

/* ÿßÿÆÿ™Ÿäÿßÿ± ÿµŸÅ Ÿàÿ™ŸÅÿµŸäŸÑ ÿ±ÿ®ÿ≠Ÿá */
function selectCartItem(part){
  const item = SALES_CART.find(c => c.part === part);
  if(!item) return;
  ACTIVE_CART_ITEM = {...item};

  const rows = document.querySelectorAll(".cart-table tbody tr");
  rows.forEach(r=>{
    if(r.dataset.part === part) r.classList.add("selected");
    else r.classList.remove("selected");
  });

  updateProfitPanel();
}

function updateProfitPanel(){
  const panel = document.getElementById("activeItemProfitPanel");
  if(!panel || !ACTIVE_CART_ITEM){
    if(panel) panel.style.display = "none";
    return;
  }
  const qty = Number(ACTIVE_CART_ITEM.cartQty || 0);
  const cost = Number(ACTIVE_CART_ITEM.cost || 0);
  const sell = Number(ACTIVE_CART_ITEM.sellPrice || 0);

  const totalCost = qty * cost;
  const totalSell = qty * sell;
  const profit = totalSell - totalCost;
  const profitPct = totalSell > 0 ? (profit / totalSell) * 100 : 0;

  document.getElementById("activeItemCodeBadge").textContent =
    (ACTIVE_CART_ITEM.part || "") + " √ó " + qty;

  document.getElementById("activeItemCostValue").textContent =
    totalCost.toFixed(2);

  document.getElementById("activeItemSellValue").textContent =
    totalSell.toFixed(2);

  const profitEl = document.getElementById("activeItemProfitValue");
  const pctTxt = profitPct.toFixed(1) + "%";
  profitEl.textContent = profit.toFixed(2) + " (" + pctTxt + ")";
  profitEl.className =
    "active-item-panel-value " + (profit >= 0 ? "active-item-panel-profit" : "active-item-panel-loss");

  panel.style.display = "block";
}

/* ÿ•ÿ¨ŸÖÿßŸÑŸäÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© */
function updateCartTotals(){
  let totalCost = 0;
  let totalSell = 0;
  SALES_CART.forEach(it=>{
    const qty = Number(it.cartQty || 0);
    const cost = Number(it.cost || 0);
    const sell = Number(it.sellPrice || 0);
    totalCost += qty * cost;
    totalSell += qty * sell;
  });
  const profit = totalSell - totalCost;
  const profitPct = totalSell > 0 ? (profit / totalSell) * 100 : 0;
  const withTax = totalSell * 1.15;

  const tc = document.getElementById("cartTotalCost");
  const ts = document.getElementById("cartTotalSell");
  const tp = document.getElementById("cartTotalProfit");
  const tw = document.getElementById("cartTotalWithTax");
  if(tc) tc.textContent = totalCost.toFixed(2);
  if(ts) ts.textContent = totalSell.toFixed(2);
  if(tp) tp.textContent = profit.toFixed(2) + " (" + profitPct.toFixed(1) + "%)";
  if(tw) tw.textContent = withTax.toFixed(2);
}

function closeCart(){
  const overlay = document.querySelector(".cart-overlay");
  if(overlay) overlay.remove();
}

function clearCart(){
  if(!confirm("ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿµŸÜÿßŸÅ ŸÖŸÜ ÿßŸÑÿπÿ±ÿ®ÿ©ÿü")) return;
  SALES_CART = [];
  ACTIVE_CART_ITEM = null;
  updateCartDisplay();
  closeCart();
}

function checkoutCart(){
  if(SALES_CART.length === 0){
    alert("ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©");
    return;
  }
  alert("ŸáŸÜÿß ÿ™ÿ∂ÿπ ŸÖŸÜÿ∑ŸÇ ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÅŸä ÿßŸÑÿ¥Ÿäÿ™ ÿ£Ÿà ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ≠ÿßÿ≥ÿ®Ÿä");
}
</script>

</body>
</html>
