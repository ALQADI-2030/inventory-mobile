<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>جرد المخزون</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">

<style>
:root{
  --bg:#f4f5f7;
  --card:#fff;
  --primary:#1976d2;
  --danger:#c62828;
  --text:#222;
  --muted:#777;
  --border:#e0e0e0;
}

body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  background:var(--bg);
}

/* ===== LOGIN ===== */
.login-wrap{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.login-card{
  width:340px;
  background:var(--card);
  border-radius:14px;
  padding:22px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
  text-align:center;
}

.login-title{
  font-size:18px;
  font-weight:700;
  margin-bottom:6px;
}

.login-sub{
  font-size:13px;
  color:var(--muted);
  margin-bottom:18px;
}

.login-input{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid var(--border);
  font-size:14px;
}

.login-btn{
  width:100%;
  padding:11px;
  border:none;
  border-radius:10px;
  background:var(--primary);
  color:#fff;
  font-size:15px;
  cursor:pointer;
}

.login-error{
  margin-top:12px;
  font-size:13px;
  color:var(--danger);
  display:none;
}

/* ===== APP ===== */
#appScreen{
  display:none;
  padding:8px;
}

.top-bar{
  max-width:430px;
  margin:0 auto 8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.top-title{
  font-size:15px;
  font-weight:700;
}

.icon-btn{
  width:32px;
  height:32px;
  border:none;
  border-radius:8px;
  background:#fff;
  box-shadow:0 1px 4px rgba(0,0,0,.15);
  cursor:pointer;
}

#results{
  max-width:430px;
  margin:0 auto;
}

.item{
  background:#fff;
  border-radius:12px;
  padding:10px;
  margin-bottom:8px;
  box-shadow:0 3px 8px rgba(0,0,0,.06);
}

.part{
  font-weight:700;
  color:var(--primary);
}

.msg{
  text-align:center;
  color:var(--muted);
  padding:14px;
}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div id="loginScreen" class="login-wrap">
  <div class="login-card">
    <div class="login-title">تسجيل الدخول</div>
    <div class="login-sub">أدخل اسم المستخدم والرقم السري</div>

    <input id="loginUser" class="login-input" placeholder="اسم المستخدم">
    <input id="loginPass" type="password" class="login-input" placeholder="الرقم السري">

    <button class="login-btn" onclick="login()">دخول</button>

    <div id="loginError" class="login-error"></div>
  </div>
</div>

<!-- ================= APP ================= -->
<div id="appScreen">
  <div class="top-bar">
    <div class="top-title">جرد المخزون</div>
    <button class="icon-btn" onclick="loadData()">⟳</button>
  </div>

  <div id="results"></div>
</div>

<script>
/* ===== CONFIG ===== */
const API = "https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";

/* ===== LOGIN ===== */
function login(){
  const u = loginUser.value.trim();
  const p = loginPass.value.trim();

  if(!u || !p){
    showError("يرجى إدخال اسم المستخدم والرقم السري");
    return;
  }

  fetch(`${API}?action=login&username=${encodeURIComponent(u)}&password=${encodeURIComponent(p)}`)
    .then(r=>r.json())
    .then(res=>{
      if(!res.ok){
        showError(res.error || "بيانات الدخول غير صحيحة");
        return;
      }

      localStorage.setItem("user", JSON.stringify(res.user));
      loginScreen.style.display="none";
      appScreen.style.display="block";
      loadData();
    })
    .catch(()=>showError("فشل الاتصال بالسيرفر"));
}

function showError(msg){
  const e = document.getElementById("loginError");
  e.textContent = msg;
  e.style.display = "block";
}

/* ===== LOAD DATA ===== */
function loadData(){
  fetch(API)
    .then(r=>r.json())
    .then(d=>{
      if(!Array.isArray(d)){
        results.innerHTML = "<div class='msg'>فشل تحميل البيانات</div>";
        return;
      }
      render(d);
    })
    .catch(()=>{
      results.innerHTML = "<div class='msg'>خطأ في الاتصال</div>";
    });
}

/* ===== RENDER ===== */
function render(data){
  if(!data.length){
    results.innerHTML = "<div class='msg'>لا توجد بيانات</div>";
    return;
  }

  let h = "";
  data.forEach(r=>{
    h += `
      <div class="item">
        <div class="part">${r.part || ""}</div>
        <div>${r.name || ""}</div>
        <div>الكمية المتوفرة: ${r.qty ?? 0}</div>
      </div>
    `;
  });
  results.innerHTML = h;
}
</script>

</body>
</html>
