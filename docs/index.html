<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>جرد المخزون</title>

<style>
body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background:#f2f4f7;
  margin:0;
  padding:8px;
}

/* شريط علوي صغير */
.top-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}
.top-title{
  font-size:16px;
  font-weight:600;
  color:#333;
}
.top-actions{
  display:flex;
  gap:6px;
}
.icon-btn{
  width:34px;
  height:34px;
  border:none;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  background:#fff;
  box-shadow:0 1px 4px rgba(0,0,0,.12);
  color:#333;
}

/* كرت الفلترة صغير */
.card{
  background:#fff;
  border-radius:14px;
  padding:8px;
  box-shadow:0 3px 8px rgba(0,0,0,.06);
  margin-bottom:8px;
}

.row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:6px;
  margin-bottom:6px;
}

input{
  padding:10px;
  font-size:14px;
  border-radius:8px;
  border:1px solid #ddd;
}

/* نتائج */
#results{
  padding-bottom:8px;
}

.item{
  background:#fff;
  border-radius:12px;
  padding:10px;
  margin-bottom:8px;
  box-shadow:0 3px 8px rgba(0,0,0,.05);
}
.part{
  font-weight:700;
  font-size:15px;
}
.name{
  font-size:14px;
  margin-top:2px;
}
.meta{
  color:#555;
  margin-top:4px;
  font-size:13px;
}

/* صندوق الكمية */
.qty-box{
  display:flex;
  gap:6px;
  margin-top:8px;
}
.qty-box button{
  width:38px;
  font-size:18px;
  border:none;
  border-radius:10px;
  background:#eee;
}
.qty-box input{
  flex:1;
  text-align:center;
  font-size:16px;
  padding:8px;
  border-radius:8px;
  border:1px solid #ddd;
}

/* رسالة بسيطة */
.msg{
  text-align:center;
  padding:10px;
  color:#666;
  font-size:14px;
}
</style>
</head>

<body>

<div class="top-bar">
  <div class="top-title">بحث المخزون</div>
  <div class="top-actions">
    <button class="icon-btn" title="تحديث" onclick="refreshData()">⟳</button>
    <button class="icon-btn" title="مسح البحث" onclick="clearAll()">✕</button>
  </div>
</div>

<div class="card">
  <div class="row">
    <input id="pContains" placeholder="رقم الصنف يحتوي على">
    <input id="pEnds" placeholder="ينتهي بـ">
  </div>

  <div class="row">
    <input id="nStarts" placeholder="اسم الصنف يبدأ بـ">
    <input id="nContains" placeholder="اسم الصنف يحتوي على">
  </div>

  <div class="row">
    <input id="locFrom" placeholder="الموقع من">
    <input id="locTo" placeholder="الموقع إلى">
  </div>
</div>

<div id="results"></div>

<script>
/* ===== الإعدادات ===== */
const API = "https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";
const CACHE_KEY = "inventory_cache_v1";
const COUNT_KEY = "count_log_v1";
const MAX_RESULTS = 100;

/* ===== البيانات ===== */
let ALL_DATA = [];

/* ===== تحميل البيانات ===== */
function loadData(){
  const cached = localStorage.getItem(CACHE_KEY);
  if(cached){
    try{
      ALL_DATA = JSON.parse(cached);
      runSearch();
    }catch(e){
      ALL_DATA = [];
    }
  }
  refreshData();
}

function refreshData(){
  fetch(API)
    .then(r=>r.json())
    .then(data=>{
      if(!Array.isArray(data)) return;
      ALL_DATA = data;
      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      runSearch();
    })
    .catch(()=>{/* أوفلاين */});
}

/* ===== الجرد أوف لاين ===== */
function saveCount(part, qty){
  const log = JSON.parse(localStorage.getItem(COUNT_KEY) || "[]");
  log.push({ part, qty:Number(qty), time:new Date().toISOString() });
  localStorage.setItem(COUNT_KEY, JSON.stringify(log));
}

function getLastCount(part){
  const log = JSON.parse(localStorage.getItem(COUNT_KEY) || "[]");
  for(let i=log.length-1;i>=0;i--){
    if(log[i].part===part) return log[i].qty;
  }
  return null;
}

/* ===== البحث ===== */
document.querySelectorAll(".card input").forEach(i=>{
  i.addEventListener("input", debounce);
});

let timer=null;
function debounce(){
  clearTimeout(timer);
  timer=setTimeout(runSearch,400);
}

function runSearch(){
  if(!ALL_DATA.length){
    document.getElementById("results").innerHTML =
      "<div class='msg'>جاري تحميل البيانات...</div>";
    return;
  }

  const pC = pContains.value.trim().toLowerCase();
  const pE = pEnds.value.trim().toLowerCase();
  const nS = nStarts.value.trim().toLowerCase();
  const nC = nContains.value.trim().toLowerCase();
  const lF = locFrom.value.trim().toLowerCase();
  const lT = locTo.value.trim().toLowerCase();

  const res = [];
  for(const r of ALL_DATA){
    const part = (r.part||"").toLowerCase();
    const name = (r.name||"").toLowerCase();
    const loc  = (r.location||"").toLowerCase();

    if(pC && !part.includes(pC)) continue;
    if(pE && !part.endsWith(pE)) continue;
    if(nS && !name.startsWith(nS)) continue;
    if(nC && !name.includes(nC)) continue;
    if(lF && loc < lF) continue;
    if(lT && loc > lT) continue;

    res.push(r);
    if(res.length>=MAX_RESULTS) break; // حد النتائج للجوال
  }

  render(res);
}

/* ===== العرض ===== */
function render(data){
  const el = document.getElementById("results");
  if(!data.length){
    el.innerHTML = "<div class='msg'>لا توجد نتائج</div>";
    return;
  }

  let html = "";
  data.forEach(r=>{
    const counted = getLastCount(r.part);
    const showQty = counted!==null ? counted : r.qty;

    html += `
      <div class="item">
        <div class="part">${r.part || ""}</div>
        <div class="name">${r.name || ""}</div>
        <div class="meta">
          الكمية: <b>${showQty ?? ""}</b> | الموقع: ${r.location || ""}
        </div>
        <div class="qty-box">
          <button onclick="adjust('${r.part}', ${Number(showQty||0)-1})">−</button>
          <input value="${showQty ?? 0}" 
                 onblur="adjust('${r.part}', this.value)">
          <button onclick="adjust('${r.part}', ${Number(showQty||0)+1})">+</button>
        </div>
      </div>
    `;
  });
  el.innerHTML = html;
}

/* ===== تعديل الكمية ===== */
function adjust(part, qty){
  qty = Number(qty);
  if(isNaN(qty) || qty<0) qty=0;
  saveCount(part, qty);
  runSearch();
}

/* ===== أدوات ===== */
function clearAll(){
  document.querySelectorAll(".card input").forEach(i=>i.value="");
  document.getElementById("results").innerHTML = "";
}

loadData();
</script>

</body>
</html>
