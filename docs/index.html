function render(data){const el=document.getElementById("results");if(!data.length){el.innerHTML="<div class='msg'>لا توجد نتائج</div>";return}let h="";data.forEach(r=>{const sq=Number(r.qty)||0;const cq=Number(r.countedQty||0);const ic=cq>0;const pc=ic?"part part-counted":"part";const sp=String(r.part||"").replace(/'/g,"\\'");h+=`<div class="item" onclick="openDetail('${sp}')"><div class="part-row"><div class="${pc}">${r.part||""}</div><button class="edit-btn" onclick="event.stopPropagation();openDetail('${sp}')">✎</button></div><div class="name">${r.name||""}</div><div class="meta-line"><span class="meta-right">النظام: <b>${sq}</b></span><span class="meta-left">الموقع: ${r.location||"-"}</span></div><div class="meta-second">الجرد: <b>${cq}</b></div></div>`});el.innerHTML=h}function openDetail(part){const it=ALL_DATA.find(r=>String(r.part)===String(part));if(!it)return;const cq=Number(it.countedQty||0);const lu=it.lastCountUser||"";const lt=it.lastCountTime?("آخر جرد: "+it.lastCountTime+(lu?" - "+lu:"")):"";const ov=document.createElement("div");ov.className="detail-overlay";const sp=String(it.part||"").replace(/'/g,"\\'");const sn=String(it.name||"").replace(/'/g,"\\'");ov.innerHTML=`<div class="detail-card"><div class="detail-header"><span>تفاصيل</span><button class="detail-close" onclick="this.closest('.detail-overlay').remove()">✕</button></div><div class="detail-body"><div class="detail-label">رقم الصنف</div><div class="detail-value">${it.part||""}</div><div class="detail-label">اسم الصنف</div><div class="detail-value">${it.name||""}</div><div class="detail-label">الموقع</div><div class="detail-value">${it.location||"-"}</div><div class="detail-label">كمية النظام</div><div class="detail-value">${it.qty??""}</div><div class="detail-label">كمية الجرد</div><div class="detail-qty-box"><button onclick="changeQty(-1)">−</button><input id="detailQty" type="number" value="${cq}"><button onclick="changeQty(1)">+</button></div><div class="detail-label">ملاحظات</div><textarea id="detailNote" style="width:100%;min-height:60px;margin-top:4px;border-radius:9px;border:1px solid var(--border);padding:6px;font-size:13px"></textarea><div id="detailInfo" style="margin-top:6px;font-size:12px;color:var(--muted)">${lt}</div></div><button class="detail-save" onclick="saveQty('${sp}','${sn}',${Number(it.qty)||0})">حفظ</button></div>`;document.body.appendChild(ov)}function changeQty(d){const inp=document.getElementById("detailQty");if(!inp)return;let v=Number(inp.value)||0;v+=d;if(v<0)v=0;inp.value=v}function saveQty(part,name,sq){const qi=document.getElementById("detailQty");const ni=document.getElementById("detailNote");if(!qi)return;let v=Number(qi.value)||0;if(v<0)v=0;const note=ni?ni.value.trim():"";fetch(API,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({part:part,itemName:name,systemQty:sq,countedQty:v,note:note}).toString()}).then(r=>r.json()).then(res=>{if(!res.ok){alert(res.error||"فشل الحفظ");return}alert("تم الحفظ: "+(res.user?.name||""));refreshData(true)}).catch(()=>alert("خطأ في الاتصال"));document.querySelector(".detail-overlay")?.remove()}function clearAll(){document.querySelectorAll(".filter-input").forEach(i=>i.value="");document.getElementById("results").innerHTML=""}setInterval(
function render(data){const el=document.getElementById("results");if(!data.length){el.innerHTML="<div class='msg'>لا توجد نتائج</div>";return}let h="";data.forEach(r=>{const sq=Number(r.qty)||0;const cq=Number(r.countedQty||0);const ic=cq>0;const pc=ic?"part part-counted":"part";const sp=String(r.part||"").replace(/'/g,"\\'");h+=`<div class="item" onclick="openDetail('${sp}')"><div class="part-row"><div class="${pc}">${r.part||""}</div><button class="edit-btn" onclick="event.stopPropagation();openDetail('${sp}')">✎</button></div><div class="name">${r.name||""}</div><div class="meta-line"><span class="meta-right">النظام: <b>${sq}</b></span><span class="meta-left">الموقع: ${r.location||"-"}</span></div><div class="meta-second">الجرد: <b>${cq}</b></div></div>`});el.innerHTML=h}function openDetail(part){const it=ALL_DATA.find(r=>String(r.part)===String(part));if(!it)return;const cq=Number(it.countedQty||0);const lu=it.lastCountUser||"";const lt=it.lastCountTime?("آخر جرد: "+it.lastCountTime+(lu?" - "+lu:"")):"";const ov=document.createElement("div");ov.className="detail-overlay";const sp=String(it.part||"").replace(/'/g,"\\'");const sn=String(it.name||"").replace(/'/g,"\\'");ov.innerHTML=`<div class="detail-card"><div class="detail-header"><span>تفاصيل</span><button class="detail-close" onclick="this.closest('.detail-overlay').remove()">✕</button></div><div class="detail-body"><div class="detail-label">رقم الصنف</div><div class="detail-value">${it.part||""}</div><div class="detail-label">اسم الصنف</div><div class="detail-value">${it.name||""}</div><div class="detail-label">الموقع</div><div class="detail-value">${it.location||"-"}</div><div class="detail-label">كمية النظام</div><div class="detail-value">${it.qty??""}</div><div class="detail-label">كمية الجرد</div><div class="detail-qty-box"><button onclick="changeQty(-1)">−</button><input id="detailQty" type="number" value="${cq}"><button onclick="changeQty(1)">+</button></div><div class="detail-label">ملاحظات</div><textarea id="detailNote" style="width:100%;min-height:60px;margin-top:4px;border-radius:9px;border:1px solid var(--border);padding:6px;font-size:13px"></textarea><div id="detailInfo" style="margin-top:6px;font-size:12px;color:var(--muted)">${lt}</div></div><button class="detail-save" onclick="saveQty('${sp}','${sn}',${Number(it.qty)||0})">حفظ</button></div>`;document.body.appendChild(ov)}function changeQty(d){const inp=document.getElementById("detailQty");if(!inp)return;let v=Number(inp.value)||0;v+=d;if(v<0)v=0;inp.value=v}function saveQty(part,name,sq){const qi=document.getElementById("detailQty");const ni=document.getElementById("detailNote");if(!qi)return;let v=Number(qi.value)||0;if(v<0)v=0;const note=ni?ni.value.trim():"";fetch(API,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({part:part,itemName:name,systemQty:sq,countedQty:v,note:note}).toString()}).then(r=>r.json()).then(res=>{if(!res.ok){alert(res.error||"فشل الحفظ");return}alert("تم الحفظ: "+(res.user?.name||""));refreshData(true)}).catch(()=>alert("خطأ في الاتصال"));document.querySelector(".detail-overlay")?.remove()}function clearAll(){document.querySelectorAll(".filter-input").forEach(i=>i.value="");document.getElementById("results").innerHTML=""}setInterval(()=>{if(!isRef)refreshData(true)},60000);loadData();</script></body></html>
