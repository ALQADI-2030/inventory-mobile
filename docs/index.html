<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>جرد المخزون</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1976d2">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="جرد المخزون">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      --bg:#f4f5f7;
      --card:#fff;
      --primary:#1976d2;
      --danger:#c62828;
      --text:#222;
      --muted:#777;
      --border:#e0e0e0;
    }

    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont;
      background:var(--bg);
      margin:0;
      padding:8px;
    }

    /* ===== LOGIN ===== */
    .login-screen{
      max-width:360px;
      margin:90px auto;
      background:var(--card);
      border-radius:16px;
      padding:22px;
      box-shadow:0 8px 24px rgba(0,0,0,.15);
      text-align:center;
    }

    .login-title{
      font-size:18px;
      font-weight:700;
      margin-bottom:6px;
    }

    .login-sub{
      font-size:13px;
      color:var(--muted);
      margin-bottom:18px;
    }

    .login-btn{
      width:100%;
      padding:12px;
      border:none;
      border-radius:12px;
      background:var(--primary);
      color:#fff;
      font-size:15px;
      cursor:pointer;
    }

    .login-error{
      margin-top:12px;
      font-size:13px;
      color:var(--danger);
      display:none;
    }

    /* ===== APP ===== */
    .top-bar{
      max-width:430px;
      margin:0 auto 6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .top-title{
      font-size:15px;
      font-weight:600;
    }

    .icon-btn{
      width:30px;
      height:30px;
      border:none;
      border-radius:8px;
      background:var(--card);
      box-shadow:0 1px 4px rgba(0,0,0,.12);
      cursor:pointer;
    }

    .filter-wrap,
    #results{
      max-width:430px;
      margin:0 auto 8px;
    }

    .filter-card{
      background:var(--card);
      border-radius:12px;
      padding:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.05);
    }

    .filter-input{
      width:100%;
      padding:8px;
      border-radius:8px;
      border:1px solid var(--border);
    }

    .item{
      background:var(--card);
      border-radius:12px;
      padding:10px;
      margin-bottom:7px;
      box-shadow:0 3px 8px rgba(0,0,0,.05);
    }

    .part{
      font-weight:700;
      color:var(--primary);
    }

    .msg{
      text-align:center;
      color:var(--muted);
      padding:14px;
    }
  </style>
</head>

<body>

<!-- ================== LOGIN ================== -->
<div id="loginScreen" class="login-screen">
  <div class="login-title">تسجيل الدخول</div>
  <div class="login-sub">يجب أن يكون بريدك مسجّل في النظام</div>
  <button class="login-btn" onclick="login()">دخول</button>
  <div id="loginError" class="login-error">
    المستخدم غير مسموح له بالدخول
  </div>
</div>

<!-- ================== APP ================== -->
<div id="appScreen" style="display:none;">

  <div class="top-bar">
    <div class="top-title">جرد المخزون</div>
    <button class="icon-btn" onclick="loadData()">⟳</button>
  </div>

  <div class="filter-wrap">
    <div class="filter-card">
      <input id="search" class="filter-input"
             placeholder="ابحث برقم الصنف أو الاسم"
             oninput="runSearch()">
    </div>
  </div>

  <div id="results"></div>

</div>

<script>
/* ===== CONFIG ===== */
const API = "https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";

let ALL_DATA = [];

/* ===== LOGIN ===== */
function login(){
  fetch(API + "?action=login")
    .then(r => r.json())
    .then(res => {
      if(!res.ok){
        showLoginError();
        return;
      }
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("appScreen").style.display = "block";
      loadData();
    })
    .catch(showLoginError);
}

function showLoginError(){
  document.getElementById("loginError").style.display = "block";
}

/* ===== LOAD DATA ===== */
function loadData(){
  fetch(API)
    .then(r => r.json())
    .then(d => {
      if(!Array.isArray(d)){
        results.innerHTML = "<div class='msg'>فشل تحميل البيانات</div>";
        return;
      }
      ALL_DATA = d;
      render(d);
    })
    .catch(()=>{
      results.innerHTML = "<div class='msg'>خطأ في الاتصال</div>";
    });
}

/* ===== SEARCH ===== */
function runSearch(){
  const q = search.value.trim().toLowerCase();
  if(!q){
    render(ALL_DATA);
    return;
  }

  const f = ALL_DATA.filter(r =>
    String(r.part||"").toLowerCase().includes(q) ||
    String(r.name||"").toLowerCase().includes(q)
  );

  render(f);
}

/* ===== RENDER ===== */
function render(data){
  if(!data.length){
    results.innerHTML = "<div class='msg'>لا توجد نتائج</div>";
    return;
  }

  let h = "";
  data.forEach(r=>{
    h += `
      <div class="item">
        <div class="part">${r.part || ""}</div>
        <div>${r.name || ""}</div>
        <div>الكمية المتوفرة: ${r.qty ?? 0}</div>
      </div>
    `;
  });

  results.innerHTML = h;
}
</script>

</body>
</html>
