<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>جرد المخزون</title>

<style>
:root{
  --bg:#f4f5f7;
  --card:#ffffff;
  --primary:#1976d2;
  --green:#1b5e20;
  --text:#222;
  --muted:#777;
  --border:#e0e0e0;
}

body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background:var(--bg);
  margin:0;
  padding:8px;
}

/* شريط علوي */
.top-bar{
  max-width:430px;
  margin:0 auto 6px auto;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.top-title{
  font-size:15px;
  font-weight:600;
  color:var(--text);
}
.top-actions{
  display:flex;
  gap:6px;
}
.icon-btn{
  width:30px;
  height:30px;
  border:none;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  background:var(--card);
  box-shadow:0 1px 4px rgba(0,0,0,.12);
  color:var(--text);
}

/* كرت الفلترة */
.filter-wrap{
  max-width:430px;
  margin:0 auto 8px auto;
}
.filter-card{
  background:var(--card);
  border-radius:12px;
  padding:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
}
.filter-row{
  display:flex;
  gap:4px;
  margin-bottom:4px;
}
.filter-input{
  flex:1;
  padding:6px 7px;
  font-size:12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fafafa;
}

/* النتائج */
#results{
  max-width:430px;
  margin:0 auto 8px auto;
  padding-bottom:8px;
}
.item{
  background:var(--card);
  border-radius:12px;
  padding:9px;
  margin-bottom:7px;
  box-shadow:0 3px 8px rgba(0,0,0,.05);
}
.part-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.part{
  font-weight:700;
  font-size:14px;
  color:var(--primary);
}
.part-counted{
  color:var(--green);
}
.edit-btn{
  width:26px;
  height:26px;
  border:none;
  border-radius:7px;
  background:#f1f3f4;
  font-size:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:var(--text);
}
.name{
  font-size:13px;
  margin-top:2px;
  color:var(--text);
}
.meta-line{
  display:flex;
  justify-content:space-between;
  margin-top:4px;
  font-size:12px;
  color:var(--muted);
}
.meta-right{ text-align:right; }
.meta-left{ text-align:left; }
.meta-second{
  margin-top:2px;
  font-size:12px;
  color:var(--muted);
}

/* رسالة */
.msg{
  text-align:center;
  padding:10px;
  color:var(--muted);
  font-size:13px;
}

/* نافذة التفاصيل */
.detail-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  z-index:999;
}
.detail-card{
  width:100%;
  max-width:430px;
  background:var(--card);
  border-radius:16px 16px 0 0;
  padding:12px;
  box-shadow:0 -3px 12px rgba(0,0,0,.3);
}
.detail-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
  font-weight:600;
}
.detail-close{
  border:none;
  background:none;
  font-size:18px;
}
.detail-body{
  max-height:60vh;
  overflow-y:auto;
}
.detail-label{
  font-size:12px;
  color:var(--muted);
  margin-top:6px;
}
.detail-value{
  font-size:14px;
  color:var(--text);
  margin-top:2px;
}
.detail-qty-box{
  display:flex;
  gap:8px;
  margin-top:4px;
}
.detail-qty-box button{
  width:40px;
  font-size:20px;
  border:none;
  border-radius:10px;
  background:#f1f3f4;
}
.detail-qty-box input{
  flex:1;
  text-align:center;
  font-size:16px;
  padding:7px;
  border-radius:9px;
  border:1px solid var(--border);
}
.detail-save{
  margin-top:10px;
  width:100%;
  padding:10px;
  border:none;
  border-radius:10px;
  background:var(--primary);
  color:#fff;
  font-size:15px;
}
</style>
</head>

<body>

<div class="top-bar">
  <div class="top-title">بحث المخزون</div>
  <div class="top-actions">
    <button class="icon-btn" title="تحديث" onclick="refreshData()">⟳</button>
    <button class="icon-btn" title="مسح" onclick="clearAll()">✕</button>
  </div>
</div>

<div class="filter-wrap">
  <div class="filter-card">
    <div class="filter-row">
      <input class="filter-input" id="pContains" placeholder="رقم الصنف يحتوي على">
      <input class="filter-input" id="pEnds"     placeholder="ينتهي بـ">
    </div>
    <div class="filter-row">
      <input class="filter-input" id="nStarts"   placeholder="اسم الصنف يبدأ بـ">
      <input class="filter-input" id="nContains" placeholder="يحتوي على">
    </div>
    <div class="filter-row">
      <input class="filter-input" id="locFrom"   placeholder="الموقع من">
      <input class="filter-input" id="locTo"     placeholder="إلى">
    </div>
  </div>
</div>

<div id="results"></div>

<script>
/* إعدادات */
const API = "https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";
const CACHE_KEY = "inventory_cache_v1";
const COUNT_KEY = "count_log_v1";
const MAX_RESULTS = 100;

let ALL_DATA = [];

/* تحميل البيانات */
function loadData(){
  const cached = localStorage.getItem(CACHE_KEY);
  if(cached){
    try{
      ALL_DATA = JSON.parse(cached);
      runSearch();
    }catch(e){ ALL_DATA = []; }
  }
  refreshData();
}

function refreshData(){
  fetch(API)
    .then(r=>r.json())
    .then(data=>{
      if(!Array.isArray(data)) return;
      ALL_DATA = data;
      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      runSearch();
    })
    .catch(()=>{});
}

/* جرد أوف لاين */
function saveCount(part, qty){
  const log = JSON.parse(localStorage.getItem(COUNT_KEY) || "[]");
  log.push({ part, qty:Number(qty), time:new Date().toISOString() });
  localStorage.setItem(COUNT_KEY, JSON.stringify(log));
}
function getLastCount(part){
  const log = JSON.parse(localStorage.getItem(COUNT_KEY) || "[]");
  for(let i=log.length-1;i>=0;i--){
    if(log[i].part===part) return log[i].qty;
  }
  return null;
}

/* البحث */
document.querySelectorAll(".filter-input").forEach(i=>{
  i.addEventListener("input", debounce);
});

let timer=null;
function debounce(){
  clearTimeout(timer);
  timer=setTimeout(runSearch,400);
}

function runSearch(){
  const resEl = document.getElementById("results");
  if(!ALL_DATA.length){
    resEl.innerHTML = "<div class='msg'>جاري تحميل البيانات...</div>";
    return;
  }

  const pC = pContains.value.trim().toLowerCase();
  const pE = pEnds.value.trim().toLowerCase();
  const nS = nStarts.value.trim().toLowerCase();
  const nC = nContains.value.trim().toLowerCase();
  const lF = locFrom.value.trim().toLowerCase();
  const lT = locTo.value.trim().toLowerCase();

  const res = [];
  for(const r of ALL_DATA){
    const part = (r.part||"").toLowerCase();
    const name = (r.name||"").toLowerCase();
    const loc  = (r.location||"").toLowerCase();

    if(pC && !part.includes(pC)) continue;
    if(pE && !part.endsWith(pE)) continue;
    if(nS && !name.startsWith(nS)) continue;
    if(nC && !name.includes(nC)) continue;
    if(lF && loc < lF) continue;
    if(lT && loc > lT) continue;

    res.push(r);
  }

  if (lF || lT) {
    res.sort((a,b)=>{
      const la = (a.location||"").toString().toLowerCase();
      const lb = (b.location||"").toString().toLowerCase();
      if (la < lb) return -1;
      if (la > lb) return 1;
      return 0;
    });
  } else if (pC || pE) {
    res.sort((a,b)=>{
      const pa = (a.part||"").toString().toLowerCase();
      const pb = (b.part||"").toString().toLowerCase();
      if (pa < pb) return -1;
      if (pa > pb) return 1;
      return 0;
    });
  }

  render(res.slice(0, MAX_RESULTS));
}

/* عرض النتائج */
function render(data){
  const el = document.getElementById("results");
  if(!data.length){
    el.innerHTML = "<div class='msg'>لا توجد نتائج</div>";
    return;
  }
  let html = "";
  data.forEach(r=>{
    const counted = getLastCount(r.part);
    const systemQty = Number(r.qty) || 0;
    const countedQty = counted !== null ? counted : 0;
    const isCounted = counted !== null;

    const partClass = isCounted ? "part part-counted" : "part";

    html += `
      <div class="item" onclick="openDetail('${r.part}')">
        <div class="part-row">
          <div class="${partClass}">${r.part || ""}</div>
          <button class="edit-btn"
            onclick="event.stopPropagation(); openDetail('${r.part}')">✎</button>
        </div>
        <div class="name">${r.name || ""}</div>
        <div class="meta-line">
          <span class="meta-right">كمية النظام: <b>${systemQty}</b></span>
          <span class="meta-left">الموقع: ${r.location || "-"}</span>
        </div>
        <div class="meta-second">
          كمية الجرد الحالية: <b>${countedQty}</b>
        </div>
      </div>
    `;
  });
  el.innerHTML = html;
}

/* تفاصيل الصنف */
function openDetail(part){
  const item = ALL_DATA.find(r => String(r.part) === String(part));
  if(!item) return;

  const counted = getLastCount(item.part);
  const currentQty = counted!==null ? counted : 0;

  const overlay = document.createElement("div");
  overlay.className = "detail-overlay";
  overlay.innerHTML = `
    <div class="detail-card">
      <div class="detail-header">
        <span>تفاصيل الصنف</span>
        <button class="detail-close"
          onclick="this.closest('.detail-overlay').remove()">✕</button>
      </div>
      <div class="detail-body">
        <div class="detail-label">رقم الصنف</div>
        <div class="detail-value">${item.part || ""}</div>

        <div class="detail-label">اسم الصنف</div>
        <div class="detail-value">${item.name || ""}</div>

        <div class="detail-label">الموقع</div>
        <div class="detail-value">${item.location || "-"}</div>

        <div class="detail-label">كمية النظام</div>
        <div class="detail-value">${item.qty ?? ""}</div>

        <div class="detail-label">كمية الجرد الحالية</div>
        <div class="detail-qty-box">
          <button onclick="changeDetailQty(-1)">−</button>
          <input id="detailQty" type="number" value="${currentQty}">
          <button onclick="changeDetailQty(1)">+</button>
        </div>

        <div class="detail-label">ملاحظات الجرد</div>
        <textarea id="detailNote"
          style="width:100%;min-height:60px;margin-top:4px;
                 border-radius:9px;border:1px solid var(--border);
                 padding:6px;font-size:13px;"></textarea>

        <div id="detailInfo"
             style="margin-top:6px;font-size:12px;color:var(--muted);"></div>
      </div>
      <button class="detail-save"
        onclick="saveDetailQty('${item.part}', '${item.name || ""}', ${Number(item.qty)||0})">
        حفظ الجرد
      </button>
    </div>
  `;
  document.body.appendChild(overlay);

  checkPreviousCount(item.part);
}

/* فحص آخر جرد لنفس الصنف (محلياً) */
function checkPreviousCount(part){
  const log = JSON.parse(localStorage.getItem(COUNT_KEY) || "[]");
  if(!log.length) return;
  const last = [...log].reverse().find(l => l.part === part);
  if(!last) return;
  const info = document.getElementById("detailInfo");
  if(info){
    info.textContent = `تم جرد هذا الصنف سابقاً، آخر كمية: ${last.qty}`;
  }
}

/* تغيير الكمية داخل نافذة التفاصيل */
function changeDetailQty(delta){
  const input = document.getElementById("detailQty");
  if(!input) return;
  let v = Number(input.value)||0;
  v += delta;
  if(v<0) v=0;
  input.value = v;
}

/* حفظ الجرد (محلي + إرسال للسيرفر) */
function saveDetailQty(part, itemName, systemQty){
  const qtyInput  = document.getElementById("detailQty");
  const noteInput = document.getElementById("detailNote");
  if(!qtyInput) return;

  let v = Number(qtyInput.value)||0;
  if(v<0) v=0;
  const note = noteInput ? noteInput.value.trim() : "";

  saveCount(part, v);

  fetch(API, {
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      part: part,
      itemName: itemName,
      systemQty: systemQty,
      countedQty: v,
      note: note
    }).toString()
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.ok){
      alert(res.error || "فشل حفظ الجرد (تحقق من الصلاحيات)");
      return;
    }
    alert("تم حفظ الجرد باسم: " + (res.user?.name || ""));
  })
  .catch(()=>alert("خطأ في الاتصال"));

  document.querySelector(".detail-overlay")?.remove();
  runSearch();
}

/* أدوات */
function clearAll(){
  document.querySelectorAll(".filter-input").forEach(i=>i.value="");
  document.getElementById("results").innerHTML = "";
}

loadData();
</script>

</body>
</html>
