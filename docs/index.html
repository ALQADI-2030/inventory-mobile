<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</title>

<style>
:root{
  --bg:#f4f6f8;
  --card:#ffffff;
  --primary:#1976d2;
  --ok:#1b5e20;
  --warn:#c62828;
  --text:#222;
  --muted:#777;
  --border:#e0e0e0;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:var(--bg);
  padding:8px;
}

/* ===== LOGIN ===== */
.login-screen{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.login-box{
  width:100%;
  max-width:360px;
  background:var(--card);
  border-radius:16px;
  padding:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
  text-align:center;
}

.login-box h3{margin:0 0 6px}
.login-box p{font-size:13px;color:var(--muted)}

.login-box input{
  width:100%;
  padding:10px;
  margin-top:10px;
  border-radius:10px;
  border:1px solid var(--border);
}

.login-box button{
  width:100%;
  margin-top:14px;
  padding:12px;
  border:none;
  border-radius:12px;
  background:var(--primary);
  color:#fff;
  font-size:15px;
}

#loginError{
  margin-top:10px;
  font-size:13px;
  color:var(--warn);
}

/* ===== APP ===== */
#appScreen{display:none}

/* TOP */
.top-bar{
  max-width:430px;
  margin:0 auto 6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.top-title{font-weight:700;font-size:15px}
.icon-btn{
  border:none;
  border-radius:8px;
  padding:6px 10px;
  background:var(--card);
  box-shadow:0 1px 4px rgba(0,0,0,.12);
}

/* FILTER */
.filter-wrap,#results{
  max-width:430px;
  margin:0 auto 8px;
}

.filter-card{
  background:var(--card);
  border-radius:12px;
  padding:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
}

.filter-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
}

.clear-btn{
  font-size:12px;
  background:#f1f3f4;
  border:none;
  border-radius:6px;
  padding:4px 8px;
}

.filter-row{
  display:flex;
  gap:6px;
  margin-bottom:6px;
}

.filter-input{
  flex:1;
  min-width:0;
  padding:7px 8px;
  font-size:12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fafafa;
}

@media(max-width:480px){
  .filter-row{flex-wrap:wrap}
  .filter-input{flex:1 1 48%}
}

/* ITEM */
.item{
  background:var(--card);
  border-radius:12px;
  padding:9px;
  margin-bottom:7px;
  box-shadow:0 3px 8px rgba(0,0,0,.05);
}

.part-row{
  display:flex;
  justify-content:space-between;
}

.part{font-weight:700;color:var(--primary)}
.part.ok{color:var(--ok)}
.part.warn{color:var(--warn)}

.location{font-size:12px;color:var(--muted)}
.name{font-size:13px;margin-top:2px}
.meta{font-size:12px;color:var(--muted)}
.status{font-size:12px;margin-top:4px}

/* DETAIL */
.detail-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
}

.detail-card{
  width:100%;
  max-width:430px;
  background:var(--card);
  border-radius:16px 16px 0 0;
  padding:12px;
}

.detail-header{
  display:flex;
  justify-content:space-between;
  font-weight:600;
}

.detail-close{
  border:none;
  background:none;
  font-size:18px;
}

.detail-label{font-size:12px;color:var(--muted)}
.detail-qty-box{
  display:flex;
  gap:8px;
}

.detail-qty-box button{
  width:40px;
  border:none;
  border-radius:10px;
  font-size:20px;
}

.detail-qty-box input{
  flex:1;
  text-align:center;
  font-size:16px;
}

.detail-save{
  width:100%;
  margin-top:10px;
  padding:10px;
  border:none;
  border-radius:10px;
  background:var(--primary);
  color:#fff;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</p>
    <input id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <input id="loginPass" type="password" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ">
    <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginError"></div>
  </div>
</div>

<!-- APP -->
<div id="appScreen">

<div class="top-bar">
  <div class="top-title">Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
  <button class="icon-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
</div>

<div class="filter-wrap">
  <div class="filter-card">
    <div class="filter-header">
      <strong>Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</strong>
      <button class="clear-btn" onclick="clearFilters()">Ù…Ø³Ø­ âœ•</button>
    </div>

    <div class="filter-row">
      <input id="pContains" class="filter-input" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙŠØ­ØªÙˆÙŠ">
      <input id="pEnds" class="filter-input" placeholder="ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€">
    </div>

    <div class="filter-row">
      <input id="nStarts" class="filter-input" placeholder="Ø§Ø³Ù… ÙŠØ¨Ø¯Ø£">
      <input id="nContains" class="filter-input" placeholder="ÙŠØ­ØªÙˆÙŠ">
    </div>

    <div class="filter-row">
      <input id="locFrom" class="filter-input" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù†">
      <input id="locTo" class="filter-input" placeholder="Ø¥Ù„Ù‰">
    </div>
  </div>
</div>

<div id="results"></div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";
let ALL_DATA=[];

/* LOGIN */
function login(){
  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({
      name:loginUser.value,
      pass:loginPass.value
    })
  }).then(r=>r.json()).then(res=>{
    if(!res.ok){
      loginError.textContent=res.error;
      return;
    }
    loginScreen.style.display="none";
    appScreen.style.display="block";
    loadData();
  });
}

function logout(){
  location.reload();
}

/* DATA */
function loadData(){
  fetch(API).then(r=>r.json()).then(d=>{
    ALL_DATA=d;
    runSearch();
  });
}

document.querySelectorAll(".filter-input")
  .forEach(i=>i.addEventListener("input",runSearch));

function clearFilters(){
  document.querySelectorAll(".filter-input").forEach(i=>i.value="");
  render(ALL_DATA);
}

function runSearch(){
  const res=[];
  const pC=pContains.value.toLowerCase();
  const pE=pEnds.value.toLowerCase();
  const nS=nStarts.value.toLowerCase();
  const nC=nContains.value.toLowerCase();
  const lF=locFrom.value.toLowerCase();
  const lT=locTo.value.toLowerCase();

  for(const r of ALL_DATA){
  const p = String(r.part ?? "").toLowerCase();
  const n = String(r.name ?? "").toLowerCase();
  const l = String(r.location ?? "").toLowerCase();


    if(pC&&!p.includes(pC))continue;
    if(pE&&!p.endsWith(pE))continue;
    if(nS&&!n.startsWith(nS))continue;
    if(nC&&!n.includes(nC))continue;
    if(lF&&l<lF)continue;
    if(lT&&l>lT)continue;

    res.push(r);
  }
  // Ø¥Ø°Ø§ ÙƒÙ„ Ø§Ù„ÙÙ„Ø§ØªØ± ÙØ§Ø¶ÙŠØ©: Ø§Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 100 ÙÙ‚Ø·
  const noFilters = !pC && !pE && !nS && !nC && !lF && !lT;
  render(noFilters ? res.slice(0, 100) : res);
}

function render(data){
  results.innerHTML=data.map(r=>{
    let cls="part",status="";
    if(r.lastCountedAt){
      if(Number(r.qty)===Number(r.lastCountQty)){
        cls+=" ok"; status="âœ“ ØªÙ… Ø§Ù„Ø¬Ø±Ø¯";
      }else{
        cls+=" warn";
        status=`âš  ÙƒØ§Ù† ${r.lastCountQty} â† Ø§Ù„Ø¢Ù† ${r.qty}`;
      }
    }
   return `
<div class="item">
  <div class="part-row">
    <div class="${cls}">${r.part}</div>
    <div class="location">${r.location||""}</div>
  </div>

  <div class="name">${r.name||""}</div>

  <div class="meta" style="display:flex;justify-content:space-between;gap:6px">
  <span>Ø§Ù„ÙƒÙ…ÙŠØ©: <b>${r.qty}</b></span>
  <span>ğŸ“ ${r.location || "-"}</span>
</div>


  ${status?`<div class="status">${status}</div>`:""}

  <!-- Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
  <div style="display:flex;justify-content:flex-end;margin-top:6px">
   <button
  onclick="openDetail(${JSON.stringify(r.part)})"
  style="
    border:none;
    background:#1976d2;
    color:#fff;
    font-size:12px;
    padding:6px 12px;
    border-radius:8px;
    cursor:pointer
  ">
  âœï¸ ØªØ¹Ø¯ÙŠÙ„
</button>

  </div>
</div>
`;

  }).join("");
}
  /* ===============================
   STEP 2 â€“ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¯
   =============================== */
function openDetail(part){
  const r = ALL_DATA.find(x => String(x.part) === String(part));
  if(!r) return;

  const ov = document.createElement("div");
  ov.className = "detail-overlay";
  ov.innerHTML = `
    <div class="detail-card">
      <div class="detail-header">
        <span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¯</span>
        <button class="detail-close" onclick="this.closest('.detail-overlay').remove()">âœ•</button>
      </div>

      <div class="detail-label">Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</div>
      <div><b>${r.part}</b></div>

      <div class="detail-label">ÙƒÙ…ÙŠØ© Ø§Ù„Ø¬Ø±Ø¯</div>
      <div class="detail-qty-box">
        <button onclick="chg(-1)">âˆ’</button>
        <input id="cq" type="number" value="${r.qty}">
        <button onclick="chg(1)">+</button>
      </div>

      <div class="detail-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
      <textarea id="note"
        style="width:100%;min-height:60px;border-radius:8px;border:1px solid var(--border);padding:6px"></textarea>

      <button class="detail-save" onclick="saveCount('${r.part}', ${r.qty})">
        Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      </button>
    </div>
  `;
  document.body.appendChild(ov);
}

function chg(d){
  const i = document.getElementById("cq");
  i.value = Math.max(0, (+i.value || 0) + d);
}
function saveCount(part, systemQty){
  const counted = Number(document.getElementById("cq").value || 0);
  const noteVal = document.getElementById("note").value || "";

  // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø± (Ø¹Ø´Ø§Ù† Ø§Ù„Ù„ÙˆÙ† ÙŠØªØºÙŠØ± ÙÙˆØ±Ø§Ù‹)
  const r = ALL_DATA.find(x => String(x.part) === String(part));
  if(r){
    r.lastCountedAt = new Date().toISOString();
    r.lastCountQty = systemQty;
    r.qty = counted;
    r.note = noteVal;
  }

  // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  document.querySelector(".detail-overlay").remove();

  // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙˆØ±Ø§Ù‹
  render(ALL_DATA);

  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø³ÙŠØ±ÙØ± (ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©)
  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({
      part:part,
      systemQty:systemQty,
      countedQty:counted,
      note:noteVal
    })
  }).then(()=>loadData());
}

</script>

</body>
</html>
