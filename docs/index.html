<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Ø´Ø±ÙƒØ© Ø§Ù„Ù‚Ø§Ø¶ÙŠ</title>

<style>
:root{
  --bg:#f3f4fb;
  --card:rgba(255,255,255,0.94);
  --primary:#2563eb;
  --primary-soft:rgba(37,99,235,0.10);
  --accent:#7c3aed;
  --ok:#16a34a;
  --warn:#dc2626;
  --text:#0f172a;
  --muted:#6b7280;
  --border:rgba(148,163,184,0.35);
}

body{
  margin:0;
  font-family:system-ui,-apple-system;
  min-height:100vh;
  background:
    radial-gradient(circle at 0% 0%, rgba(59,130,246,0.12) 0, transparent 55%),
    radial-gradient(circle at 100% 100%, rgba(56,189,248,0.16) 0, #e5e7eb 55%);
  padding:12px;
  color:var(--text);
}
*{box-sizing:border-box}
input, textarea, button{
  font-size:16px;
}

/* LOGIN */
.login-screen{
  position:fixed;
  inset:0;
  z-index:1000;
  display:flex;
  justify-content:center;
  align-items:center;
  background:radial-gradient(circle at 0% 0%, rgba(59,130,246,0.18) 0, transparent 55%),
             radial-gradient(circle at 100% 100%, rgba(236,72,153,0.16) 0, rgba(248,250,252,0.96) 55%);
}
.login-box{
  width:100%;
  max-width:360px;
  padding:24px 20px 20px;
  border-radius:28px;
  background:var(--card);
  backdrop-filter:blur(16px);
  -webkit-backdrop-filter:blur(16px);
  box-shadow:
    0 22px 60px rgba(15,23,42,0.25),
    0 0 0 1px rgba(148,163,184,0.40);
  color:var(--text);
  text-align:center;
  position:relative;
  overflow:hidden;
}
.login-box::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:
    radial-gradient(circle at 0% 0%, rgba(59,130,246,0.18) 0, transparent 55%),
    radial-gradient(circle at 100% 0%, rgba(236,72,153,0.20) 0, transparent 55%);
  opacity:0.45;
  pointer-events:none;
  mix-blend-mode:soft-light;
}
.login-box > *{
  position:relative;
  z-index:1;
}
.login-logo{
  width:120px;
  height:64px;
  margin:4px auto 14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:48px;
}
.login-box h3{
  margin:6px 0 4px;
  font-size:18px;
  font-weight:800;
}
.login-box p{
  font-size:12px;
  color:var(--muted);
  margin:0 0 12px;
}
.login-box input{
  width:100%;
  padding:11px;
  margin-top:9px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(248,250,252,0.9);
  color:var(--text);
  transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
}
.login-box input::placeholder{color:#9ca3af}
.login-box input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
  background:#ffffff;
}
.login-btn{
  width:100%;
  margin-top:16px;
  padding:11px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#2563eb,#7c3aed);
  color:#ffffff;
  cursor:pointer;
  font-weight:700;
  letter-spacing:0.3px;
  box-shadow:
    0 14px 32px rgba(37,99,235,0.55),
    0 0 0 1px rgba(129,140,248,0.65);
  transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
}
.login-btn:hover{
  transform:translateY(-1px);
  box-shadow:
    0 18px 40px rgba(37,99,235,0.6),
    0 0 0 1px rgba(129,140,248,0.8);
}
.login-btn:active{
  transform:translateY(1px) scale(0.99);
  box-shadow:0 6px 18px rgba(37,99,235,0.45);
}
#loginError{
  margin-top:8px;
  font-size:12px;
  color:#dc2626;
}
#loginLoading{
  display:none;
  margin-top:6px;
  font-size:11px;
  color:#6b7280;
}
#buildInfo{
  margin-top:10px;
  font-size:11px;
  color:#9ca3af;
}

/* MAIN MENU */
#mainScreen{
  display:none;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.main-card{
  width:100%;
  max-width:380px;
  background:#0f172a;
  border-radius:28px;
  padding:18px 16px 16px;
  box-shadow:
    0 24px 55px rgba(15,23,42,0.5),
    0 0 0 1px rgba(15,23,42,0.8);
  color:#e5e7eb;
  position:relative;
  overflow:hidden;
}

.main-card::before{
  content:"";
  position:absolute;
  inset:0;
  background:none;
  opacity:1;
  pointer-events:none;
}

.main-card > *{
  position:relative;
  z-index:1;
}

.main-logout-btn{
  position:absolute;
  top:12px;
  left:12px;
  background:rgba(255,255,255,0.15);
  color:#ffffff;
  border:none;
  border-radius:8px;
  padding:6px 10px;
  font-size:11px;
  cursor:pointer;
  transition:background .12s ease;
  z-index:2;
}

.main-logout-btn:hover{
  background:rgba(255,255,255,0.25);
}

.main-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  margin-bottom:12px;
}

.main-title{
  font-size:18px;
  font-weight:800;
  color:#ffffff;
}

.main-sub{
  font-size:11px;
  color:#cbd5f5;
}

.main-greeting{
  font-size:12px;
  color:#a5b4fc;
  margin-top:4px;
}

.main-badge{
  font-size:11px;
  background:#1d4ed8;
  color:#e5e7eb;
  padding:4px 10px;
  border-radius:999px;
  box-shadow:0 0 0 1px rgba(37,99,235,0.7);
}

.main-list{
  margin-top:4px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.main-btn{
  width:100%;
  border:none;
  border-radius:18px;
  padding:10px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
  background:#1d4ed8;
  color:#f9fafb;
  box-shadow:0 4px 12px rgba(15,23,42,0.4);
  transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
}

.main-btn span.left{
  display:flex;
  align-items:center;
  gap:10px;
}

.main-icon{
  width:32px;
  height:32px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  background:rgba(15,23,42,0.25);
  color:#f9fafb;
  box-shadow:none;
}

.main-arrow{
  font-size:13px;
  color:#e5e7eb;
  font-weight:600;
}

.main-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 22px rgba(15,23,42,0.6);
  background:#2563eb;
}

.main-btn.primary{
  background:#1d4ed8;
  color:#ffffff;
  box-shadow:0 14px 30px rgba(15,23,42,0.6);
}

.main-btn.primary .main-icon{
  background:rgba(15,23,42,0.25);
  color:#ffffff;
}

.main-btn.primary .main-arrow{
  color:#e5e7eb;
}

/* APP TOP */
#appScreen{
  display:none;
}

.top-bar{
  max-width:430px;
  margin:0 auto 6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:var(--text);
}

.top-title{
  font-weight:700;
  font-size:15px;
}

.top-actions{
  display:flex;
  gap:6px;
  align-items:center;
}

.icon-btn{
  border:none;
  border-radius:999px;
  padding:6px 12px;
  background:rgba(255,255,255,0.92);
  color:#0f172a;
  box-shadow:0 1px 4px rgba(148,163,184,.55);
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:4px;
  transition:background .12s ease, transform .12s ease, box-shadow .12s ease;
  font-size:13px;
}

.icon-btn:hover{
  background:#eff6ff;
  transform:translateY(-1px);
  box-shadow:0 4px 10px rgba(148,163,184,.55);
}

.icon-btn.small{
  padding:5px 8px;
  font-size:12px;
}

/* FILTER + RESULTS */
.filter-wrap,#results{
  max-width:430px;
  margin:0 auto 8px;
}

.filter-wrap{
  position:sticky;
  top:0;
  z-index:10;
}

.filter-card{
  background:var(--card);
  border-radius:16px;
  padding:8px;
  box-shadow:0 3px 10px rgba(148,163,184,.35);
  color:var(--text);
  backdrop-filter:blur(14px);
  -webkit-backdrop-filter:blur(14px);
  border:1px solid var(--border);
}

.filter-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
}

.filter-header strong{
  font-size:13px;
}

.clear-btn{
  font-size:12px;
  background:#e5e7eb;
  color:var(--text);
  border:none;
  border-radius:999px;
  padding:4px 10px;
  cursor:pointer;
  transition:background .12s ease, transform .12s ease;
}

.clear-btn:hover{
  background:#e0e7ff;
  transform:translateY(-1px);
}

.filter-row{
  display:flex;
  gap:6px;
  margin-bottom:6px;
}

.filter-input{
  flex:1;
  min-width:0;
  padding:7px 8px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#f9fafb;
  color:var(--text);
  font-size:14px;
  transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
}

.filter-input.small{
  flex:1 1 30%;
  padding:5px 6px;
  font-size:14px;
}

.filter-input::placeholder{color:#9ca3af}

.filter-input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
  background:#ffffff;
}

@media(max-width:480px){
  .filter-row{flex-wrap:wrap}
  .filter-input{flex:1 1 48%}
  .filter-input.small{flex:1 1 30%}
}

/* ITEM */
.item{
  background:var(--card);
  border-radius:16px;
  padding:9px 9px 10px;
  margin-bottom:7px;
  box-shadow:0 4px 12px rgba(148,163,184,.35);
  color:var(--text);
  border:1px solid rgba(226,232,240,0.9);
}

.part-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:8px;
}

.part{
  font-weight:700;
  color:var(--primary);
}

.part.ok{
  color:var(--ok);
}

.part.warn{
  color:var(--warn);
}

.location{
  font-size:12px;
  color:var(--muted);
}

.name{
  font-size:13px;
  margin-top:2px;
}

.meta{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
}

.status{
  font-size:12px;
  margin-top:4px;
}

/* Ù…Ø¨ÙŠØ¹Ø§Øª */
.sales-item .part.ok{
  color:var(--primary);
}

/* Ø¥Ø¨Ø±Ø§Ø² ÙØ±Ù‚ ÙƒØ¨ÙŠØ± */
.item[style*="border:2px solid"]{
  background:#fff7ed;
}

/* DETAIL */
.detail-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  z-index:9999;
}

.detail-card{
  width:100%;
  max-width:430px;
  background:var(--card);
  border-radius:18px 18px 0 0;
  padding:12px;
  color:var(--text);
  box-shadow:0 -8px 25px rgba(15,23,42,0.45);
  border-top:1px solid var(--border);
  max-height:90vh;
  overflow-y:auto;
}

.detail-header{
  display:flex;
  justify-content:space-between;
  font-weight:600;
  margin-bottom:10px;
}

.detail-close{
  border:none;
  background:none;
  font-size:18px;
  cursor:pointer;
  color:var(--muted);
}

.detail-label{
  font-size:12px;
  color:var(--muted);
  margin-top:10px;
  font-weight:600;
}

.detail-value{
  font-size:13px;
  color:var(--text);
  margin-top:4px;
  padding:8px;
  background:#f9fafb;
  border-radius:8px;
  border:1px solid var(--border);
}

.detail-qty-box{
  display:flex;
  gap:8px;
  margin-top:6px;
}

.detail-qty-box button{
  width:40px;
  border:none;
  border-radius:10px;
  font-size:20px;
  cursor:pointer;
  background:#e5e7eb;
  color:#0f172a;
  transition:background .12s ease, transform .12s ease;
}

.detail-qty-box button:hover{
  background:#dbeafe;
  transform:translateY(-1px);
}

.detail-qty-box input{
  flex:1;
  text-align:center;
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px;
  background:#f9fafb;
  color:var(--text);
}

.detail-qty-box input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
}

.detail-save{
  width:100%;
  margin-top:12px;
  padding:10px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#2563eb,#7c3aed);
  color:#fff;
  cursor:pointer;
  transition:opacity .12s ease, transform .12s ease, box-shadow .12s ease;
  box-shadow:
    0 12px 26px rgba(37,99,235,0.45),
    0 0 0 1px rgba(129,140,248,0.75);
}

.detail-save:hover:enabled{
  transform:translateY(-1px);
  box-shadow:
    0 16px 34px rgba(37,99,235,0.55),
    0 0 0 1px rgba(129,140,248,0.9);
}

#newLoc,#note{
  background:#f9fafb;
  border:1px solid var(--border);
  color:var(--text);
}

#newLoc:focus,#note:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
}

/* Success notification */
.success-notify{
  position:fixed;
  bottom:20px;
  left:20px;
  right:20px;
  max-width:400px;
  background:#16a34a;
  color:#fff;
  padding:12px 16px;
  border-radius:10px;
  box-shadow:0 8px 20px rgba(15,23,42,0.4);
  animation:slideUp .3s ease;
  z-index:9998;
}

/* Update indicator */
.update-badge{
  position:fixed;
  top:12px;
  right:12px;
  background:#2563eb;
  color:#fff;
  padding:6px 12px;
  border-radius:999px;
  font-size:11px;
  font-weight:600;
  box-shadow:0 4px 12px rgba(37,99,235,0.5);
  animation:pulse .6s ease infinite;
  z-index:100;
}

@keyframes pulse{
  0%,100%{opacity:1;transform:scale(1)}
  50%{opacity:0.8;transform:scale(1.05)}
}

.conflict-notify{
  position:fixed;
  bottom:20px;
  left:20px;
  right:20px;
  max-width:400px;
  background:#dc2626;
  color:#fff;
  padding:12px 16px;
  border-radius:10px;
  box-shadow:0 8px 20px rgba(15,23,42,0.4);
  animation:slideUp .3s ease;
  z-index:9998;
}

@keyframes slideUp{
  from{
    opacity:0;
    transform:translateY(20px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

/* SALES DETAIL MODAL */
.sales-detail-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  z-index:9999;
}

.sales-detail-card{
  width:100%;
  max-width:430px;
  background:var(--card);
  border-radius:18px 18px 0 0;
  padding:12px;
  color:var(--text);
  box-shadow:0 -8px 25px rgba(15,23,42,0.45);
  border-top:1px solid var(--border);
  max-height:90vh;
  overflow-y:auto;
}

.sales-detail-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:600;
  margin-bottom:12px;
  padding-bottom:10px;
  border-bottom:1px solid var(--border);
}

.sales-detail-close{
  border:none;
  background:none;
  font-size:18px;
  cursor:pointer;
  color:var(--muted);
}

.info-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
  padding:8px;
  background:#f9fafb;
  border-radius:8px;
  font-size:13px;
}

.info-label{
  font-weight:600;
  color:var(--muted);
}

.info-value{
  color:var(--text);
  font-weight:700;
}

.price-section{
  margin-top:16px;
  padding:12px;
  background:#eff6ff;
  border-radius:12px;
  border:1px solid rgba(37,99,235,0.3);
}

.price-input-group{
  margin-top:12px;
}

.price-input-group label{
  display:block;
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
  font-weight:600;
}

.price-input-group input{
  width:100%;
  padding:10px;
  border:1px solid var(--border);
  border-radius:10px;
  background:#fff;
  color:var(--text);
  font-size:14px;
}

.price-input-group input:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 1px rgba(37,99,235,0.45);
}

.calc-results{
  margin-top:12px;
  padding:10px;
  background:#ffffff;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:12px;
}

.calc-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
  padding:6px 0;
}

.calc-row:last-child{
  margin-bottom:0;
  padding-top:8px;
  border-top:2px solid var(--border);
  font-weight:700;
  font-size:13px;
}

.calc-label{
  color:var(--muted);
}

.calc-value{
  color:var(--text);
  font-weight:700;
  text-align:left;
}

.no-calc{
  color:var(--muted);
  text-align:center;
  padding:10px;
  font-size:12px;
}
</style>
</head>

<body>

<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <div class="login-logo">
      ğŸš—
    </div>

    <h3>Ø´Ø±ÙƒØ© Ø§Ù„Ù‚Ø§Ø¶ÙŠ Ù„Ø¨ÙŠØ¹ Ù‚Ø·Ø¹ ØºÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h3>
    <p>ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</p>

    <input id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <input id="loginPass" type="password" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ">

    <button class="login-btn" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginLoading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
    <div id="loginError"></div>
    <div id="buildInfo"></div>
  </div>
</div>

<div id="mainScreen">
  <div class="main-card">
    <button class="main-logout-btn" onclick="logoutUser()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    
    <div class="main-header">
      <div>
        <div class="main-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="main-sub">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</div>
        <div class="main-greeting" id="userGreeting"></div>
      </div>
      <div class="main-badge">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
    </div>

    <div class="main-list">
      <button class="main-btn" onclick="openMenu(2)">
        <span class="left">
          <span class="main-icon">ğŸš—</span>
          <span>Ø¨Ø¶Ø§Ø¹Ø© Ø´Ø±ÙƒØ© ØªÙˆÙŠÙˆØªØ§</span>
        </span>
        <span class="main-arrow">â€º</span>
      </button>

      <button class="main-btn primary" onclick="openMenu(3)">
        <span class="left">
          <span class="main-icon">ğŸ“‹</span>
          <span>Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ </span>
        </span>
        <span class="main-arrow">â€º</span>
      </button>

      <button class="main-btn" onclick="openSalesMenu()">
        <span class="left">
          <span class="main-icon">ğŸ’°</span>
          <span>Ù…Ø¨ÙŠØ¹Ø§Øª</span>
        </span>
        <span class="main-arrow">â€º</span>
      </button>
    </div>

  </div>
</div>

<div id="appScreen">

  <div class="top-bar">
    <div class="top-title" id="topTitle">Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ </div>
    <div class="top-actions">
      <button class="icon-btn small" id="refreshBtn" onclick="refreshCurrentView()" title="ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ">ğŸ”„</button>
      <button class="icon-btn" onclick="backToMain()">Ø¹ÙˆØ¯Ø©</button>
    </div>
  </div>

  <div class="filter-wrap">
    <div class="filter-card">

      <div class="filter-header">
        <strong>Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</strong>
        <button class="clear-btn" onclick="clearFilters()">Ù…Ø³Ø­ âœ•</button>
      </div>

      <div class="filter-row" style="margin-bottom:6px">
        <select id="branchFilter" class="filter-input small" required>
          <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>
          <option value="*">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
          <option value="Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø§ÙˆÙ„</option>
          <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
          <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«</option>
          <option value="Ù…Ø³ØªÙˆØ¯Ø¹ ÙØ±Ø¹ 3">Ù…Ø³ØªÙˆØ¯Ø¹ ÙØ±Ø¹ 3</option>
        </select>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:6px;margin:4px 0 6px;font-size:11px" id="countStateWrap">
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="all" checked style="margin:0">
          <span>Ø§Ù„ÙƒÙ„</span>
        </label>
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="counted" style="margin:0">
          <span>Ø§Ù„Ù…Ø¬Ø±Ø¯</span>
        </label>
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="diff" style="margin:0">
          <span>ÙÙŠÙ‡ ÙØ±Ù‚</span>
        </label>
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="not" style="margin:0">
          <span>ØºÙŠØ± Ù…Ø¬Ø±Ø¯</span>
        </label>
      </div>

      <div class="filter-row">
        <input id="pContains" class="filter-input" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙŠØ­ØªÙˆÙŠ">
        <input id="pEnds" class="filter-input" placeholder="ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€">
      </div>

      <div class="filter-row">
        <input id="nStarts" class="filter-input" placeholder="Ø§Ø³Ù… ÙŠØ¨Ø¯Ø£">
        <input id="nContains" class="filter-input" placeholder="ÙŠØ­ØªÙˆÙŠ">
      </div>

      <div class="filter-row">
        <input id="locFrom" class="filter-input small" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù†">
        <input id="locTo"   class="filter-input small" placeholder="Ø¥Ù„Ù‰">
        <input id="barcode" class="filter-input small" placeholder="Ø¨Ø§Ø±ÙƒÙˆØ¯">
      </div>
    </div>
  </div>

  <div id="results"></div>
  <div id="salesLoading"
       style="display:none;text-align:center;font-size:13px;color:#6b7280;margin:8px 0;">
    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª...
  </div>

</div>

<audio id="beepAudio">
  <source src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUAAAAA=" type="audio/wav">
</audio>
<script>
document.getElementById("buildInfo").textContent =
  "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù…Ù„Ù: " +
  new Date(document.lastModified).toLocaleString("ar-SA");

let CURRENT_VIEW = "inventory";
const API="https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";

let ALL_DATA = [];
let SALES_DATA = [];
let LAST_RENDER = [];
let CURRENT_USER = "";
let CURRENT_ROLE = "";
let loadingInterval = null;
let AUTO_REFRESH = null;
let CURRENT_DETAIL_PART   = null;
let CURRENT_DETAIL_BRANCH = null;
let LAST_SYNC_TIME = 0;
let SYNC_INTERVAL = 30000;
let JUST_UPDATED = false;
let SALES_LAST_FETCH = 0;

window.addEventListener("load", () => {
  try {
    const savedUser = localStorage.getItem("stockUser");
    const savedRole = localStorage.getItem("stockRole");
    if (savedUser && savedRole) {
      CURRENT_USER = savedUser;
      CURRENT_ROLE = savedRole;
      loginScreen.style.display = "none";
      mainScreen.style.display = "flex";
      updateGreeting();
      if (!ALL_DATA || ALL_DATA.length === 0) {
        loadInventoryAfterLogin();
      }
    }
  } catch (e) {}
});

document.addEventListener("gesturestart", function (e) { e.preventDefault(); }, { passive: false });
let lastTouchEnd = 0;
document.addEventListener("touchend", function (e) {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) { e.preventDefault(); }
  lastTouchEnd = now;
}, { passive: false });

let lastTouchY = 0;
let preventPullToRefresh = false;
function enablePullBlock(){ preventPullToRefresh = true; }
window.addEventListener("touchstart", function(e){
  if(!preventPullToRefresh) return;
  if(e.touches.length !== 1) return;
  lastTouchY = e.touches[0].clientY;
}, {passive:false});
window.addEventListener("touchmove", function(e){
  if(!preventPullToRefresh) return;
  if(window.scrollY > 0) return;
  const touchY = e.touches[0].clientY;
  const deltaY = touchY - lastTouchY;
  lastTouchY = touchY;
  if(deltaY > 0) e.preventDefault();
}, {passive:false});

function playBeep(){
  const a = document.getElementById("beepAudio");
  if(!a) return;
  a.currentTime = 0;
  a.play().catch(()=>{});
}

function updateGreeting(){
  const greeting = document.getElementById("userGreeting");
  if(greeting){
    const hour = new Date().getHours();
    let greeting_text = "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±";
    if(hour >= 12 && hour < 18) greeting_text = "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±";
    if(hour >= 18) greeting_text = "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±";
    greeting.textContent = greeting_text + " " + CURRENT_USER;
  }
}

function cleanBarcode(text) {
  if (!text) return "";
  let val = String(text).trim();
  if (!val) return "";
  while (val.startsWith('/')) {
    val = val.substring(1).trim();
  }
  if (val.includes(';')) {
    const parts = val.split(';');
    for (const part of parts) {
      const p = part.trim();
      if (p && /\d/.test(p)) {
        val = p;
        break;
      }
    }
  }
  let core = "";
  for (const char of val) {
    if (char === ' ' || char === '\t') break;
    core += char;
  }
  while (core.startsWith('-')) {
    core = core.substring(1);
  }
  const knownPrefixes = ['MZ-', 'TO-', 'HO-', 'DA-', 'NS-', 'MS-', 'SU-', 'MI-', 'FU-', 'HY-'];
  for (const prefix of knownPrefixes) {
    if (core.toUpperCase().startsWith(prefix)) {
      core = core.substring(prefix.length);
      break;
    }
  }
  if (core.length > 3 && core[2] === '-' && /^[A-Z]{2}/.test(core)) {
    core = core.substring(3);
  }
  while (core.endsWith('-')) {
    core = core.substring(0, core.length - 1);
  }
  let digits = "";
  for (const char of core.trim()) {
    if (/\d/.test(char)) {
      digits += char;
      if (digits.length === 10) break;
    }
  }
  if (digits.length > 10) {
    return "";
  }
  return digits;
}

function normalizePartNumber(partNum) {
  if (!partNum) return "";
  return String(partNum).replace(/-/g, "").toLowerCase();
}

function login(){
  loginError.textContent="";
  loginLoading.style.display="block";
  loginLoading.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
  const user = loginUser.value.trim();
  const pass = loginPass.value.trim();

  if(!user || !pass){
    loginLoading.style.display="none";
    loginError.textContent="ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ";
    return;
  }

  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({ name: user, pass: pass })
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.ok){
      loginLoading.style.display="none";
      loginError.textContent = res.error || "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
      return;
    }
    CURRENT_USER = res.user && res.user.name ? res.user.name : user;
    CURRENT_ROLE = res.user && res.user.role ? res.user.role : "User";
    try {
      localStorage.setItem("stockUser", CURRENT_USER);
      localStorage.setItem("stockRole", CURRENT_ROLE);
    } catch (e) {}
    enablePullBlock();
    loginLoading.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† 0%...";
    loadInventoryAfterLogin();
  })
  .catch(()=>{
    loginLoading.style.display="none";
    loginError.textContent="ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±";
  });
}

function logoutUser(){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")){
    try {
      localStorage.removeItem("stockUser");
      localStorage.removeItem("stockRole");
    } catch (e) {}
    CURRENT_USER = "";
    CURRENT_ROLE = "";
    ALL_DATA = [];
    SALES_DATA = [];
    location.reload();
  }
}

function backToMain(){
  appScreen.style.display = "none";
  mainScreen.style.display = "flex";
  updateGreeting();
}

function loadInventoryAfterLogin(){
  let progress = 0;
  loginLoading.style.display = "block";
  loginLoading.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† 0%...";
  loadingInterval = setInterval(()=>{
    if(progress < 95){
      progress += 3;
      loginLoading.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† " + progress + "%...";
    }
  }, 150);
  fetch(API + "?mode=inventory")
    .then(r => r.json())
    .then(d => {
      ALL_DATA = Array.isArray(d) ? d : [];
      SALES_DATA = Array.isArray(ALL_DATA) ? ALL_DATA.slice() : [];
      LAST_SYNC_TIME = Date.now();
      if(loadingInterval) clearInterval(loadingInterval);
      loginLoading.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† 100%...";
      setTimeout(()=>{
        loginScreen.style.display="none";
        loginLoading.style.display="none";
        mainScreen.style.display="flex";
        updateGreeting();
        startAutoSync();
      }, 400);
    })
    .catch(() => {
      if(loadingInterval) clearInterval(loadingInterval);
      loginLoading.style.display="none";
      loginError.textContent = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†";
    });
}

function startAutoSync(){
  if(AUTO_REFRESH) clearInterval(AUTO_REFRESH);
  AUTO_REFRESH = setInterval(()=>{
    if(CURRENT_VIEW === "inventory"){
      autoRefreshData("inventory");
    } else if(CURRENT_VIEW === "sales"){
      autoRefreshData("sales");
    }
  }, SYNC_INTERVAL);
}

function autoRefreshData(mode){
  const now = Date.now();
  if(now - LAST_SYNC_TIME < SYNC_INTERVAL) return;
  
  fetch(API + "?mode=" + mode)
    .then(r => r.json())
    .then(d => {
      if(!d || !Array.isArray(d)) return;
      
      let hasChanges = false;
      
      if(mode === "inventory"){
        if(d.length !== ALL_DATA.length){
          hasChanges = true;
        } else {
          for(let i = 0; i < d.length; i++){
            if(JSON.stringify(d[i]) !== JSON.stringify(ALL_DATA[i])){
              hasChanges = true;
              break;
            }
          }
        }
        
        if(hasChanges){
          ALL_DATA = d.slice();
          LAST_SYNC_TIME = now;
          runSearchInventory();
          showUpdateIndicator();
        }
      } else if(mode === "sales"){
        if(d.length !== SALES_DATA.length){
          hasChanges = true;
        } else {
          for(let i = 0; i < d.length; i++){
            if(JSON.stringify(d[i]) !== JSON.stringify(SALES_DATA[i])){
              hasChanges = true;
              break;
            }
          }
        }
        
        if(hasChanges){
          SALES_DATA = d.slice();
          LAST_SYNC_TIME = now;
          runSearchSales();
          showUpdateIndicator();
        }
      }
    })
    .catch(() => {});
}

function showUpdateIndicator(){
  if(JUST_UPDATED) return;
  JUST_UPDATED = true;
  
  const badge = document.createElement("div");
  badge.className = "update-badge";
  badge.textContent = "âœ“ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
  document.body.appendChild(badge);
  
  setTimeout(()=>{
    badge.remove();
    JUST_UPDATED = false;
  }, 3500);
}

function refreshCurrentView(){
  const refreshBtn = document.getElementById("refreshBtn");
  refreshBtn.style.transform = "rotate(360deg)";
  refreshBtn.style.transition = "transform .6s ease";
  
  const mode = (CURRENT_VIEW === "sales") ? "sales" : "inventory";
  fetch(API + "?mode=" + mode)
    .then(r => r.json())
    .then(d => {
      if (!d || !Array.isArray(d)) return;
      if (mode === "sales") {
        SALES_DATA = d.slice();
        SALES_LAST_FETCH = Date.now();
        runSearchSales();
      } else {
        ALL_DATA = d.slice();
        runSearchInventory();
      }
      showNotification("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
      setTimeout(() => {
        refreshBtn.style.transform = "rotate(0deg)";
      }, 600);
    })
    .catch(() => {
      setTimeout(() => {
        refreshBtn.style.transform = "rotate(0deg)";
      }, 600);
    });
}

function openMenu(id){
  if(id === 3){
    CURRENT_VIEW = "inventory";
    document.getElementById("topTitle").textContent = "Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠ";
    countStateWrap.style.display = "flex";
    mainScreen.style.display = "none";
    appScreen.style.display  = "block";
    runSearchInventory();
  }else{
    alert("Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù… ØªÙØ¹Ù„");
  }
}

function openSalesMenu(){
  CURRENT_VIEW = "sales";
  document.getElementById("topTitle").textContent = "Ù…Ø¨ÙŠØ¹Ø§Øª";
  countStateWrap.style.display = "none";
  
  mainScreen.style.display = "none";
  appScreen.style.display  = "block";
  
  if(SALES_DATA && SALES_DATA.length > 0){
    runSearchSales();
    
    const now = Date.now();
    if(now - SALES_LAST_FETCH > 10000){
      fetch(API + "?mode=sales")
        .then(r => r.json())
        .then(d => {
          if(d && Array.isArray(d)){
            SALES_DATA = d.slice();
            SALES_LAST_FETCH = now;
            if(CURRENT_VIEW === "sales"){
              runSearchSales();
            }
          }
        })
        .catch(() => {});
    }
  } else {
    const loadingEl = document.getElementById("salesLoading");
    if(loadingEl) loadingEl.style.display = "block";
    
    fetch(API + "?mode=sales")
      .then(r => r.json())
      .then(d => {
        if(d && Array.isArray(d)){
          SALES_DATA = d.slice();
          SALES_LAST_FETCH = Date.now();
          runSearchSales();
        }
        if(loadingEl) loadingEl.style.display = "none";
      })
      .catch(() => {
        if(loadingEl) loadingEl.style.display = "none";
        runSearchSales();
      });
  }
}

let searchTimer = null;
document.querySelectorAll(".filter-input").forEach(inp=>{
  inp.addEventListener("input", ()=>{
    clearTimeout(searchTimer);
    searchTimer = setTimeout(()=>{
      if(CURRENT_VIEW === "inventory") runSearchInventory();
      else runSearchSales();
    }, 150);
  });
});

document.querySelectorAll('input[name="countState"]').forEach(r=>{
  r.addEventListener("change", ()=>{ if(CURRENT_VIEW === "inventory") runSearchInventory(); });
});

function clearFilters(){
  document.querySelectorAll(".filter-input").forEach(i=>{ if(i.id !== "branchFilter"){ i.value = ""; } });
  const allRadio = document.querySelector('input[name="countState"][value="all"]');
  if(allRadio) allRadio.checked = true;
  if(CURRENT_VIEW === "inventory"){ runSearchInventory(); }else{ runSearchSales(); }
}

function runSearchInventory(){
  const pc = (pContains.value || "").trim().toLowerCase();
  const pe = (pEnds.value || "").trim().toLowerCase();
  const ns = (nStarts.value || "").trim().toLowerCase();
  const nc = (nContains.value || "").trim().toLowerCase();
  const lfRaw = (locFrom.value || "").trim().toLowerCase();
  const ltRaw = (locTo.value || "").trim().toLowerCase();

  const bcInput = (barcode.value || "").trim();
  const bcNorm  = cleanBarcode(bcInput);

  const branchVal = branchFilter.value;
  const countState = document.querySelector('input[name="countState"]:checked')?.value || "all";

  let filtered = ALL_DATA.slice();

  if (branchVal && branchVal !== "*") {
    filtered = filtered.filter(r => String(r.branch || "").toLowerCase() === branchVal.toLowerCase());
  }

  if (pc) {
    filtered = filtered.filter(r => {
      const p = String(r.part || "").toLowerCase();
      return p.includes(pc);
    });
  }
  if (pe) {
    filtered = filtered.filter(r => {
      const p = String(r.part || "").toLowerCase();
      return p.endsWith(pe);
    });
  }
  if (ns) {
    filtered = filtered.filter(r => {
      const n = String(r.name || "").toLowerCase();
      return n.startsWith(ns);
    });
  }
  if (nc) {
    filtered = filtered.filter(r => {
      const n = String(r.name || "").toLowerCase();
      return n.includes(nc);
    });
  }
  if (lfRaw || ltRaw) {
    const lfNum = lfRaw ? parseFloat(lfRaw) : -Infinity;
    const ltNum = ltRaw ? parseFloat(ltRaw) : Infinity;
    filtered = filtered.filter(r => {
      const locVal = String(r.location || "").toLowerCase().trim();
      const locNum = parseFloat(locVal);
      if (isNaN(locNum)) return false;
      return locNum >= lfNum && locNum <= ltNum;
    });
  }

  if (bcNorm) {
    filtered = filtered.filter(r => {
      const stored = cleanBarcode(r.barcode);
      return stored === bcNorm;
    });
  }

  if (countState === "counted") {
    filtered = filtered.filter(r => r.lastCountedAt && r.lastCountedAt.trim() !== "");
  } else if (countState === "not") {
    filtered = filtered.filter(r => !r.lastCountedAt || r.lastCountedAt.trim() === "");
  } else if (countState === "diff") {
    filtered = filtered.filter(r => {
      if (!r.lastCountedAt || r.lastCountedAt.trim() === "") return false;
      const sys = Number(r.lastSystemQty ?? 0);
      const cnt = Number(r.lastCountQty ?? 0);
      return cnt !== sys;
    });
  }

  LAST_RENDER = filtered;
  renderInventory(filtered);
}

function renderInventory(arr){
  const box = document.getElementById("results");
  if(!arr || arr.length === 0){
    box.innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:#6b7280">
        <div style="font-size:48px;margin-bottom:8px">ğŸ“¦</div>
        <div style="font-size:14px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>
      </div>`;
    return;
  }

  const html = arr.map(r => {
    const isCounted = r.lastCountedAt && r.lastCountedAt.trim() !== "";
    const sys = Number(r.lastSystemQty ?? 0);
    const cnt = Number(r.lastCountQty ?? 0);
    const diff = cnt - sys;
    const hasDiff = isCounted && (diff !== 0);
    const bigDiff = Math.abs(diff) >= 5;

    let statusLine = "";
    if (isCounted) {
      statusLine = `<div class="status" style="color:#16a34a">âœ“ ØªÙ… Ø§Ù„Ø¬Ø±Ø¯: ${r.lastCountedAt}</div>`;
      if (hasDiff) {
        const sign = diff > 0 ? "+" : "";
        statusLine += `<div style="font-size:12px;color:#dc2626;margin-top:2px">ÙØ±Ù‚: ${sign}${diff}</div>`;
      }
    } else {
      statusLine = `<div class="status" style="color:#6b7280">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¬Ø±Ø¯ Ø¨Ø¹Ø¯</div>`;
    }

    const borderStyle = bigDiff ? 'style="border:2px solid #f97316"' : '';

    return `
      <div class="item" ${borderStyle} onclick='openDetail(${JSON.stringify(r.part)}, ${JSON.stringify(r.branch)})'>
        <div class="part-row">
          <div>
            <div class="part ${r.qty > 0 ? 'ok' : 'warn'}">${r.part}</div>
            <div class="location">ğŸ“ ${r.location || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"} | ${r.branch || ""}</div>
          </div>
          <div style="text-align:left;font-size:16px;font-weight:700;color:${r.qty > 0 ? '#16a34a' : '#dc2626'}">
            ${r.qty}
          </div>
        </div>
        <div class="name">${r.name}</div>
        ${statusLine}
      </div>`;
  }).join("");

  box.innerHTML = html;
}

function runSearchSales(){
  const pcRaw = (pContains.value || "").trim();
  const pc = normalizePartNumber(pcRaw);
  const peRaw = (pEnds.value || "").trim();
  const pe = normalizePartNumber(peRaw);
  const ns = (nStarts.value || "").trim().toLowerCase();
  const nc = (nContains.value || "").trim().toLowerCase();

  const branchVal = branchFilter.value;

  let filtered = SALES_DATA.slice();

  if (branchVal && branchVal !== "*") {
    filtered = filtered.filter(r => String(r.branch || "").toLowerCase() === branchVal.toLowerCase());
  }

  if (pc) {
    filtered = filtered.filter(r => {
      const p = normalizePartNumber(r.part);
      return p.includes(pc);
    });
  }
  
  if (pe) {
    filtered = filtered.filter(r => {
      const p = normalizePartNumber(r.part);
      return p.endsWith(pe);
    });
  }
  
  if (ns) {
    filtered = filtered.filter(r => {
      const n = String(r.name || "").toLowerCase();
      return n.startsWith(ns);
    });
  }
  if (nc) {
    filtered = filtered.filter(r => {
      const n = String(r.name || "").toLowerCase();
      return n.includes(nc);
    });
  }

  LAST_RENDER = filtered;
  renderSales(filtered);
}

function renderSales(arr){
  const box = document.getElementById("results");
  if(!arr || arr.length === 0){
    box.innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:#6b7280">
        <div style="font-size:48px;margin-bottom:8px">ğŸ’°</div>
        <div style="font-size:14px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>
      </div>`;
    return;
  }

  const html = arr.map(r => {
    return `
      <div class="item sales-item" onclick='openSalesDetail(${JSON.stringify(r)})'>
        <div class="part-row">
          <div>
            <div class="part ok">${r.part}</div>
            <div class="location">ğŸª ${r.branch || ""}</div>
          </div>
          <div style="text-align:left">
            <div style="font-size:16px;font-weight:700;color:${r.qty > 0 ? '#16a34a' : '#dc2626'}">
              ${r.qty}
            </div>
            <div style="font-size:11px;color:#6b7280;margin-top:2px">
              ${r.maxPrice.toFixed(2)} Ø±ÙŠØ§Ù„
            </div>
          </div>
        </div>
        <div class="name">${r.name}</div>
        <div class="meta">
          Ø§Ù„ØªÙƒÙ„ÙØ©: ${r.cost.toFixed(2)} â€¢ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±: ${r.maxPrice.toFixed(2)}
        </div>
      </div>`;
  }).join("");

  box.innerHTML = html;
}

function openDetail(part, branch){
  if(CURRENT_VIEW !== "inventory") return;
  
  const item = ALL_DATA.find(r => r.part === part && r.branch === branch);
  if(!item) return;

  CURRENT_DETAIL_PART   = part;
  CURRENT_DETAIL_BRANCH = branch;

  const isCounted = item.lastCountedAt && item.lastCountedAt.trim() !== "";
  const lastCountQty = isCounted ? Number(item.lastCountQty ?? 0) : item.qty;

  const overlay = document.createElement("div");
  overlay.className = "detail-overlay";
  overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };

  overlay.innerHTML = `
    <div class="detail-card">
      <div class="detail-header">
        <span>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙ†Ù</span>
        <button class="detail-close" onclick="this.closest('.detail-overlay').remove()">âœ•</button>
      </div>

      <div class="detail-label">Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</div>
      <div class="detail-value">${item.part}</div>

      <div class="detail-label">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</div>
      <div class="detail-value">${item.name}</div>

      <div class="detail-label">Ø§Ù„ÙØ±Ø¹</div>
      <div class="detail-value">${item.branch || ""}</div>

      <div class="detail-label">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙØ¹Ù„ÙŠ (Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)</div>
      <div class="detail-value">${item.location || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</div>

      <div class="detail-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ø§Ù„Ù…ØªØ§Ø­ - Ø§Ù„Ù…Ø­Ø¬ÙˆØ²)</div>
      <div class="detail-value">${item.qty}</div>

      <div class="detail-label">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø±Ø¯</div>
      <input id="newLoc" type="text" class="detail-value" value="${item.countLocation || item.location || ""}" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù‡Ù†Ø§">

      <div class="detail-label">ÙƒÙ…ÙŠØ© Ø§Ù„Ø¬Ø±Ø¯</div>
      <div class="detail-qty-box">
        <button onclick="changeQty(-1)">âˆ’</button>
        <input id="countedQty" type="number" value="${lastCountQty}">
        <button onclick="changeQty(1)">+</button>
      </div>

      <div class="detail-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
      <textarea id="note" class="detail-value" rows="2" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">${item.note || ""}</textarea>

      <button class="detail-save" onclick="saveCount()">Ø­ÙØ¸ Ø§Ù„Ø¬Ø±Ø¯</button>
    </div>
  `;
  document.body.appendChild(overlay);
}

function changeQty(delta){
  const inp = document.getElementById("countedQty");
  if(!inp) return;
  let val = parseInt(inp.value) || 0;
  val += delta;
  if(val < 0) val = 0;
  inp.value = val;
}

function saveCount(){
  if(!CURRENT_DETAIL_PART || !CURRENT_DETAIL_BRANCH) return;

  const item = ALL_DATA.find(r => r.part === CURRENT_DETAIL_PART && r.branch === CURRENT_DETAIL_BRANCH);
  if(!item) return;

  const countedQty = parseInt(document.getElementById("countedQty").value) || 0;
  const newLoc = (document.getElementById("newLoc").value || "").trim();
  const note = (document.getElementById("note").value || "").trim();

  const params = new URLSearchParams({
    part: item.part,
    user: CURRENT_USER,
    role: CURRENT_ROLE,
    branch: item.branch,
    itemName: item.name,
    newLocation: newLoc,
    systemQty: item.qty,
    countedQty: countedQty,
    barcode: item.barcode || "",
    note: note,
    version: item.version || 0
  });

  fetch(API, {
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body: params
  })
  .then(r => r.json())
  .then(res => {
    if(!res.ok){
      if(res.conflict){
        showConflictNotification(res.error);
        setTimeout(()=>{ refreshCurrentView(); }, 1500);
      } else {
        alert(res.error || "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸");
      }
      return;
    }
    
    item.countLocation = newLoc;
    item.lastCountQty = countedQty;
    item.lastSystemQty = item.qty;
    item.lastCountedAt = new Date().toLocaleString("ar-SA");
    item.note = note;
    item.version = res.version || (item.version + 1);
    item.countedBy = CURRENT_USER;

    document.querySelector(".detail-overlay").remove();
    runSearchInventory();
    showNotification("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­");
    playBeep();
  })
  .catch(()=>{
    alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
  });
}

function showNotification(msg){
  const div = document.createElement("div");
  div.className = "success-notify";
  div.textContent = msg;
  document.body.appendChild(div);
  setTimeout(()=>{ div.remove(); }, 3000);
}

function showConflictNotification(msg){
  const div = document.createElement("div");
  div.className = "conflict-notify";
  div.textContent = msg;
  document.body.appendChild(div);
  setTimeout(()=>{ div.remove(); }, 4000);
}
function openSalesDetail(item){
  if(CURRENT_VIEW !== "sales") return;

  const overlay = document.createElement("div");
  overlay.className = "sales-detail-overlay";
  overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };

  overlay.innerHTML = `
    <div class="sales-detail-card">
      <div class="sales-detail-header">
        <span>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙ†Ù</span>
        <button class="sales-detail-close" onclick="this.closest('.sales-detail-overlay').remove()">âœ•</button>
      </div>

      <div class="info-row">
        <span class="info-label">Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</span>
        <span class="info-value">${item.part}</span>
      </div>

      <div class="info-row">
        <span class="info-label">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</span>
        <span class="info-value">${item.name}</span>
      </div>

      <div class="info-row">
        <span class="info-label">Ø§Ù„ÙØ±Ø¹</span>
        <span class="info-value">${item.branch || ""}</span>
      </div>

      <div class="info-row">
        <span class="info-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</span>
        <span class="info-value" style="color:${item.qty > 0 ? '#16a34a' : '#dc2626'}">${item.qty}</span>
      </div>

      <div class="info-row">
        <span class="info-label">Ø§Ù„ØªÙƒÙ„ÙØ©</span>
        <span class="info-value">${item.cost.toFixed(2)} Ø±ÙŠØ§Ù„</span>
      </div>

      <div class="info-row">
        <span class="info-label">Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø¨ÙŠØ¹</span>
        <span class="info-value">${item.maxPrice.toFixed(2)} Ø±ÙŠØ§Ù„</span>
      </div>

      <div class="price-section">
        <strong style="color:var(--primary)">ğŸ’° Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­</strong>
        <div class="price-input-group">
          <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
          <input type="number" id="salesPrice" step="0.01" placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
        </div>
        <div id="calcResults" class="calc-results">
          <div class="no-calc">Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­</div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);

  const inp = overlay.querySelector("#salesPrice");
  inp.addEventListener("input", ()=>{
    const price = parseFloat(inp.value) || 0;
    const resultsDiv = overlay.querySelector("#calcResults");
    if(price <= 0){
      resultsDiv.innerHTML = '<div class="no-calc">Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­</div>';
      return;
    }

    const profit = price - item.cost;
    const profitPercent = item.cost > 0 ? ((profit / item.cost) * 100) : 0;

    resultsDiv.innerHTML = `
      <div class="calc-row">
        <span class="calc-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</span>
        <span class="calc-value">${price.toFixed(2)} Ø±ÙŠØ§Ù„</span>
      </div>
      <div class="calc-row">
        <span class="calc-label">Ø§Ù„ØªÙƒÙ„ÙØ©</span>
        <span class="calc-value">${item.cost.toFixed(2)} Ø±ÙŠØ§Ù„</span>
      </div>
      <div class="calc-row">
        <span class="calc-label">Ø§Ù„Ø±Ø¨Ø­</span>
        <span class="calc-value" style="color:${profit >= 0 ? '#16a34a' : '#dc2626'}">
          ${profit.toFixed(2)} Ø±ÙŠØ§Ù„
        </span>
      </div>
      <div class="calc-row">
        <span class="calc-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­</span>
        <span class="calc-value" style="color:${profitPercent >= 0 ? '#16a34a' : '#dc2626'}">
          ${profitPercent.toFixed(1)}%
        </span>
      </div>
    `;
  });
}
</script>

</body>
</html>
