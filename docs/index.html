<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Ø´Ø±ÙƒØ© Ø§Ù„Ù‚Ø§Ø¶ÙŠ</title>

<link rel="manifest" href="manifest.json">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
:root{
  --bg:#f3f4f6;
  --card:#ffffff;
  --primary:#1976d2;
  --ok:#2e7d32;
  --warn:#c62828;
  --text:#1f2933;
  --muted:#6b7280;
  --border:#d1d5db;
}

body{
  margin:0;
  font-family:system-ui,-apple-system;
  min-height:100vh;
  background:
    radial-gradient(circle at top left, #e3f2fd 0, transparent 55%),
    radial-gradient(circle at bottom right, #e0f7fa 0, #f3f4f6 55%);
  padding:12px;
  color:var(--text);
}
*{box-sizing:border-box}
input, textarea, button{
  font-size:16px;
}

/* LOGIN */
.login-screen{
  position:fixed;
  inset:0;
  z-index:1000;
  display:flex;
  justify-content:center;
  align-items:center;
}
.login-box{
  width:100%;
  max-width:360px;
  padding:22px 20px 18px;
  border-radius:26px;
  background:#ffffff;
  box-shadow:0 22px 55px rgba(15,23,42,0.25);
  border:1px solid rgba(209,213,219,0.9);
  color:var(--text);
  text-align:center;
}
.login-logo{
  width:110px;
  height:60px;
  margin:4px auto 14px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.login-logo img{
  max-width:100%;
  max-height:100%;
  object-fit:contain;
  display:block;
}
.login-box h3{
  margin:6px 0 4px;
  font-size:18px;
  font-weight:800;
}
.login-box p{
  font-size:12px;
  color:var(--muted);
  margin:0 0 12px;
}
.login-box input{
  width:100%;
  padding:11px;
  margin-top:9px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#f9fafb;
  color:var(--text);
}
.login-box input::placeholder{color:#9ca3af}
.login-btn{
  width:100%;
  margin-top:14px;
  padding:11px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#1976d2,#0d47a1);
  color:#ffffff;
  cursor:pointer;
  font-weight:700;
  letter-spacing:0.3px;
  box-shadow:0 10px 22px rgba(25,118,210,0.45);
}
.login-btn:active{
  transform:translateY(1px);
  box-shadow:0 4px 10px rgba(25,118,210,0.35);
}
#loginError{margin-top:8px;font-size:12px;color:#d32f2f}
#loginLoading{display:none;margin-top:6px;font-size:11px;color:#6b7280}
#buildInfo{margin-top:10px;font-size:11px;color:#9ca3af}

/* MAIN MENU */
#mainScreen{
  display:none;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.main-card{
  width:100%;
  max-width:380px;
  background:rgba(255,255,255,0.9);
  border-radius:28px;
  padding:18px 16px 14px;
  box-shadow:0 24px 55px rgba(15,23,42,0.25);
  border:1px solid rgba(209,213,219,0.9);
  color:var(--text);
}

.main-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  margin-bottom:12px;
}

.main-title{
  font-size:18px;
  font-weight:800;
}

.main-sub{
  font-size:11px;
  color:var(--muted);
}

.main-badge{
  font-size:11px;
  background:rgba(25,118,210,0.1);
  color:#1565c0;
  padding:4px 10px;
  border-radius:999px;
}

/* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
.main-list{
  margin-top:4px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.main-btn{
  width:100%;
  border:none;
  border-radius:18px;
  padding:10px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
  background:#ffffff;
  color:var(--text);
  box-shadow:0 4px 10px rgba(15,23,42,0.10);
  transition:transform .12s ease, box-shadow .12s ease;
}
.main-btn span.left{
  display:flex;
  align-items:center;
  gap:10px;
}
.main-icon{
  width:32px;
  height:32px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  background:#eef2ff;
  color:#1d4ed8;
}
.main-arrow{
  font-size:13px;
  color:#9ca3af;
  font-weight:600;
}
.main-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 8px 18px rgba(15,23,42,0.18);
}
.main-btn.primary{
  background:linear-gradient(135deg,#6366f1,#4f46e5);
  color:#ffffff;
}
.main-btn.primary .main-icon{
  background:rgba(255,255,255,0.18);
  color:#ffffff;
}
.main-btn.primary .main-arrow{
  color:#e5e7eb;
}

/* APP TOP */
#appScreen{display:none}
.top-bar{
  max-width:430px;
  margin:0 auto 6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:var(--text);
}
.top-title{font-weight:700;font-size:15px}
.icon-btn{
  border:none;
  border-radius:8px;
  padding:6px 12px;
  background:#ffffff;
  color:#1f2933;
  box-shadow:0 1px 4px rgba(148,163,184,.5);
  cursor:pointer;
}

/* FILTER + RESULTS */
.filter-wrap,#results{
  max-width:430px;
  margin:0 auto 8px;
}
.filter-wrap{
  position:sticky;
  top:0;
  z-index:10;
}
.filter-card{
  background:#ffffff;
  border-radius:12px;
  padding:6px;
  box-shadow:0 2px 6px rgba(148,163,184,.35);
  color:var(--text);
}
.filter-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
}
.clear-btn{
  font-size:12px;
  background:#e5e7eb;
  color:var(--text);
  border:none;
  border-radius:6px;
  padding:4px 8px;
  cursor:pointer;
}
.filter-row{display:flex;gap:6px;margin-bottom:6px}
.filter-input{
  flex:1;
  min-width:0;
  padding:7px 8px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#f9fafb;
  color:var(--text);
  font-size:14px;
}
.filter-input.small{
  flex:1 1 30%;
  padding:5px 6px;
  font-size:14px;
}
.filter-input::placeholder{color:#9ca3af}
@media(max-width:480px){
  .filter-row{flex-wrap:wrap}
  .filter-input{flex:1 1 48%}
  .filter-input.small{flex:1 1 30%}
}

/* ITEM */
.item{
  background:#ffffff;
  border-radius:12px;
  padding:9px;
  margin-bottom:7px;
  box-shadow:0 3px 8px rgba(148,163,184,.35);
  color:var(--text);
}
.part-row{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.part{font-weight:700;color:#1976d2}
.part.ok{color:var(--ok)}
.part.warn{color:var(--warn)}
.location{font-size:12px;color:var(--muted)}
.name{font-size:13px;margin-top:2px}
.meta{font-size:12px;color:var(--muted);margin-top:4px}
.status{font-size:12px;margin-top:4px}

/* Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: Ø§Ù„Ù…ØªÙˆÙØ± Ø£Ø²Ø±Ù‚ */
.sales-item .part.ok{
  color:var(--primary);
}

/* DETAIL */
.detail-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.35);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  z-index:9999;
}
.detail-card{
  width:100%;
  max-width:430px;
  background:#ffffff;
  border-radius:16px 16px 0 0;
  padding:12px;
  color:var(--text);
  box-shadow:0 -6px 20px rgba(148,163,184,.45);
}
.detail-header{
  display:flex;
  justify-content:space-between;
  font-weight:600;
}
.detail-close{
  border:none;
  background:none;
  font-size:18px;
  cursor:pointer;
  color:var(--muted);
}
.detail-label{font-size:12px;color:var(--muted);margin-top:10px}
.detail-qty-box{display:flex;gap:8px;margin-top:6px}
.detail-qty-box button{
  width:40px;
  border:none;
  border-radius:10px;
  font-size:20px;
  cursor:pointer;
  background:#e5e7eb;
  color:var(--text);
}
.detail-qty-box input{
  flex:1;
  text-align:center;
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px;
  background:#f9fafb;
  color:var(--text);
}
.detail-save{
  width:100%;
  margin-top:12px;
  padding:10px;
  border:none;
  border-radius:10px;
  background:linear-gradient(135deg,#1976d2,#0d47a1);
  color:#fff;
  cursor:pointer;
}

/* SCANNER */
#scannerContainer{
  display:none;
  max-width:430px;
  margin:6px auto;
  background:#000;
  border-radius:12px;
  overflow:hidden;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <img src="logo.png.gif" alt="">
    </div>

    <h3>Ø´Ø±ÙƒØ© Ø§Ù„Ù‚Ø§Ø¶ÙŠ Ù„Ø¨ÙŠØ¹ Ù‚Ø·Ø¹ ØºÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h3>
    <p>ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</p>

    <input id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <input id="loginPass" type="password" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ">

    <button class="login-btn" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginLoading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
    <div id="loginError"></div>
    <div id="buildInfo"></div>
  </div>
</div>

<!-- MAIN MENU -->
<div id="mainScreen">
  <div class="main-card">
    <div class="main-header">
      <div>
        <div class="main-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="main-sub">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</div>
      </div>
      <div class="main-badge">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
    </div>

    <div class="main-list">
      <button class="main-btn" onclick="openMenu(2)">
        <span class="left">
          <span class="main-icon">ğŸš—</span>
          <span>Ø¨Ø¶Ø§Ø¹Ø© Ø´Ø±ÙƒØ© ØªÙˆÙŠÙˆØªØ§</span>
        </span>
        <span class="main-arrow">â€º</span>
      </button>

      <button class="main-btn primary" onclick="openMenu(3)">
        <span class="left">
          <span class="main-icon">ğŸ“‹</span>
          <span>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù</span>
        </span>
        <span class="main-arrow">Ø¯Ø®ÙˆÙ„</span>
      </button>

      <button class="main-btn" onclick="openSalesMenu()">
        <span class="left">
          <span class="main-icon">ğŸ’°</span>
          <span>Ù…Ø¨ÙŠØ¹Ø§Øª</span>
        </span>
        <span class="main-arrow">Ø¹Ø±Ø¶</span>
      </button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="appScreen">

  <div class="top-bar">
    <div class="top-title" id="topTitle">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
    <button class="icon-btn" onclick="backToMain()">Ø¹ÙˆØ¯Ø©</button>
  </div>

  <div class="filter-wrap">
    <div class="filter-card">

      <div class="filter-header">
        <strong>Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</strong>
        <button class="clear-btn" onclick="clearFilters()">Ù…Ø³Ø­ âœ•</button>
      </div>

      <div class="filter-row" style="margin-bottom:6px">
        <!-- Ø§Ù„ÙØ±Ø¹: Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ØŒ ÙˆÙŠÙØ¹ØªØ¨Ø± Ø§Ø®ØªÙŠØ§Ø± ØµØ­ÙŠØ­ -->
        <select id="branchFilter" class="filter-input small" required>
          <option value="*">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
          <option value="Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
          <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
          <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù„Ø«</option>
          <option value="Ù…Ø³ØªÙˆØ¯Ø¹ ÙØ±Ø¹ 3">Ù…Ø³ØªÙˆØ¯Ø¹ ÙØ±Ø¹ 3</option>
        </select>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:6px;margin:4px 0 6px;font-size:11px" id="countStateWrap">
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="all" checked style="margin:0">
          <span>Ø§Ù„ÙƒÙ„</span>
        </label>
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="counted" style="margin:0">
          <span>Ø§Ù„Ù…Ø¬Ø±Ø¯</span>
        </label>
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="diff" style="margin:0">
          <span>ÙÙŠÙ‡ ÙØ±Ù‚</span>
        </label>
        <label style="display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="radio" name="countState" value="not" style="margin:0">
          <span>ØºÙŠØ± Ù…Ø¬Ø±Ø¯</span>
        </label>
      </div>

      <div class="filter-row">
        <input id="pContains" class="filter-input" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù ÙŠØ­ØªÙˆÙŠ">
        <input id="pEnds" class="filter-input" placeholder="ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€">
      </div>

      <div class="filter-row">
        <input id="nStarts" class="filter-input" placeholder="Ø§Ø³Ù… ÙŠØ¨Ø¯Ø£">
        <input id="nContains" class="filter-input" placeholder="ÙŠØ­ØªÙˆÙŠ">
      </div>

      <div class="filter-row">
        <input id="locFrom" class="filter-input small" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù†">
        <input id="locTo"   class="filter-input small" placeholder="Ø¥Ù„Ù‰">

        <div style="display:flex;gap:4px;flex:1 1 30%;align-items:center">
          <input id="barcode" class="filter-input small" placeholder="Ø¨Ø§Ø±ÙƒÙˆØ¯">
          <button type="button"
                  id="scanBtn"
                  style="border:none;background:#1976d2;color:#fff;
                         padding:5px 8px;border-radius:8px;cursor:pointer;">
            ğŸ“·
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="scannerContainer">
    <div id="reader" style="width:100%;"></div>
    <button type="button"
            onclick="stopScan()"
            style="width:100%;border:none;background:#eee;padding:6px;
                   font-size:14px;cursor:pointer">
      Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    </button>
  </div>

  <div id="results"></div>
  <div id="salesLoading"
       style="display:none;text-align:center;font-size:13px;color:#6b7280;margin:8px 0;">
    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª...
  </div>

</div>

<audio id="beepAudio">
  <source src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YUAAAAA=" type="audio/wav">
</audio>

<script>
document.getElementById("buildInfo").textContent =
  "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù…Ù„Ù: " +
  new Date(document.lastModified).toLocaleString("ar-SA");

// Ø¹Ø±Ø¶: inventory Ø£Ùˆ sales
let CURRENT_VIEW = "inventory";

const API="https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";

let ALL_DATA = [];
let SALES_DATA = [];
let LAST_RENDER = [];
let CURRENT_USER = "";
let CURRENT_ROLE = "";

/* Ù…Ù†Ø¹ pinch/double-tap zoom ÙÙŠ iOS */
document.addEventListener("gesturestart", function (e) {
  e.preventDefault();
}, { passive: false });

let lastTouchEnd = 0;
document.addEventListener("touchend", function (e) {
  const now = Date.now();
