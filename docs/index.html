<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>جرد المخزون</title><style>:root{--bg:#f4f5f7;--card:#fff;--primary:#1976d2;--green:#1b5e20;--text:#222;--muted:#777;--border:#e0e0e0}body{font-family:system-ui,-apple-system,BlinkMacSystemFont;background:var(--bg);margin:0;padding:8px}.top-bar{max-width:430px;margin:0 auto 6px;display:flex;justify-content:space-between;align-items:center}.top-title{font-size:15px;font-weight:600;color:var(--text)}.top-actions{display:flex;gap:6px}.icon-btn{width:30px;height:30px;border:none;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;background:var(--card);box-shadow:0 1px 4px rgba(0,0,0,.12);color:var(--text);cursor:pointer}.filter-wrap{max-width:430px;margin:0 auto 8px}.filter-card{background:var(--card);border-radius:12px;padding:6px;box-shadow:0 2px 6px rgba(0,0,0,.05)}.filter-row{display:flex;gap:4px;margin-bottom:4px}.filter-input{flex:1;padding:6px 7px;font-size:12px;border-radius:8px;border:1px solid var(--border);background:#fafafa}.loader-wrap{max-width:430px;margin:0 auto 6px}.loader-bar{height:4px;width:100%;background:#e0e0e0;border-radius:4px;overflow:hidden}.loader-fill{height:100%;width:0%;background:var(--primary);transition:width .2s}.loader-text{font-size:11px;color:var(--muted);margin-top:2px;text-align:center}#results{max-width:430px;margin:0 auto 8px;padding-bottom:8px}.item{background:var(--card);border-radius:12px;padding:9px;margin-bottom:7px;box-shadow:0 3px 8px rgba(0,0,0,.05);cursor:pointer}.part-row{display:flex;justify-content:space-between;align-items:center}.part{font-weight:700;font-size:14px;color:var(--primary)}.part-counted{color:var(--green)}.edit-btn{width:26px;height:26px;border:none;border-radius:7px;background:#f1f3f4;font-size:14px;display:flex;align-items:center;justify-content:center;color:var(--text);cursor:pointer}.name{font-size:13px;margin-top:2px;color:var(--text)}.meta-line{display:flex;justify-content:space-between;margin-top:4px;font-size:12px;color:var(--muted)}.meta-right{text-align:right}.meta-left{text-align:left}.meta-second{margin-top:2px;font-size:12px;color:var(--muted)}.msg{text-align:center;padding:10px;color:var(--muted);font-size:13px}.detail-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;justify-content:center;align-items:flex-end;z-index:999}.detail-card{width:100%;max-width:430px;background:var(--card);border-radius:16px 16px 0 0;padding:12px;box-shadow:0 -3px 12px rgba(0,0,0,.3)}.detail-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-weight:600}.detail-close{border:none;background:none;font-size:18px;cursor:pointer}.detail-body{max-height:60vh;overflow-y:auto}.detail-label{font-size:12px;color:var(--muted);margin-top:6px}.detail-value{font-size:14px;color:var(--text);margin-top:2px}.detail-qty-box{display:flex;gap:8px;margin-top:4px}.detail-qty-box button{width:40px;font-size:20px;border:none;border-radius:10px;background:#f1f3f4;cursor:pointer}.detail-qty-box input{flex:1;text-align:center;font-size:16px;padding:7px;border-radius:9px;border:1px solid var(--border)}.detail-save{margin-top:10px;width:100%;padding:10px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-size:15px;cursor:pointer}</style></head><body><div class="top-bar"><div class="top-title">جرد المخزون</div><div class="top-actions"><button id="btnRefresh" class="icon-btn" onclick="handleRefreshClick()">⟳</button><button class="icon-btn" onclick="clearAll()">✕</button></div></div><div class="loader-wrap" id="loaderWrap" style="display:none"><div class="loader-bar"><div class="loader-fill" id="loaderFill"></div></div><div class="loader-text" id="loaderText"></div></div><div class="filter-wrap"><div class="filter-card"><div class="filter-row"><input class="filter-input" id="pContains" placeholder="رقم الصنف يحتوي على"><input class="filter-input" id="pEnds" placeholder="ينتهي بـ"></div><div class="filter-row"><input class="filter-input" id="nStarts" placeholder="اسم الصنف يبدأ بـ"><input class="filter-input" id="nContains" placeholder="يحتوي على"></div><div class="filter-row"><input class="filter-input" id="locFrom" placeholder="الموقع من"><input class="filter-input" id="locTo" placeholder="إلى"></div></div></div><div id="results"></div><script>const API="https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";const CACHE_KEY="inv_v3";const MAX=100;const IS_ADMIN=true;let ALL_DATA=[];let isRef=false;(function(){if(!IS_ADMIN)document.getElementById("btnRefresh").style.display="none"})();function setInterval(()=>{if(!isRef)refreshData(true)},60000);loadData();
{const c=localStorage.getItem(CACHE_KEY);if(c){try{ALL_DATA=JSON.parse(c);runSearch();return}catch(e){ALL_DATA=[]}}refreshData(true)}function handleRefreshClick(){if(!IS_ADMIN){alert("للمشرف فقط");return}if(isRef)return;refreshData(false)}function showLoader(){document.getElementById("loaderWrap").style.display="block";document.getElementById("loaderFill").style.width="0%";document.getElementById("loaderText").textContent="جاري التحميل..."}function updateLoaderProgress(p){document.getElementById("loaderFill").style.width=p+"%";document.getElementById("loaderText").textContent="جاري التحميل... "+p+"%"}function hideLoader(){document.getElementById("loaderWrap").style.display="none"}async function refreshData(isFirst){try{isRef=true;showLoader();updateLoaderProgress(5);const s=Date.now();const r=await fetch(API);updateLoaderProgress(40);const d=await r.json();updateLoaderProgress(80);if(Array.isArray(d)){ALL_DATA=d;localStorage.setItem(CACHE_KEY,JSON.stringify(d));runSearch()}else if(d&&d.error){alert("خطأ: "+d.error)}const t=Date.now()-s;updateLoaderProgress(100);if(!isFirst)alert("تم التحديث في "+(t/1000).toFixed(1)+" ث")}catch(e){if(!isFirst)alert("فشل التحديث")}finally{isRef=false;setTimeout(hideLoader,400)}}document.querySelectorAll(".filter-input").forEach(i=>i.addEventListener("input",debounce));let timer=null;function debounce(){clearTimeout(timer);timer=setTimeout(runSearch,700)}function runSearch(){const el=document.getElementById("results");if(!ALL_DATA.length){el.innerHTML="<div class='msg'>جاري التحميل...</div>";return}const pC=pContains.value.trim().toLowerCase();const pE=pEnds.value.trim().toLowerCase();const nS=nStarts.value.trim().toLowerCase();const nC=nContains.value.trim().toLowerCase();const lF=locFrom.value.trim().toLowerCase();const lT=locTo.value.trim().toLowerCase();if(!pC&&!pE&&!nS&&!nC&&!lF&&!lT){el.innerHTML="<div class='msg'>اكتب شيئًا للبحث</div>";return}const res=[];for(const r of ALL_DATA){const part=String(r.part??"").toLowerCase();const name=String(r.name??"").toLowerCase();const loc=String(r.location??"").toLowerCase();if(pC&&!part.includes(pC))continue;if(pE&&!part.endsWith(pE))continue;if(nS&&!name.startsWith(nS))continue;if(nC&&!name.includes(nC))continue;if(lF&&loc<lF)continue;if(lT&&loc>lT)continue;res.push(r)}if(lF||lT){res.sort((a,b)=>{const la=String(a.location??"").toLowerCase();const lb=String(b.location??"").toLowerCase();return la<lb?-1:la>lb?1:0})}else if(pC||pE){res.sort((a,b)=>{const pa=String(a.part??"").toLowerCase();const pb=String(b.part??"").toLowerCase();return pa<pb?-1:pa>pb?1:0})}render(res.slice(0,MAX))}function render(data){const el=document.getElementById("results");if(!data.length){el.innerHTML="<div class='msg'>لا توجد نتائج</div>";return}let h="";data.forEach(r=>{const sq=Number(r.qty)||0;const cq=Number(r.countedQty||0);const ic=cq>0;const pc=ic?"part part-counted":"part";const sp=String(r.part||"").replace(/'/g,"\\'");h+=`<div class="item" onclick="openDetail('${sp}')"><div class="part-row"><div class="${pc}">${r.part||""}</div><button class="edit-btn" onclick="event.stopPropagation();openDetail('${sp}')">✎</button></div><div class="name">${r.name||""}</div><div class="meta-line"><span class="meta-right">النظام: <b>${sq}</b></span><span class="meta-left">الموقع: ${r.location||"-"}</span></div><div class="meta-second">الجرد: <b>${cq}</b></div></div>`});el.innerHTML=h}function openDetail(part){const it=ALL_DATA.find(r=>String(r.part)===String(part));if(!it)return;const cq=Number(it.countedQty||0);const lu=it.lastCountUser||"";const lt=it.lastCountTime?("آخر جرد: "+it.lastCountTime+(lu?" - "+lu:"")):"";const ov=document.createElement("div");ov.className="detail-overlay";const sp=String(it.part||"").replace(/'/g,"\\'");const sn=String(it.name||"").replace(/'/g,"\\'");ov.innerHTML=`<div class="detail-card"><div class="detail-header"><span>تفاصيل</span><button class="detail-close" onclick="this.closest('.detail-overlay').remove()">✕</button></div><div class="detail-body"><div class="detail-label">رقم الصنف</div><div class="detail-value">${it.part||""}</div><div class="detail-label">اسم الصنف</div><div class="detail-value">${it.name||""}</div><div class="detail-label">الموقع</div><div class="detail-value">${it.location||"-"}</div><div class="detail-label">كمية النظام</div><div class="detail-value">${it.qty??""}</div><div class="detail-label">كمية الجرد</div><div class="detail-qty-box"><button onclick="changeQty(-1)">−</button><input id="detailQty" type="number" value="${cq}"><button onclick="changeQty(1)">+</button></div><div class="detail-label">ملاحظات</div><textarea id="detailNote" style="width:100%;min-height:60px;margin-top:4px;border-radius:9px;border:1px solid var(--border);padding:6px;font-size:13px"></textarea><div id="detailInfo" style="margin-top:6px;font-size:12px;color:var(--muted)">${lt}</div></div><button class="detail-save" onclick="saveQty('${sp}','${sn}',${Number(it.qty)||0})">حفظ</button></div>`;document.body.appendChild(ov)}function changeQty(d){const inp=document.getElementById("detailQty");if(!inp)return;let v=Number(inp.value)||0;v+=d;if(v<0)v=0;inp.value=v}function saveQty(part,name,sq){const qi=document.getElementById("detailQty");const ni=document.getElementById("detailNote");if(!qi)return;let v=Number(qi.value)||0;if(v<0)v=0;const note=ni?ni.value.trim():"";fetch(API,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({part:part,itemName:name,systemQty:sq,countedQty:v,note:note}).toString()}).then(r=>r.json()).then(res=>{if(!res.ok){alert(res.error||"فشل الحفظ");return}alert("تم الحفظ: "+(res.user?.name||""));
refreshData(true)}).catch(()=>alert("خطأ في الاتصال"));document.querySelector(".detail-overlay")?.remove()}function clearAll(){document.querySelectorAll(".filter-input").forEach(i=>i.value="");document.getElementById("results").innerHTML=""}loadData();</script></body></html>
