<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>جرد المخزون</title>

  <style>
    :root{
      --bg:#f4f5f7;
      --card:#ffffff;
      --primary:#1976d2;
      --green:#1b5e20;
      --text:#222;
      --muted:#777;
      --border:#e0e0e0;
    }

    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont;
      background:var(--bg);
      margin:0;
      padding:8px;
    }

    /* شريط علوي */
    .top-bar{
      max-width:430px;
      margin:0 auto 6px auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .top-title{
      font-size:15px;
      font-weight:700;
      color:var(--text);
    }
    .top-actions{
      display:flex;
      gap:6px;
    }
    .icon-btn{
      width:32px;
      height:32px;
      border:none;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      background:var(--card);
      box-shadow:0 1px 4px rgba(0,0,0,.12);
      color:var(--text);
      cursor:pointer;
    }

    /* شريط تحميل */
    .loader-wrap{max-width:430px;margin:0 auto 6px;display:none;}
    .loader-bar{height:4px;width:100%;background:#e0e0e0;border-radius:4px;overflow:hidden;}
    .loader-fill{height:100%;width:0%;background:var(--primary);transition:width .2s;}
    .loader-text{font-size:11px;color:var(--muted);margin-top:2px;text-align:center;}

    /* فلاتر */
    .filter-wrap{max-width:430px;margin:0 auto 8px;}
    .filter-card{
      background:var(--card);
      border-radius:12px;
      padding:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.05);
    }
    .filter-row{display:flex;gap:6px;margin-bottom:6px;}
    .filter-input{
      flex:1;
      padding:8px 9px;
      font-size:12.5px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fafafa;
      outline:none;
    }

    #results{max-width:430px;margin:0 auto 8px;padding-bottom:8px;}

    /* بطاقة نتيجة */
    .item{
      background:var(--card);
      border-radius:14px;
      padding:10px;
      margin-bottom:8px;
      box-shadow:0 3px 8px rgba(0,0,0,.05);
      cursor:pointer;
    }
    .part-row{display:flex;justify-content:space-between;align-items:center;gap:8px;}
    .part{font-weight:800;font-size:14.5px;color:var(--primary);}
    .part-counted{color:var(--green);}
    .edit-btn{
      width:28px;height:28px;border:none;border-radius:9px;
      background:#f1f3f4;font-size:14px;
      display:flex;align-items:center;justify-content:center;
      color:var(--text);cursor:pointer;
    }
    .name{font-size:13px;margin-top:3px;color:var(--text);}
    .meta-line{
      display:flex;justify-content:space-between;align-items:center;
      margin-top:6px;font-size:12px;color:var(--muted);
      gap:8px;
    }
    .meta-right{text-align:right;}
    .meta-left{text-align:left;}
    .meta-second{margin-top:3px;font-size:12px;color:var(--muted);}
    .msg{text-align:center;padding:12px;color:var(--muted);font-size:13px;}

    /* تفاصيل */
    .detail-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:flex; justify-content:center; align-items:flex-end;
      z-index:999;
    }
    .detail-card{
      width:100%; max-width:430px;
      background:var(--card);
      border-radius:18px 18px 0 0;
      padding:12px;
      box-shadow:0 -3px 12px rgba(0,0,0,.3);
    }
    .detail-header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:8px;font-weight:700;color:var(--text);
    }
    .detail-close{border:none;background:none;font-size:18px;cursor:pointer;}
    .detail-body{max-height:62vh;overflow-y:auto;padding-bottom:2px;}
    .detail-label{font-size:12px;color:var(--muted);margin-top:8px;}
    .detail-value{font-size:14px;color:var(--text);margin-top:3px;word-break:break-word;}
    .detail-qty-box{display:flex;gap:8px;margin-top:6px;}
    .detail-qty-box button{
      width:42px;font-size:20px;border:none;border-radius:12px;
      background:#f1f3f4;cursor:pointer;
    }
    .detail-qty-box input{
      flex:1;text-align:center;font-size:16px;padding:8px;
      border-radius:11px;border:1px solid var(--border);
      outline:none;
    }
    .detail-note{
      width:100%;
      min-height:70px;
      margin-top:6px;
      border-radius:11px;
      border:1px solid var(--border);
      padding:8px;
      font-size:13px;
      outline:none;
      resize:vertical;
    }
    .detail-info{
      margin-top:8px;font-size:12px;color:var(--muted);
    }
    .detail-save{
      margin-top:10px;width:100%;
      padding:11px;border:none;border-radius:12px;
      background:var(--primary);color:#fff;
      font-size:15px;cursor:pointer;
    }
    .detail-save[disabled]{opacity:.6;cursor:not-allowed;}
  </style>
</head>

<body>
  <div class="top-bar">
    <div class="top-title">جرد المخزون</div>
    <div class="top-actions">
      <button id="btnRefresh" class="icon-btn" title="تحديث" onclick="handleRefreshClick()">⟳</button>
      <button class="icon-btn" title="مسح" onclick="clearAll()">✕</button>
    </div>
  </div>

  <div class="loader-wrap" id="loaderWrap">
    <div class="loader-bar"><div class="loader-fill" id="loaderFill"></div></div>
    <div class="loader-text" id="loaderText"></div>
  </div>

  <div class="filter-wrap">
    <div class="filter-card">
      <div class="filter-row">
        <input class="filter-input" id="pContains" placeholder="رقم الصنف يحتوي على">
        <input class="filter-input" id="pEnds" placeholder="ينتهي بـ">
      </div>
      <div class="filter-row">
        <input class="filter-input" id="nStarts" placeholder="اسم الصنف يبدأ بـ">
        <input class="filter-input" id="nContains" placeholder="اسم الصنف يحتوي على">
      </div>
      <div class="filter-row">
        <input class="filter-input" id="locFrom" placeholder="الموقع من">
        <input class="filter-input" id="locTo" placeholder="إلى">
      </div>
    </div>
  </div>

  <div id="results"></div>

<script>
/* =========================
   إعدادات
========================= */
const API = "https://script.google.com/macros/s/AKfycbwJblWxDTa3sOUQQwm5xoX3Cua6ixm0nFPHuXqRGRU7I0iP4d86vVIdWrXJP2ei8_km/exec";
const CACHE_KEY = "inv_v4";
const MAX = 120;        // عدد النتائج المعروضة
const IS_ADMIN = true;  // اخف زر التحديث لغير المشرف

let ALL_DATA = [];
let isRefreshing = false;
let debounceTimer = null;

/* =========================
   تشغيل أولي
========================= */
(function init(){
  if(!IS_ADMIN){
    document.getElementById("btnRefresh").style.display = "none";
  }

  // ربط البحث
  document.querySelectorAll(".filter-input").forEach(i => {
    i.addEventListener("input", () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(runSearch, 450);
    });
  });

  // تحديث كل دقيقة (بدون إزعاج)
  setInterval(() => {
    if (!isRefreshing) refreshData(true);
  }, 60000);

  // عند العودة للتبويب
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden && !isRefreshing) refreshData(true);
  });

  loadData();
})();

function loadData(){
  const c = localStorage.getItem(CACHE_KEY);
  if (c){
    try{
      ALL_DATA = JSON.parse(c);
      runSearch(true); // true = يسمح يعرض نتائج حتى لو الفلاتر فاضية؟ لا، فقط يجدد الرسالة
      return;
    }catch(e){
      ALL_DATA = [];
    }
  }
  refreshData(true);
}

/* =========================
   Loader
========================= */
function showLoader(msg="جاري التحميل..."){
  const wrap = document.getElementById("loaderWrap");
  wrap.style.display = "block";
  document.getElementById("loaderFill").style.width = "0%";
  document.getElementById("loaderText").textContent = msg;
}
function updateLoaderProgress(p){
  document.getElementById("loaderFill").style.width = p + "%";
  document.getElementById("loaderText").textContent = "جاري التحميل... " + p + "%";
}
function hideLoader(){
  document.getElementById("loaderWrap").style.display = "none";
}

/* =========================
   Refresh
========================= */
function handleRefreshClick(){
  if (!IS_ADMIN) return;     // صامت
  if (isRefreshing) return;
  refreshData(false);
}

async function refreshData(silent){
  try{
    isRefreshing = true;
    if(!silent){
      showLoader();
      updateLoaderProgress(5);
    }

    const res = await fetch(API, { cache: "no-store" });

    if(!silent) updateLoaderProgress(45);

    const data = await res.json();

    if(!silent) updateLoaderProgress(85);

    if(Array.isArray(data)){
      ALL_DATA = data;
      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      runSearch(true);
    }

    if(!silent){
      updateLoaderProgress(100);
      setTimeout(hideLoader, 350);
    }

  }catch(e){
    // بدون تنبيه، فقط في وضع غير صامت يمكن نعرض شيئًا بسيطًا
    if(!silent){
      document.getElementById("loaderText").textContent = "تعذر التحديث";
      setTimeout(hideLoader, 700);
    }
  }finally{
    isRefreshing = false;
  }
}

/* =========================
   Search + Render
========================= */
function runSearch(fromAuto=false){
  const el = document.getElementById("results");

  if(!ALL_DATA.length){
    el.innerHTML = "<div class='msg'>جاري التحميل...</div>";
    return;
  }

  const pC = (pContains.value || "").trim().toLowerCase();
  const pE = (pEnds.value || "").trim().toLowerCase();
  const nS = (nStarts.value || "").trim().toLowerCase();
  const nC = (nContains.value || "").trim().toLowerCase();
  const lF = (locFrom.value || "").trim().toLowerCase();
  const lT = (locTo.value || "").trim().toLowerCase();

  // إذا كل الفلاتر فاضية
  if(!pC && !pE && !nS && !nC && !lF && !lT){
    el.innerHTML = "<div class='msg'>اكتب شيئًا للبحث</div>";
    return;
  }

  const res = ALL_DATA.filter(r => {
    const part = String(r.part ?? "").toLowerCase();
    const name = String(r.name ?? "").toLowerCase();
    const loc  = String(r.location ?? "").toLowerCase();

    if(pC && !part.includes(pC)) return false;
    if(pE && !part.endsWith(pE)) return false;
    if(nS && !name.startsWith(nS)) return false;
    if(nC && !name.includes(nC)) return false;

    // مقارنة نصية للمواقع (مناسبة لو مواقعك مثل G004 .. إلخ)
    if(lF && loc < lF) return false;
    if(lT && loc > lT) return false;

    return true;
  });

  // ترتيب منطقي
  if(lF || lT){
    res.sort((a,b) => String(a.location??"").localeCompare(String(b.location??""), "ar"));
  }else if(pC || pE){
    res.sort((a,b) => String(a.part??"").localeCompare(String(b.part??""), "en"));
  }

  render(res.slice(0, MAX));
}

function escHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function render(data){
  const el = document.getElementById("results");
  if(!data.length){
    el.innerHTML = "<div class='msg'>لا توجد نتائج</div>";
    return;
  }

  let h = "";
  for(const r of data){
    const sq = Number(r.qty) || 0;
    const cq = Number(r.countedQty) || 0;
    const counted = cq > 0;

    const part = escHtml(r.part || "");
    const name = escHtml(r.name || "");
    const loc  = escHtml(r.location || "-");

    h += `
      <div class="item" onclick="openDetail('${encodeURIComponent(r.part || "")}')">
        <div class="part-row">
          <div class="${counted ? "part part-counted" : "part"}">${part}</div>
          <button class="edit-btn" onclick="event.stopPropagation();openDetail('${encodeURIComponent(r.part || "")}')">✎</button>
        </div>
        <div class="name">${name}</div>
        <div class="meta-line">
          <span class="meta-right">النظام: <b>${sq}</b></span>
          <span class="meta-left">الموقع: ${loc}</span>
        </div>
        <div class="meta-second">الجرد: <b>${cq}</b></div>
      </div>
    `;
  }
  el.innerHTML = h;
}

/* =========================
   Detail
========================= */
function openDetail(partEncoded){
  const part = decodeURIComponent(partEncoded || "");
  const it = ALL_DATA.find(r => String(r.part) === String(part));
  if(!it) return;

  const cq = Number(it.countedQty || 0);
  const lu = it.lastCountUser || "";
  const lt = it.lastCountTime ? ("آخر جرد: " + it.lastCountTime + (lu ? (" - " + lu) : "")) : "";

  const ov = document.createElement("div");
  ov.className = "detail-overlay";

  ov.innerHTML = `
    <div class="detail-card">
      <div class="detail-header">
        <span>تفاصيل</span>
        <button class="detail-close" onclick="this.closest('.detail-overlay').remove()">✕</button>
      </div>

      <div class="detail-body">
        <div class="detail-label">رقم الصنف</div>
        <div class="detail-value">${escHtml(it.part || "")}</div>

        <div class="detail-label">اسم الصنف</div>
        <div class="detail-value">${escHtml(it.name || "")}</div>

        <div class="detail-label">الموقع</div>
        <div class="detail-value">${escHtml(it.location || "-")}</div>

        <div class="detail-label">كمية النظام</div>
        <div class="detail-value">${escHtml(it.qty ?? "")}</div>

        <div class="detail-label">كمية الجرد</div>
        <div class="detail-qty-box">
          <button type="button" onclick="changeQty(-1)">−</button>
          <input id="detailQty" type="number" inputmode="numeric" value="${cq}">
          <button type="button" onclick="changeQty(1)">+</button>
        </div>

        <div class="detail-label">ملاحظات</div>
        <textarea id="detailNote" class="detail-note" placeholder="اكتب ملاحظة...">${escHtml(it.note || "")}</textarea>

        <div id="detailInfo" class="detail-info">${escHtml(lt)}</div>
      </div>

      <button id="btnSave" class="detail-save"
        onclick="saveQty('${encodeURIComponent(String(it.part || ""))}','${encodeURIComponent(String(it.name || ""))}',${Number(it.qty)||0})">
        حفظ
      </button>
    </div>
  `;

  document.body.appendChild(ov);
}

function changeQty(d){
  const inp = document.getElementById("detailQty");
  if(!inp) return;
  let v = Number(inp.value) || 0;
  v += d;
  if(v < 0) v = 0;
  inp.value = v;
}

/* =========================
   Save (بدون Alerts)
========================= */
async function saveQty(partEnc, nameEnc, systemQty){
  const btn = document.getElementById("btnSave");
  const qi  = document.getElementById("detailQty");
  const ni  = document.getElementById("detailNote");
  const info= document.getElementById("detailInfo");

  if(!qi) return;

  let v = Number(qi.value) || 0;
  if(v < 0) v = 0;

  const part = decodeURIComponent(partEnc || "");
  const name = decodeURIComponent(nameEnc || "");
  const note = (ni ? ni.value.trim() : "");

  // تعطيل زر الحفظ لمنع الضغط المتكرر
  if(btn){
    btn.disabled = true;
    btn.textContent = "جارٍ الحفظ...";
  }

  try{
    const body = new URLSearchParams({
      part: part,
      itemName: name,
      systemQty: String(systemQty || 0),
      countedQty: String(v),
      note: note
    }).toString();

    const r = await fetch(API, {
      method: "POST",
      headers: {"Content-Type":"application/x-www-form-urlencoded"},
      body
    });

    const res = await r.json();

    // بدون أي رسالة منبثقة
    if(res && res.ok){
      // تحديث صامت + اغلاق التفاصيل
      document.querySelector(".detail-overlay")?.remove();
      refreshData(true);
      return;
    }

    // في حال فشل، نعرض نص صغير داخل نفس النافذة (ليس Popup)
    if(info){
      info.textContent = "فشل الحفظ. تأكد من الاتصال.";
    }

  }catch(e){
    if(info){
      info.textContent = "خطأ اتصال أثناء الحفظ.";
    }
  }finally{
    if(btn){
      btn.disabled = false;
      btn.textContent = "حفظ";
    }
  }
}

/* =========================
   Clear
========================= */
function clearAll(){
  document.querySelectorAll(".filter-input").forEach(i => i.value = "");
  document.getElementById("results").innerHTML = "<div class='msg'>اكتب شيئًا للبحث</div>";
}
</script>
</body>
</html>
